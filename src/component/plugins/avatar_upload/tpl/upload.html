{% extends 'struct.html' %}

{% block css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<link rel="stylesheet" href="/src/component/plugins/avatar_upload/tpl/css/style.css?v=0.2.0">
{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row">

                <div class="card-body">
                    {% set userBalance = getUser().getBalance() %}
                    {% set isAdmin = (getUser() and getUser().isAdmin()) ? true : false %}
                    {% set uploadDisabled = not setting.isFree and userBalance < (setting.cost ?? 0) and not isAdmin %}

                    <div class="row g-4">

                        <div class="col-lg-5">
                      
                            <div class="card custom-card mb-3">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        {% if getUser().isAvatarVideo() %}
                                            <video src="{{ getUser().getAvatar() }}" class="img-fluid rounded" style="max-width: 200px;" autoplay loop muted playsinline></video>
                                        {% else %}
                                            <img src="{{ getUser().getAvatar() }}" alt="Current Avatar" class="img-fluid rounded" style="max-width: 180px;">
                                        {% endif %}
                                    </div>
                                    {% if not setting.isFree %}
                                    <div class="alert alert-info d-flex align-items-center">
                                        <i class="bi bi-info-circle me-3" style="font-size: 1.1rem;"></i>
                                        <div>
                                            {{ phrase('avatar_upload_cost_info') }}: <strong class="ms-2">{{ setting.cost ?? 1 }} Donate Coin</strong>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-success d-flex align-items-center">
                                        <i class="bi bi-check-circle me-3" style="font-size: 1.1rem;"></i>
                                        <div><strong>{{ phrase('avatar_upload_free_info') }}</strong></div>
                                    </div>
                                    {% endif %}

                                    <div class="text-start mt-3">
                                        <strong><i class="bi bi-exclamation-triangle me-2 text-muted"></i>{{ phrase('avatar_upload_requirements') }}:</strong>
                                        <ul class="mb-0 mt-2 text-muted">
                                            <li>{{ phrase('avatar_upload_formats') }}</li>
                                            <li>{{ phrase('avatar_upload_min_size_req') }}</li>
                                            <li>{{ phrase('avatar_upload_max_size_req') }}</li>
                                            <li>{{ phrase('avatar_upload_resize_info') }}</li>
                                            <li>{{ phrase('avatar_upload_video_formats') }}</li>
                                            <li>{{ phrase('avatar_upload_video_max_size_req') }}</li>
                                            <li>{{ phrase('avatar_upload_video_duration_hint') }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right column: upload area -->
                        <div class="col-lg-7">
                            <div class="card custom-card">
                                <div class="card-body">
                                    {% if uploadDisabled %}
                                    <div id="universalUploadArea" class="w-100 text-center py-5 disabled-upload" aria-disabled="true">
                                        <div class="mb-3"><i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i></div>
                                        <h5 class="mb-2">{{ phrase('avatar_upload_not_enough_funds')|default('Недостаточно средств') }}</h5>
                                        <p class="text-muted mb-1">{{ phrase('avatar_upload_current_balance')|default('На Вашем счёте') }}: <strong>{{ userBalance }}</strong></p>
                                        <p class="text-muted mb-0">{{ phrase('avatar_upload_required_cost')|default('Требуется') }}: <strong>{{ setting.cost }}</strong></p>
                                    </div>
                                    <input type="file" id="universalFileInput" accept="image/jpeg,image/png,image/webp,image/gif,video/mp4,video/webm,video/quicktime,video/x-matroska,video/x-msvideo" disabled style="display: none;">
                                    {% else %}
                                    <div id="universalUploadArea" class="w-100 text-center py-5 upload-area clickable">
                                        <div class="mb-3">
                                            <i class="bi bi-cloud-upload" style="font-size: 2.5rem;"></i>
                                        </div>
                                        <h5 class="mb-2">{{ phrase('avatar_upload_drag_drop') }}</h5>
                                        <p class="text-muted mb-3">{{ phrase('avatar_upload_select_photo') }}</p>
                                        <div class="d-flex justify-content-center gap-3 flex-wrap small text-muted">
                                            <span><i class="bi bi-image me-1"></i>JPG, PNG, WebP, GIF</span>
                                            <span><i class="bi bi-camera-reels me-1"></i>MP4, WebM, MOV, MKV, AVI</span>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="bi bi-keyboard me-1"></i>
                                                {{ phrase('avatar_upload_paste_hint')|default('Или нажмите Ctrl+V чтобы вставить изображение') }}
                                            </small>
                                        </div>
                                    </div>
                                    <input type="file" id="universalFileInput" accept="image/jpeg,image/png,image/webp,image/gif,video/mp4,video/webm,video/quicktime,video/x-matroska,video/x-msvideo" style="display: none;">
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для обрезки аватара -->
<div class="modal fade" id="cropAvatarModal" tabindex="-1" aria-labelledby="cropAvatarModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropAvatarModalLabel">
                    <i class="bi bi-crop me-2"></i>{{phrase('avatar_upload_crop_title')}}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Область обрезки -->
                        <div class="crop-container" id="cropContainer">
                            <img id="cropImage" src="" alt="Crop Image">
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <!-- Предварительный просмотр -->
                        <div class="text-center">
                            <h6 class="mb-3">{{phrase('avatar_upload_preview')}}</h6>
                            <div class="avatar-preview-box mx-auto">
                                <div class="preview"></div>
                            </div>
                            <div class="mt-3 text-muted small">
                                <i class="bi bi-info-circle me-1"></i>
                                {{phrase('avatar_upload_crop_hint')}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>{{phrase('avatar_upload_cancel')}}
                </button>
                <button type="button" class="btn btn-success" id="uploadAvatar">
                    <i class="bi bi-check-circle me-2"></i>{{phrase('avatar_upload_upload_button')}}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для обработки видео аватара -->
<div class="modal fade" id="videoCropModal" tabindex="-1" aria-labelledby="videoCropModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-fullscreen-lg-down" style="max-width: 1400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoCropModalLabel">
                    <i class="bi bi-camera-reels me-2"></i>{{ phrase('avatar_upload_video_modal_title') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <!-- Левая колонка: Видео с кроппером -->
                    <div class="col-lg-8">
                        <div class="video-crop-wrapper mb-3">
                            <div id="videoCropContainer" class="position-relative">
                                <canvas id="videoCropCanvas" style="max-width: 100%; display: block;"></canvas>
                            </div>
                        </div>
                        <video id="videoPreview" style="display: none;" muted playsinline></video>
                        
                        <!-- Временная шкала с выбором диапазона -->
                        <div class="timeline-container mb-3">
                            <label class="form-label fw-bold mb-2">
                                <i class="bi bi-clock me-2"></i>{{ phrase('avatar_upload_video_timeline') }}
                            </label>
                            <div class="timeline-wrapper position-relative">
                                <div class="custom-dual-slider" id="customDualSlider">
                                    <div class="slider-track">
                                        <div class="slider-track-inactive"></div>
                                        <div class="slider-track-active" id="sliderTrackActive"></div>
                                    </div>
                                    <div class="slider-handle slider-handle-start" id="sliderHandleStart" data-handle="start">
                                        <div class="slider-handle-inner"></div>
                                        <div class="slider-tooltip" id="tooltipStart">0.00s</div>
                                    </div>
                                    <div class="slider-handle slider-handle-end" id="sliderHandleEnd" data-handle="end">
                                        <div class="slider-handle-inner"></div>
                                        <div class="slider-tooltip" id="tooltipEnd">4.00s</div>
                                    </div>
                                </div>
                                <div class="timeline-labels d-flex justify-content-between mt-3 small text-muted">
                                    <span id="startTimeLabel">
                                        <i class="bi bi-play-circle me-1"></i>Начало: <strong>0.00s</strong>
                                    </span>
                                    <span id="durationLabel" class="text-primary fw-bold">
                                        <i class="bi bi-hourglass-split me-1"></i>4.00s
                                    </span>
                                    <span id="endTimeLabel">
                                        <i class="bi bi-stop-circle me-1"></i>Конец: <strong>0.00s</strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Правая колонка: Превью финального аватара -->
                    <div class="col-lg-4">
                        <div class="avatar-preview-card">
                            <h6 class="mb-3 fw-bold text-center">
                                <i class="bi bi-eye me-2"></i>{{ phrase('avatar_upload_preview') }}
                            </h6>
                            <div class="final-avatar-preview mx-auto mb-3">
                                <canvas id="avatarPreviewCanvas" class="avatar-preview-canvas"></canvas>
                                <video id="avatarPreviewVideo" style="display:none;" loop muted playsinline></video>
                            </div>
                            <div class="text-center mb-3">
                                <div class="badge bg-primary mb-2">250 × 250 px</div>
                                <p class="small text-muted mb-0">{{ phrase('avatar_upload_final_result') }}</p>
                            </div>
                            <hr>
                            <div class="crop-info small">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">{{ phrase('avatar_upload_crop_size') }}:</span>
                                    <strong id="cropSizeInfo">—</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">{{ phrase('avatar_upload_clip_duration') }}:</span>
                                    <strong id="clipDurationInfo">—</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">{{ phrase('avatar_upload_clip_range') }}:</span>
                                    <strong id="clipRangeInfo">—</strong>
                                </div>
                            </div>
                            <hr>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="uploadVideoAvatar">
                                    <i class="bi bi-check-circle me-2"></i>{{ phrase('avatar_upload_video_upload_button') }}
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-2"></i>{{ phrase('avatar_upload_cancel') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<canvas id="videoFrameCanvas" class="d-none"></canvas>

{% endblock %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    // Передаем переводы в JavaScript
    window.avatarUploadPhrases = {
        uploading: '{{phrase("avatar_upload_uploading")}}',
        pleaseSelect: '{{phrase("avatar_upload_please_select")}}',
        minCropSize: '{{phrase("avatar_upload_min_crop_size")}}',
        fileTooLarge: '{{phrase("avatar_upload_file_too_large")}}',
        fileReadError: '{{phrase("avatar_upload_file_read_error")}}'
    };
    window.avatarVideoPhrases = {
        select: '{{phrase("avatar_upload_video_select_prompt")}}',
        fileTooLarge: '{{phrase("avatar_upload_video_file_too_large")}}',
        invalid: '{{phrase("avatar_upload_video_invalid_file")}}',
        durationInvalid: '{{phrase("avatar_upload_video_duration_invalid")}}',
        cropInvalid: '{{phrase("avatar_upload_video_crop_invalid")}}',
        preparing: '{{phrase("avatar_upload_video_preparing")}}',
        uploading: '{{phrase("avatar_upload_uploading")}}',
        durationHint: '{{phrase("avatar_upload_video_duration_hint")}}'
    ,
        startLabel: '{{phrase("avatar_upload_start")}}',
        endLabel: '{{phrase("avatar_upload_end")}}'
    };
    window.avatarVideoConfig = {
        minDuration: 1,
        maxDuration: 6,
        minCrop: 100,
        maxCrop: 1024,
        maxFileSize: 10*1024*1024
    };
</script>
<script src="/src/component/plugins/avatar_upload/tpl/js/avatar_uploader.js?v=0.2.0"></script>
{% endblock %}
