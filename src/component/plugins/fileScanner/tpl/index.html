{% extends 'struct.html' %}

{% block title %}{{ phrase('system_update') }}{% endblock %}

{% block content %}
<style>
    .scan-loader {
        width: 100px;
        height: 100px;
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #3498db;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .scanning-text {
        text-align: center;
        color: #3498db;
        font-size: 1.2rem;
        margin-top: 15px;
    }

    .pulse-animation {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-xl-12">
            <div class="card custom-card">
                <div class="card-header justify-content-between">
                    <div class="card-title">
                        <a href="/admin" class="avatar border text-muted me-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                <path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM12 20C16.42 20 20 16.42 20 12C20 7.58 16.42 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20ZM12 11H16V13H12V16L8 12L12 8V11Z"></path>
                            </svg>
                        </a>
                        {{ phrase('system_update') }}
                    </div>
                </div>

                <div class="card-body" id="penala">
                    <!-- Блок для уведомлений -->
                    <div id="notifications"></div>

                    <div class="row mb-4">
                        <div class="col-xl-12">
                            <div class="alert alert-info" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="ri-information-line me-2 fs-16"></i>
                                    <div>{{ phrase('notification_info') }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Блок со статистикой -->
                    <div id="stats-block" class="row mb-4" style="display: none;">
                        <div class="col-xl-6">
                            <div class="card custom-card bg-primary-transparent">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="avatar avatar-lg bg-primary">
                                                <i class="ri-file-list-3-line fs-20"></i>
                                            </span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ phrase('total_files') }}</h6>
                                            <span class="text-muted" id="total-files">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-6">
                            <div class="card custom-card bg-success-transparent">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="avatar avatar-lg bg-success">
                                                <i class="ri-refresh-line fs-20"></i>
                                            </span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ phrase('update_required') }}</h6>
                                            <span class="text-muted" id="update-required">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка сканирования -->
                    <div class="row mb-4" id="scan-button-block">
                        <div class="col-xl-12 text-center">
                            <button id="startScan" class="btn btn-primary btn-lg pulse-animation">
                                <i class="ri-search-line me-2"></i>{{ phrase('start_scan') }}
                            </button>
                        </div>
                    </div>

                    <!-- Анимация сканирования -->
                    <div id="scanning-animation" style="display: none;">
                        <div class="scan-loader"></div>
                        <div class="scanning-text">{{ phrase('scanning_files') }}</div>
                        
                        <!-- Прогресс бар -->
                        <div class="container mt-4">
                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-center mb-3" id="scan-status-text">{{ phrase('preparing_scan') }}</h6>
                                            
                                            <div class="progress mb-3" style="height: 30px;">
                                                <div id="scan-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    0%
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between text-muted">
                                                <span>
                                                    <i class="ri-file-list-3-line me-1"></i>
                                                    {{ phrase('scanned') }}: <strong id="scan-processed">0</strong>
                                                </span>
                                                <span>
                                                    <i class="ri-folder-line me-1"></i>
                                                    {{ phrase('total_files') }}: <strong id="scan-total">0</strong>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Сообщение об отсутствии файлов для обновления -->
                    <div id="no-files-message" class="alert alert-success" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="ri-checkbox-circle-line me-2 fs-16"></i>
                            <div>{{ phrase('all_files_actual') }}</div>
                        </div>
                    </div>

                    <!-- Таблица файлов -->
                    <div class="row" id="files-table-block" style="display: none;">
                        <div class="col-xl-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll" checked>
                                    <label class="form-check-label" for="selectAll">
                                        {{ phrase('select_all_files') }}
                                    </label>
                                </div>
                                <button id="startUpdate" class="btn btn-success" disabled>
                                    <i class="ri-download-cloud-2-line me-2"></i>{{ phrase('start_update') }}
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>{{ phrase('file') }}</th>
                                        <th style="width: 120px;">{{ phrase('status') }}</th>
                                    </tr>
                                    </thead>
                                    <tbody id="filesList">
                                    <!-- Сюда будут добавляться файлы -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    $(document).ready(function() {
        const $startUpdate = $('#startUpdate');
        const $selectAll = $('#selectAll');
        const $filesList = $('#filesList');
        const $notifications = $('#notifications');
        
        // Translations
        const lang = {
            'preparing_scan': '{{ phrase("preparing_scan") }}',
            'counting_files': '{{ phrase("counting_files") }}',
            'scanning_files': '{{ phrase("scanning_files") }}',
            'preparing_data': '{{ phrase("preparing_data") }}',
            'sending_to_server': '{{ phrase("sending_to_server") }}',
            'scan_completed': '{{ phrase("scan_completed") }}',
            'scan_error': '{{ phrase("scan_error") }}',
            'requires_update': '{{ phrase("requires_update") }}',
            'missing': '{{ phrase("missing") }}',
            'updated': '{{ phrase("updated") }}',
            'error': '{{ phrase("error") }}',
            'update_completed': '{{ phrase("update_completed") }}',
            'update_error': '{{ phrase("update_error") }}',
            'no_files_selected': '{{ phrase("no_files_selected") }}',
            'scan_error_occurred': '{{ phrase("scan_error_occurred") }}',
            'unknown_error': '{{ phrase("unknown_error") }}',
            'result_not_found': '{{ phrase("result_not_found") }}',
            'scan_start_error': '{{ phrase("scan_start_error") }}'
        };

        function showNotification(message, type = 'success') {
            const alertClass = `alert-${type}`;
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            $notifications.html(alertHtml);
        }

        function updateStartButtonState() {
            const checkedFiles = $('.file-checkbox:checked').length;
            console.log('Checked files:', checkedFiles); // Для отладки
            $startUpdate.prop('disabled', checkedFiles === 0);
        }

        let progressInterval = null;
        let scanningStarted = false;
        let lastValidProgress = null;

        // Обработчик начала сканирования
        $('#startScan').click(function() {
            $('#scan-button-block').hide();
            $('#scanning-animation').fadeIn();
            $('#no-files-message').hide();
            $('#files-table-block').hide();
            $notifications.empty();
            
            // Сбрасываем последний валидный прогресс
            lastValidProgress = null;
            
            // Сбрасываем стили прогресс-бара
            $('#scan-progress-bar')
                .removeClass('bg-danger')
                .addClass('bg-primary progress-bar-animated')
                .css('width', '0%')
                .attr('aria-valuenow', 0)
                .text('0%');
            
            // Сбрасываем счетчики
            $('#scan-processed').text('0');
            $('#scan-total').text('0');
            $('#scan-status-text').text(lang.preparing_scan);

            setTimeout(() => {
                $('#stats-block').fadeIn();
            }, 500);

            startScanning();
        });

        // Обработчик выбора всех файлов
        $selectAll.on('change', function() {
            const isChecked = $(this).prop('checked');
            $('.file-checkbox').prop('checked', isChecked);
            updateStartButtonState();
        });

        function updateProgressUI(progress) {
            // Защита от undefined/null значений
            const percent = (progress && typeof progress.progress === 'number') ? progress.progress : 0;
            const processed = (progress && typeof progress.processed === 'number') ? progress.processed : 0;
            const total = (progress && typeof progress.total === 'number') ? progress.total : 0;
            const status = (progress && progress.status) ? progress.status : 'unknown';

            // Обновляем прогресс бар
            $('#scan-progress-bar')
                .css('width', percent + '%')
                .attr('aria-valuenow', percent)
                .text(percent.toFixed(1) + '%');

            // Обновляем счётчики
            $('#scan-processed').text(processed.toLocaleString());
            $('#scan-total').text(total.toLocaleString());

            // Обновляем текст статуса
            let statusText = '';
            switch(status) {
                case 'counting':
                    statusText = lang.counting_files;
                    break;
                case 'scanning':
                    statusText = lang.scanning_files;
                    break;
                case 'preparing':
                    statusText = lang.preparing_data;
                    break;
                case 'sending':
                    statusText = lang.sending_to_server;
                    break;
                case 'completed':
                    statusText = lang.scan_completed;
                    $('#scan-progress-bar').removeClass('progress-bar-animated');
                    break;
                case 'error':
                    statusText = lang.scan_error;
                    $('#scan-progress-bar')
                        .removeClass('bg-primary progress-bar-animated')
                        .addClass('bg-danger');
                    break;
                default:
                    statusText = lang.scanning_files;
            }
            $('#scan-status-text').text(statusText);
        }

        function checkProgress() {
            $.ajax({
                url: '/admin/filescanner/progress',
                method: 'GET',
                dataType: 'json',
                success: function(progress) {
                    // Проверяем валидность данных прогресса
                    // Игнорируем если получили нулевые значения, а до этого были нормальные
                    if (lastValidProgress !== null && 
                        progress.processed === 0 && 
                        progress.total === 0 && 
                        progress.status !== 'completed' && 
                        progress.status !== 'error' &&
                        progress.status !== 'counting') {
                        // Пропускаем это обновление, используем предыдущие валидные данные
                        return;
                    }
                    
                    if (progress.status === 'completed') {
                        // Сканирование завершено
                        clearInterval(progressInterval);
                        lastValidProgress = progress;
                        updateProgressUI(progress);
                        
                        setTimeout(() => {
                            $('#scanning-animation').fadeOut(() => {
                                if (progress.result) {
                                    displayFiles(progress.result);
                                    setTimeout(updateStartButtonState, 500);
                                } else {
                                    showNotification(lang.result_not_found, 'warning');
                                    $('#scan-button-block').show();
                                }
                            });
                        }, 1000);
                    } else if (progress.status === 'error') {
                        // Ошибка сканирования
                        clearInterval(progressInterval);
                        lastValidProgress = progress;
                        updateProgressUI(progress);
                        
                        setTimeout(() => {
                            showNotification(lang.scan_error_occurred + ': ' + (progress.error || lang.unknown_error), 'danger');
                            $('#scanning-animation').fadeOut(() => {
                                $('#scan-button-block').show();
                            });
                        }, 1000);
                    } else {
                        // Обновляем прогресс только если данные валидны
                        if (progress.status && (progress.total > 0 || progress.status === 'counting')) {
                            lastValidProgress = progress;
                            updateProgressUI(progress);
                        } else if (lastValidProgress !== null) {
                            // Используем последние валидные данные
                            updateProgressUI(lastValidProgress);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка получения прогресса:', error);
                }
            });
        }

        function startScanning() {
            scanningStarted = false;
            
            // Запускаем сканирование
            $.ajax({
                url: '/admin/filescanner/scan',
                method: 'POST',
                dataType: 'json',
                timeout: 0, // Убираем таймаут, так как теперь отслеживаем прогресс
                success: function(response) {
                    // Этот обработчик может и не вызваться, если мы получим результат через прогресс
                    if (!scanningStarted) {
                        return; // Игнорируем, если уже обработали через прогресс
                    }
                },
                error: function(xhr, status, error) {
                    if (scanningStarted) {
                        return; // Игнорируем, если уже начали отслеживать прогресс
                    }
                    
                    clearInterval(progressInterval);
                    showNotification(lang.scan_start_error + ': ' + error, 'danger');
                    $('#scanning-animation').hide();
                    $('#scan-button-block').show();
                }
            });

            // Начинаем проверять прогресс каждую секунду
            setTimeout(() => {
                scanningStarted = true;
                progressInterval = setInterval(checkProgress, 1000);
            }, 500);
        }

        function displayFiles(response) {
            $filesList.empty();
            const totalFiles = response.user_files_len;
            const changedFiles = response.changed_files;
            const missingFiles = response.missing_files;
            const changedFilesLen = changedFiles.length;
            const missingFilesLen = missingFiles.length;
            const totalUpdatesRequired = changedFilesLen + missingFilesLen;

            $('#total-files').text(totalFiles);
            $('#update-required').text(totalUpdatesRequired);

            if (totalUpdatesRequired === 0) {
                $('#no-files-message').fadeIn();
                $('#files-table-block').hide();
                $startUpdate.prop('disabled', true);
                return;
            }

            // Отображаем измененные файлы
            changedFiles.forEach(function(file, index) {
                setTimeout(() => {
                    const row = $(`
                <tr style="opacity: 0">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input file-checkbox"
                               data-file="${file.path}" checked>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="ri-file-code-line me-2 text-warning"></i>
                            ${file.path}
                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning-transparent">
                                            ${lang.requires_update}
                                        </span>
                                    </td>
                                </tr>
            `).appendTo($filesList);

                    row.animate({ opacity: 1 }, 300);
                }, index * 100);
            });

            // Отображаем отсутствующие файлы
            missingFiles.forEach(function(file, index) {
                setTimeout(() => {
                    const row = $(`
                <tr style="opacity: 0">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input file-checkbox"
                               data-file="${file.path}" checked>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="ri-file-warning-line me-2 text-danger"></i>
                            ${file.path}
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-danger-transparent">
                            ${lang.missing}
                        </span>
                    </td>
                </tr>
            `).appendTo($filesList);

                    row.animate({ opacity: 1 }, 300);
                }, (changedFiles.length + index) * 100);
            });

            $('#files-table-block').fadeIn();
            setTimeout(updateStartButtonState, (changedFiles.length + missingFiles.length) * 100 + 300);
        }
        // Обработчик изменения состояния чекбоксов файлов
        $(document).on('change', '.file-checkbox', function() {
            updateStartButtonState();

            // Обновляем состояние selectAll
            const allChecked = $('.file-checkbox:checked').length === $('.file-checkbox').length;
            $selectAll.prop('checked', allChecked);
        });


        // Обработчик начала обновления
        $startUpdate.click(function() {
            const selectedFiles = [];
            $('.file-checkbox:checked').each(function() {
                selectedFiles.push($(this).closest('tr').find('td:eq(1)').text().trim());
            });

            if (selectedFiles.length === 0) {
                showNotification(lang.no_files_selected, 'warning');
                return;
            }

            $startUpdate.prop('disabled', true);

            $.ajax({
                url: '/admin/filescanner/update',
                method: 'POST',
                data: { files: selectedFiles },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        response.results.forEach(function(result) {
                            const row = $(`td:contains("${result.file}")`).closest('tr');
                            const statusCell = row.find('td:last');

                            if (result.status) {
                                statusCell.html(`
                                    <span class="badge bg-success-transparent">
                                        ${lang.updated}
                                    </span>
                                `);
                            } else {
                                const errorMessage = result.message +
                                    (result.debug ? `<br><small class="text-muted">URL: ${result.debug.api_url}</small>` : '');

                                statusCell.html(`
                                    <span class="badge bg-danger-transparent">
                                        ${lang.error}: ${errorMessage}
                                    </span>
                                `);
                            }
                        });

                        showNotification(lang.update_completed);
                    } else {
                        const errorMessage = response.error || lang.update_error;
                        showNotification(errorMessage +
                            (response.trace ? '<br><small class="text-muted">Подробности в консоли браузера</small>' : ''),
                            'danger'
                        );
                        if (response.trace) {
                            console.log('Error trace:', response.trace);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    showNotification(lang.update_error + ': ' + error, 'danger');
                },
                complete: function() {
                    updateStartButtonState();
                }
            });
        });
    });
</script>
{% endblock %}