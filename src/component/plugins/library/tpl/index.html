{% extends 'struct.html' %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-xl-3 col-lg-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Поиск</h5>
                    <form class="d-flex mb-3" action="{{ path('library_search')|default('#') }}" method="get">
                        <input class="form-control me-2" type="search" name="q" placeholder="Искать статьи..."
                            value="{{ query|default('') }}">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                    </form>

                    <h6 class="mt-2">Категории</h6>
                    <ul class="list-group list-group-flush mb-3">
                        {# Сгруппированные предметы: Оружие, Броня, Бижутерия, Рецепты, Другие #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>Предметы</strong>
                                    <div class="small mt-1">
                                        <a href="/library/items/weapons" class="me-1">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/weapon_arcana_mace_i01.webp">Оружие</a>
                                        <a href="/library/items/armors" class="me-1">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/armor_t89_ul_i00.webp">Броня</a>
                                        <a href="/library/items/jewelry" class="me-1">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/accessory_earring_of_zaken_i00.webp">Бижутерия</a>
                                        <a href="/library/items/recipes" class="me-1">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/etc_recipe_black_i00.webp">
                                            Рецепты</a>
                                        <a href="/library/items/etcitems" class="me-2">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/etc_spell_shot_gold_i01.webp">Другие
                                            предметы</a>
                                        <a href="/library/category/armorsets" class="me-2">
                                            <img width="16px" class="rounded"
                                                src="/uploads/images/icon/armor_t1004_ul_i00.webp">
                                            Комплексы брони</a>

                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел NPC с подкатегориями: Монсты, Рейд Боссы и типы #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>NPC</strong>
                                    <div class="small mt-1">
                                        <a href="/library/npcs/monsters" class="me-2">Монсты</a>
                                        <a href="/library/npcs/raidboses" class="me-2">Рейд Боссы</a>
                                        {# Список типов NPC (генерируется вручную - может быть длинным) #}
                                        <div class="mt-2 npc-types-list" style="max-height:220px;overflow:auto;">
                                            {% set npc_types = [
                                            'Folk','Monster','Pet','Warehouse','Teleporter','BabyPet','ControlTower','FlameTower','EffectPoint','Chest','Decoy',
                                            'Merchant','Servitor','TamedBeast','FestivalMonster','UCTower','Block','TerrainObject','QuestGuard','FeedableBeast','RiftInvader',
                                            'RaidBoss','GrandBoss','L2Monster','Trainer','VillageMasterFighter','VillageMasterPriest','Guard','VillageMasterMystic','VillageMasterDElf','VillageMasterDwarf','VillageMasterOrc',
                                            'CastleDoorman','PetManager','Auctioneer','ClanHallDoorman','RaceManager','BroadcastingTower','DawnPriest','DuskPriest','SignsPriest','DungeonGatekeeper','FestivalGuide','Fisherman','Doorman','OlympiadManager','Adventurer','ClassMaster','FriendlyMob','FlyTerrainObject','VillageMasterKamael','UCManager','UCHelper','KrateisCubeManager','KrateisMatchManager','Defender','Artefact','ClanHallManager','FortManager','FortLogistics','FortDoorman','FortCommander','TerritoryWard'
                                            ] %}
                                            {% for t in npc_types %}
                                            <a href="/library/npcs/type/{{ t }}"
                                                class="badge bg-light text-dark border me-1 mb-1">{{ t }}</a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел Квесты с подкатегориями: Начальные, Профессии, Повторяемые, Классовые #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>Квесты</strong>
                                    <div class="small mt-1">
                                        <a href="/library/category/quests/starting" class="me-2">Начальные</a>
                                        <a href="/library/category/quests/professions" class="me-2">Профессии</a>
                                        <a href="/library/category/quests/repeatable" class="me-2">Повторяемые</a>
                                        <a href="/library/category/quests/class" class="me-2">Классовые</a>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел Классы и Расы: Человек, Эльф, Темный Эльф, Орк, Гном, Камаэль #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>Классы и Расы</strong>
                                    <div class="small mt-1">
                                        <a href="/library/category/races/human" class="me-2">Человек</a>
                                        <a href="/library/category/races/elf" class="me-2">Эльф</a>
                                        <a href="/library/category/races/dark-elf" class="me-2">Темный Эльф</a>
                                        <a href="/library/category/races/orc" class="me-2">Орк</a>
                                        <a href="/library/category/races/dwarf" class="me-2">Гном</a>
                                        <a href="/library/category/races/kamael">Камаэль</a>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел Добыча: Дроп и Спойл #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>Добыча</strong>
                                    <div class="small mt-1">
                                        <a href="/library/category/loot/drop" class="me-2">Дроп</a>
                                        <a href="/library/category/loot/spoil" class="me-2">Спойл</a>
                                        <a href="/library/category/loot/craft">Крафт</a>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел Калькулятор: подсчет ресурсов на крафт #}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>Калькуляция</strong>
                                    <div class="small mt-1">
                                        <a href="/library/calculator">Подсчет ресурсов на крафт</a>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Динамические категории из контекста (если есть) #}
                        {% for cat in categories %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ cat.url }}">{{ cat.title }}</a>
                            <span class="badge bg-secondary rounded-pill">{{ cat.count }}</span>
                        </li>
                        {% endfor %}
                    </ul>

                </div>
            </div>
        </div>

        <div class="col-xl-9 col-lg-8">
            {% if featured %}
            <div class="card mb-3">
                {% if featured.image is defined and featured.image %}
                <img src="{{ featured.image }}" class="card-img-top" alt="{{ featured.title }}">
                {% endif %}
                <div class="card-body">
                    <h3 class="card-title"><a href="{{ featured.url }}" class="text-decoration-none">{{ featured.title
                            }}</a></h3>
                    <p class="text-muted mb-1">{{ featured.category }} — {{ featured.date }} — {{ featured.author }}</p>
                    <p class="card-text">{{ featured.excerpt }}</p>
                </div>
            </div>
            {% endif %}

            <div class="row row-cols-1 row-cols-md-2 g-3">
                {% for article in articles %}
                <div class="col">
                    <div class="card h-100">
                        {% if article.image is defined and article.image %}
                        <img src="{{ article.image }}" class="card-img-top" alt="{{ article.title }}">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title"><a href="{{ article.url }}"
                                    class="stretched-link text-decoration-none">{{ article.title }}</a></h5>
                            <p class="text-muted small mb-2">{{ article.category }} — {{ article.date }} — {{
                                article.author }}</p>
                            <p class="card-text mb-2">{{ article.excerpt }}</p>
                            <div class="mt-auto">
                                {% for t in article.tags %}
                                <a href="{{ t.url }}" class="badge bg-light text-dark me-1">#{{ t.name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info">Статей пока нет. Добавьте первую.</div>
                </div>
                {% endfor %}
            </div>

            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if prev_page %}
                    <li class="page-item"><a class="page-link" href="{{ prev_page }}">« Назад</a></li>
                    {% endif %}
                    {% if next_page %}
                    <li class="page-item"><a class="page-link" href="{{ next_page }}">Вперёд »</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>

{# Ожидаемый контекст:
categories, recent, tags, featured, articles, prev_page, next_page
#}

{% endblock %}