{% extends 'struct.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-3">
            <h2 class="mb-2">NPC</h2>
            <div class="mb-2">
                <a href="/library" class="btn btn-sm btn-outline-secondary">← Назад в библиотеку</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card custom-card">
                <div class="card-body">
                    <div class="table-responsive position-relative">
                        <div id="npc-loading" class="preloader-overlay" style="display:none;">
                            <div class="preloader-content text-center">
                                <div class="preloader-spinner mx-auto mb-2">
                                    <div class="spinner-ring"></div>
                                    <div class="spinner-ring"></div>
                                    <div class="spinner-ring"></div>
                                    <div class="spinner-ring"></div>
                                </div>
                                <div class="preloader-text">
                                    <h5>Загрузка списка NPC</h5>
                                    <p class="text-muted">Подготовка данных...</p>
                                </div>
                            </div>
                        </div>

                        <table id="npc-table" class="table table-bordered table-striped table-sm align-middle w-100"
                            style="visibility:hidden;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Уровень</th>
                                    <th>Тип</th>
                                    <th>Раса</th>
                                    <th>HP</th>
                                    <th>MP</th>
                                    <th>P.Atk</th>
                                    <th>M.Atk</th>
                                    <th>P.Def</th>
                                    <th>M.Def</th>
                                    <th>Atk Spd</th>
                                    <th>Crit</th>
                                    <th>Acc</th>
                                    <th>Evasion</th>
                                    <th>Skills</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="preload" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
</noscript>

<style>
    .table:not(.dataTable) tbody tr {
        display: none;
    }

    .table:not(.dataTable) tbody tr:nth-child(-n+30) {
        display: table-row;
    }

    .dt-initialized {
        visibility: visible !important;
        opacity: 0;
        animation: fadeIn .5s ease-in-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .preloader-overlay {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-40%, 10%) !important;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(2px);
        border-radius: 8px;
        z-index: 2000;
        width: min(100%, 50%);
    }

    .preloader-spinner {
        position: relative;
        width: 70px;
        height: 70px;
    }

    .spinner-ring {
        position: absolute;
        inset: 0;
        border: 3px solid transparent;
        border-radius: 50%;
        animation: spin 2s linear infinite;
    }

    .spinner-ring:nth-child(1) {
        border-top-color: #007bff;
    }

    .spinner-ring:nth-child(2) {
        border-right-color: #28a745;
        animation-delay: -.5s;
        transform: scale(.8);
    }

    .spinner-ring:nth-child(3) {
        border-bottom-color: #ffc107;
        animation-delay: -1s;
        transform: scale(.6);
    }

    .spinner-ring:nth-child(4) {
        border-left-color: #dc3545;
        animation-delay: -1.5s;
        transform: scale(.4);
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .preloader-hide {
        opacity: 0;
        transform: scale(.9);
        pointer-events: none;
        transition: .3s;
    }

    #npc-table th {
        white-space: nowrap;
    }

    #npc-table td {
        vertical-align: middle;
    }

    #npc-table td:nth-child(2) {
        min-width: 200px;
    }

    #npc-table td:last-child {
        min-width: 160px;
    }

    .badge img {
        vertical-align: middle;
        margin-right: 2px;
    }
</style>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (!window.jQuery) { console.warn('jQuery не найден для DataTables'); return; }
        const $table = $('#npc-table');
        const $loader = $('#npc-loading');
        $loader.show();
        setTimeout(() => {
            try {
                const dt = $table.DataTable({
                    paging: true,
                    pageLength: 50,
                    lengthMenu: [[10, 30, 50, 100, -1], [10, 30, 50, 100, 'Все']],
                    ordering: true,
                    order: [[2, 'asc']],
                    info: true,
                    searching: true,
                    deferRender: true,
                    processing: true,
                    serverSide: true,
                    ajax: '{{ npc_data_url|default("/library/npcs/data") }}',
                    stateSave: true,
                    stateDuration: 300,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                    language: { processing: 'Обработка...', search: '', searchPlaceholder: 'Поиск...', lengthMenu: 'Показать _MENU_', info: '_START_—_END_ из _TOTAL_', infoEmpty: 'Нет записей', infoFiltered: '(из _MAX_)', zeroRecords: 'Ничего не найдено', emptyTable: 'Нет данных', paginate: { previous: '‹ Пред', next: 'След ›' } },
                    autoWidth: false,
                    columnDefs: [
                        { targets: [0, 2, 3, 4], className: 'text-center align-middle', width: '1px' },
                        { targets: [5, 6, 7, 8, 9, 10, 11, 12, 13, 14], className: 'text-end align-middle', width: '1px' },
                        { targets: 15, className: 'align-middle' }
                    ],
                    initComplete: function () {
                        $loader.addClass('preloader-hide');
                        setTimeout(() => { $loader.addClass('d-none'); $table.addClass('dt-initialized'); }, 300);
                    }
                });
                let to; const $input = $table.closest('.dataTables_wrapper').find('.dataTables_filter input');
                $input.off('keyup search').on('keyup search', function () { clearTimeout(to); const v = this.value; to = setTimeout(() => { dt.search(v).draw(); }, 300); });
            } catch (e) { console.error('NPC DataTable init error', e); $loader.addClass('preloader-hide'); }
        }, 30);
    });
</script>
{% endblock %}