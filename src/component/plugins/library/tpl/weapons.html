{% extends 'struct.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-3">
            <div class="library-subnav mb-3">
                <div class="subnav-header d-flex align-items-center gap-3 flex-wrap mb-2">
                    <a href="/library" class="back-link d-inline-flex align-items-center gap-2">
                        <span class="chevron" aria-hidden="true">←</span>
                        <span class="label">Библиотека</span>
                    </a>
                    <h1 class="h4 m-0 fw-semibold page-title">Оружие — {{
                        weaponTypeLabels[currentWeaponType]|default(currentWeaponType) }}</h1>
                </div>
                <nav class="library-filter" aria-label="Типы оружия">
                    <ul class="nav flex-nowrap flex-md-wrap gap-2 mb-0" role="list">
                        {% for wt in weaponTypes %}
                        {% set isActive = (wt == currentWeaponType) %}
                        <li class="nav-item" role="presentation">
                            <a class="library-subpill {% if isActive %}active{% endif %}"
                                href="/library/items/weapons/{{ wt|lower }}" {% if isActive %}aria-current="page" {%
                                endif %}>
                                <span class="pill-label">{{ weaponTypeLabels[wt]|default(wt) }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>

            <script>(function () { try { const active = document.currentScript.parentElement.querySelector('.library-filter .active'); if (active) { active.scrollIntoView({ block: 'nearest', inline: 'center' }); } } catch (e) { } })();</script>
            <!-- removed global select sorter: sorting is now available by clicking table headers -->
        </div>
    </div>

    {% if weaponsByCrystal is empty %}
    <div class="alert alert-warning">Нет данных для выбранного типа.</div>
    {% else %}
    {% for crystal, list in weaponsByCrystal %}
    <div class="card mb-4">
        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
            <div>
                <h5 class="mb-1">{{ weaponGradeInfo[crystal].title|default('Грейд ' ~ crystal) }} ({{ crystal }})</h5>
                {% if weaponGradeInfo[crystal] is defined %}
                <div class="small text-muted">
                    Уровень: {{ weaponGradeInfo[crystal].level }} — {{ weaponGradeInfo[crystal].desc }}
                </div>
                {% endif %}
            </div>
            <span class="badge bg-primary align-self-start align-self-md-center mt-2 mt-md-0">{{ list|length }}</span>
        </div>
        <div class="table-responsive">
            <table class="table table-sm mb-0 align-middle weapon-table">
                <thead class="table-light">
                    <tr>
                        <th>Предмет</th>
                        <th class="text-center js-sortable" data-key="patk" title="Сортировать по pAtk">pAtk</th>
                        <th class="text-center js-sortable" data-key="matk" title="Сортировать по mAtk">mAtk</th>
                        <th class="text-center">Crit%</th>
                        <th class="text-center">Atk Spd</th>
                        <th class="text-end js-sortable" data-key="price" title="Сортировать по цене"
                            style="min-width:110px">Цена</th>
                    </tr>
                </thead>
                <tbody>
                    {% for w in list %}

                    <tr data-order="{{ loop.index0 }}" data-patk="{{ w.pAtk|default(0) }}"
                        data-matk="{{ w.mAtk|default(0) }}" data-price="{{ w.price|default(w._price|default(0)) }}"
                        data-is-magic="{{ w.is_magic_weapon|default(0) }}">
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                {% if w.icon %}
                                <img src="{{ get_icon(w.icon) }}" alt="" width="42" height="42" class="rounded"
                                    loading="lazy" onerror="this.style.display='none'">
                                {% endif %}
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">{{ w.name }}</span>
                                    <span class="text-muted extra-line small">
                                        <a href="/library/category/loot/craft">Крафт</a> / <a
                                            href="/library/category/loot/drop">Дроп</a>
                                    </span>
                                    {% if w.skills is not empty %}
                                    <span
                                        class="text-muted extra-line small d-flex flex-wrap gap-1 align-items-start mt-1 skill-effects-line">
                                        {% for skill in w.skills %}
                                        <span class="skill-wrap has-pop">
                                            {% if skill.icon %}
                                            <img src="{{ get_skill(skill.icon) }}" alt="" width="18" height="18"
                                                class="skill-icon rounded-1">
                                            {% else %}
                                            <span class="skill-icon-placeholder"
                                                style="display:inline-block;width:18px;height:18px;background:rgba(0,0,0,0.08);"></span>
                                            {% endif %}
                                            <span class="skill-pop skill-pop-wide">
                                                <span class="d-block fw-semibold mb-1">{{ skill.name|default('Skill ' ~
                                                    skill.id) }}<span class="opacity-75"> Lv.{{ skill.level
                                                        }}</span></span>
                                                {% if skill.effect_text is defined and skill.effect_text %}
                                                <span class="d-block effect-text">{{ skill.effect_text }}</span>
                                                {% elseif skill.effects is defined and skill.effects %}
                                                <span class="d-block">
                                                    {% for eff in skill.effects %}
                                                    <span class="d-block">{{ eff.formatted }} {{ eff.label }}</span>
                                                    {% endfor %}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">Нет данных о бонусах</span>
                                                {% endif %}
                                            </span>
                                        </span>
                                        {% endfor %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        {% set patk = w.pAtk %}
                        {% set matk = w.mAtk %}
                        {% set crit = w.critRate %}
                        {% set spd = w.pAtkSpd %}
                        <td class="text-center">{% if patk %}{{ patk }}{% if w.pAtk_enchant %}<span
                                class="text-success small">+{{ w.pAtk_enchant }}</span>{% endif %}{% else %}<span
                                class="text-muted">-</span>{% endif %}</td>
                        <td class="text-center">{% if matk %}{{ matk }}{% if w.mAtk_enchant %}<span
                                class="text-success small">+{{ w.mAtk_enchant }}</span>{% endif %}{% else %}<span
                                class="text-muted">-</span>{% endif %}</td>
                        <td class="text-center">{% if crit %}{{ crit }}{% else %}<span class="text-muted">-</span>{%
                            endif %}</td>
                        <td class="text-center">{% if spd %}{{ spd }}{% else %}<span class="text-muted">-</span>{% endif
                            %}</td>
                        <td class="text-end fw-semibold">{{ w.price_formatted|default(w.price|default('-')) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <style>
            .weapon-table tbody tr:hover {
                background: rgba(255, 255, 255, 0.04);
            }

            /* subtle hover */
            [data-theme-mode=light] .weapon-table tbody tr:hover {
                background: rgba(0, 0, 0, 0.035);
            }

            .weapon-table td,
            .weapon-table th {
                vertical-align: middle;
            }

            .weapon-table .extra-line {
                line-height: 1.0;
            }

            /* Skill hover label (CSS-only lightweight alternative to tooltips) */
            .skill-wrap {
                position: relative;
                display: inline-block;
            }

            .skill-wrap .skill-icon {
                border-radius: 2px;
            }

            /* allow popups to escape clipping */
            .card .table-responsive {
                overflow: visible;
            }

            .skill-pop {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                bottom: calc(100% + 8px);
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                padding: 6px 8px;
                border-radius: 8px;
                white-space: normal;
                font-size: 11px;
                line-height: 1.25;
                pointer-events: none;
                opacity: 0;
                transition: opacity .12s ease, transform .12s ease;
                transform-origin: bottom center;
                z-index: 99999;
                min-width: 180px;
                max-width: 260px;
            }

            .skill-pop-wide .effect-text {
                font-size: 11px;
            }

            .skill-effects-line .skill-wrap {
                margin-bottom: 2px;
            }

            .skill-wrap.has-pop:hover .skill-pop {
                opacity: 1;
                transform: translateX(-50%) translateY(-4px);
            }

            .skill-wrap:hover .skill-pop {
                opacity: 1;
                transform: translateX(-50%) translateY(-4px);
            }

            .skill-pop::after {
                content: '';
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                top: 100%;
                width: 8px;
                height: 8px;
                background: rgba(0, 0, 0, 0.8);
                transform-origin: top center;
                transform: translateX(-50%) rotate(45deg);
                border-radius: 2px;
            }
        </style>
    </div>
    {% endfor %}
    {% endif %}

    <script>
        (function () {
            function toNum(v) {
                const n = parseFloat(String(v).replace(/[^0-9\-\.]/g, ''));
                return Number.isFinite(n) ? n : 0;
            }

            function sortBy(table, key, dir) {
                const tbody = table.tBodies[0];
                if (!tbody) return;
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    let va, vb;
                    if (key === 'patk') {
                        // if weapon is magic, sort by mAtk instead of pAtk
                        va = a.dataset.isMagic && String(a.dataset.isMagic) !== '0' ? toNum(a.dataset.matk) : toNum(a.dataset.patk);
                        vb = b.dataset.isMagic && String(b.dataset.isMagic) !== '0' ? toNum(b.dataset.matk) : toNum(b.dataset.patk);
                    } else {
                        va = toNum(a.dataset[key]);
                        vb = toNum(b.dataset[key]);
                    }
                    return dir === 'asc' ? va - vb : vb - va;
                });
                rows.forEach(r => tbody.appendChild(r));
            }

            function restoreDefault(table) {
                const tbody = table.tBodies[0];
                if (!tbody) return;
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => toNum(a.dataset.order) - toNum(b.dataset.order));
                rows.forEach(r => tbody.appendChild(r));
            }

            function clearHeaderStates(headers) {
                headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            }

            const sortableHeaders = document.querySelectorAll('.js-sortable');
            if (!sortableHeaders.length) return;

            sortableHeaders.forEach(h => {
                h.style.cursor = 'pointer';
                h.addEventListener('click', function () {
                    const key = this.dataset.key;
                    const currentAsc = this.classList.contains('sort-asc');
                    const newDir = currentAsc ? 'desc' : 'asc';

                    // sort all visible tables for this grade block
                    // find nearest card and sort its table only
                    const card = this.closest('.card');
                    if (!card) return;
                    const table = card.querySelector('.weapon-table');
                    if (!table) return;

                    // reset other headers inside this table header
                    const headersInCard = card.querySelectorAll('.js-sortable');
                    clearHeaderStates(headersInCard);
                    this.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');

                    if (!key) {
                        restoreDefault(table);
                    } else {
                        sortBy(table, key, newDir);
                    }
                });
            });
        })();
    </script>

    <div class="mt-3">
        {% if db_timing is defined %}
        <div class="small text-muted">DB open: {{ db_timing.db_open_s }} s; Read: {{ db_timing.read_s }} s; Total:
            {{ db_timing.total_s }} s</div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="/src/component/plugins/library/tpl/css/_library_subnav.css">
{% endblock %}