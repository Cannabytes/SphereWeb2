{% extends 'struct.html' %}

{% block content %}
<div class="container-fluid">
    <div class="card custom-card shadow-lg rounded">
        <div class="card-header justify-content-between">
            <div class="card-title">
                <a href="/admin/extensions/paid" class="avatar border text-muted me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM12 20C16.42 20 20 16.42 20 12C20 7.58 16.42 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20ZM12 11H16V13H12V16L8 12L12 8V11Z"></path>
                    </svg>
                </a>
                {{ phrase('registration_reward') }}
            </div>
            <div class="prism-toggle">
                <div class="custom-toggle-switch d-flex align-items-center">
                    <input class="pluginActivating" id="enablePlugin" name="{{ pluginName }}" type="checkbox" {% if pluginActive %}checked{% endif %}>
                    <label for="enablePlugin" class="label-success"></label>
                    <span class="ms-3">{{phrase('Activating the plugin')}}</span>
                </div>
            </div>
        </div>

        <div class="card-body">
            {% if pluginActive == false %}
            <div class="alert alert-danger" role="alert">
                {{phrase('plugin_is_disabled_need_active')|raw}}
            </div>
            {% endif %}

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3 border-bottom" id="serverTabs" role="tablist">
                {% for server in servers %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" 
                            id="server-tab-{{ server.getId() }}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#server-content-{{ server.getId() }}" 
                            type="button" 
                            role="tab"
                            data-server-id="{{ server.getId() }}">
                        <i class="bi bi-server me-2"></i>{{ server.getName() }}
                    </button>
                </li>
                {% endfor %}
                <li class="nav-item ms-auto" role="presentation">
                    <button class="nav-link" 
                            id="manual-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#manual-content" 
                            type="button" 
                            role="tab">
                        <i class="bi bi-book me-2"></i>{{ phrase('manual') }}
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="serverTabsContent">
                {% for server in servers %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="server-content-{{ server.getId() }}" 
                     role="tabpanel"
                     data-server-id="{{ server.getId() }}">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    {{ phrase('items_count') }} <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       class="form-control items-count-input" 
                                       min="1" 
                                       max="100" 
                                       value="{% if serverSettings[server.getId()].itemsCount %}{{ serverSettings[server.getId()].itemsCount }}{% else %}1{% endif %}"
                                       {% if pluginActive == false %}disabled{% endif %}>
                                <small class="form-text text-muted">
                                    {{ phrase('Кол-во предметов которые выдаст пользователю при регистрации') }}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check pt-4">
                                    <input type="checkbox" 
                                           class="form-check-input allow-duplicates-input" 
                                           id="allowDuplicates-{{ server.getId() }}"
                                           {% if serverSettings[server.getId()].allowDuplicates %}checked{% endif %}
                                           {% if pluginActive == false %}disabled{% endif %}>
                                    <label class="form-check-label" for="allowDuplicates-{{ server.getId() }}">
                                        {{ phrase('allow_duplicates') }}
                                    </label>
                                </div>
                                <div class="form-check pt-2">
                                    <input type="checkbox" 
                                           class="form-check-input allow-clear-rewards-input" 
                                           id="allowClearRewards-{{ server.getId() }}"
                                           {% if serverSettings[server.getId()].allowClearRewards %}checked{% endif %}
                                           {% if pluginActive == false %}disabled{% endif %}>
                                    <label class="form-check-label" for="allowClearRewards-{{ server.getId() }}">
                                        {{ phrase('allow_clear_rewards') }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="mb-3 p-3 border rounded">
                        <h6 class="fw-semibold mb-3">{{ phrase('registration_reward_items') }}</h6>

                        <div class="table-responsive mb-3">
                            <table class="table table-bordered align-middle mb-0 items-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%">#</th>
                                        <th style="width: 15%">{{ phrase('item_id') }}</th>
                                        <th style="width: 15%">{{ phrase('min_count') }}</th>
                                        <th style="width: 15%">{{ phrase('max_count') }}</th>
                                        <th style="width: 10%">{{ phrase('enchant') }}</th>
                                        <th style="width: 15%">{{ phrase('chance') }} (%)</th>
                                        <th style="width: 20%">{{ phrase('item_information') }}</th>
                                        <th style="width: 5%">{{ phrase('delete') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if serverSettings[server.getId()].items %}
                                        {% for item in serverSettings[server.getId()].items %}
                                        <tr class="item-row" data-item-id="{{ item.itemId }}">
                                            <td class="text-center item-index">{{ loop.index }}</td>
                                            <td>
                                                <input type="number" 
                                                       class="form-control form-control-sm item-id-input" 
                                                       placeholder="ID" 
                                                       value="{{ item.itemId }}"
                                                       {% if pluginActive == false %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       class="form-control form-control-sm min-count-input" 
                                                       placeholder="1" 
                                                       min="1" 
                                                       value="{{ item.minCount }}"
                                                       {% if pluginActive == false %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       class="form-control form-control-sm max-count-input" 
                                                       placeholder="1" 
                                                       min="1" 
                                                       value="{{ item.maxCount }}"
                                                       {% if pluginActive == false %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       class="form-control form-control-sm enchant-input" 
                                                       placeholder="0" 
                                                       value="{{ item.enchant ?? 0 }}"
                                                       {% if pluginActive == false %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       class="form-control form-control-sm chance-input" 
                                                       placeholder="0.00" 
                                                       step="0.01" 
                                                       min="0" 
                                                       max="100"
                                                       value="{{ item.chance }}"
                                                       {% if pluginActive == false %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <div class="item-info text-muted small">
                                                    <small>{{ phrase('Loading...') }}</small>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-danger remove-item-btn">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Chance Summary -->
                        <div class="alert alert-info mb-3">
                            <strong>{{ phrase('sum_chance') }}:</strong> <span class="chance-sum">0</span>%
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar chance-progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary add-item-btn" {% if pluginActive == false %}disabled{% endif %}>
                                <i class="bi bi-plus-circle me-1"></i>{{ phrase('add_item') }}
                            </button>
                            <button type="button" class="btn btn-success save-settings-btn" data-server-id="{{ server.getId() }}" {% if pluginActive == false %}disabled{% endif %}>
                                <i class="bi bi-save me-1"></i>{{ phrase('save') }}
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Manual Tab -->
                <div class="tab-pane fade" 
                     id="manual-content" 
                     role="tabpanel">
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 class="fw-semibold mb-3">{{ phrase('api_documentation') }}</h5>
                            
                            <!-- Try Win Endpoint -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">{{ phrase('try_win_rewards') }}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-2">{{ phrase('try_win_description') }}</p>
                                    
                                    <div class="mb-3">
                                        <strong>URL:</strong>
                                        <code class="bg-light p-2 d-block rounded">/plugin/registration_reward/try-win</code>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('method') }}:</strong>
                                        <code class="bg-warning bg-opacity-10 p-2 d-block rounded text-warning">POST</code>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('required_params') }}:</strong>
                                        <div class="table-responsive mt-2">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>{{ phrase('param') }}</th>
                                                        <th>{{ phrase('type') }}</th>
                                                        <th>{{ phrase('description') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><code>serverId</code></td>
                                                        <td>Integer</td>
                                                        <td>{{ phrase('server_id_param') }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('response_success') }}:</strong>
                                        <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
{
  "ok": true,
  "items": [
    {
      "itemId": 1870,
      "name": "Coal",
      "count": 5,
      "enchant": 0,
      "icon": "/uploads/images/icon/etc_coal_i00.webp"
    }
  ]
}</pre>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('response_error') }}:</strong>
                                        <pre class="bg-light p-2 rounded">
{
  "ok": false,
  "message": "No items configured for this server"
}</pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Clear Winned Endpoint -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">{{ phrase('clear_rewards') }}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-2">{{ phrase('clear_rewards_description') }}</p>
                                    
                                    <div class="mb-3">
                                        <strong>URL:</strong>
                                        <code class="bg-light p-2 d-block rounded">/plugin/registration_reward/clear-winned</code>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('method') }}:</strong>
                                        <code class="bg-danger bg-opacity-10 p-2 d-block rounded text-danger">POST</code>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('no_params') }}</strong>
                                    </div>

                                    <div class="mb-3">
                                        <strong>{{ phrase('response_success') }}:</strong>
                                        <pre class="bg-light p-2 rounded">
{
  "ok": true,
  "message": "All rewards cleared"
}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Test Section -->
                        <div class="col-lg-4">
                            <h5 class="fw-semibold mb-3">{{ phrase('test_api') }}</h5>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">{{ phrase('select_server') }}:</label>
                                        <select class="form-select form-select-sm manual-test-server-select">
                                            <option value="">-- {{ phrase('select_server') }} --</option>
                                            {% for server in servers %}
                                            <option value="{{ server.getId() }}">{{ server.getName() }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <button type="button" class="btn btn-sm btn-primary w-100 mb-2 manual-try-win-btn">
                                        <i class="bi bi-play-circle me-1"></i>{{ phrase('test_try_win') }}
                                    </button>

                                    <button type="button" class="btn btn-sm btn-danger w-100 manual-clear-btn">
                                        <i class="bi bi-trash me-1"></i>{{ phrase('test_clear') }}
                                    </button>

                                    <div id="manual-test-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const pluginName = "{{pluginName}}";
    const pluginActive = "{{pluginActive}}";
    const allServers = {{ servers|json_encode|raw }};
    const allServerSettings = {{ serverSettings|json_encode|raw }};
</script>
<script src="{{template}}/assets/js/spherePlugin.js?v=0.0.4"></script>
<script src="{{template_plugin}}/tpl/js/setting.js?v=1.0.0"></script>
{% endblock %}
