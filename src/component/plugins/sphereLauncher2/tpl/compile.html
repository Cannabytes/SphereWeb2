{% extends 'struct.html' %}

{% block title %}Конструктор Лаунчера и Конфигурации{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row mt-4">
        <div class="col-xl-12">
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">
                        Конструктор Лаунчера (Бинарный файл)
                    </div>
                </div>
                <div class="card-body">
                    <form id="compile-form">

                        <!-- Основные настройки -->
                        <div class="settings-section">
                            <h5 class="section-title">
                                <i class="ri-settings-3-line"></i>
                                Основные настройки
                            </h5>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label" for="dataUrl">
                                        Ссылка на launcher.json <i class="text-danger">*</i>
                                    </label>
                                    <input class="form-control" id="dataUrl"
                                        placeholder="https://example.com/launcher.json" type="text"
                                        value="{{HTTP_HOST()}}/launcher.json">
                                </div>

                                <div class="col-md-8">
                                    <label class="form-label"
                                        data-bs-content="<img src='{{template_plugin}}/img/title.jpg' alt='Пример подсказки' style='max-width: 300px; border-radius: 5px;'>"
                                        data-bs-html="true" data-bs-toggle="popover" data-bs-trigger="hover"
                                        for="pageTitle" tabindex="0">
                                        Название программы <i class="text-danger">*</i> <i
                                            class="ri-information-line"></i>
                                    </label>
                                    <input class="form-control" id="pageTitle"
                                        placeholder="Введите название окна лаунчера" type="text" value="Мой Лаунчер">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label" for="launcherVersion">
                                        Версия лаунчера
                                    </label>
                                    <input class="form-control" id="launcherVersion" placeholder="например, 1.0.0"
                                        type="text" value="1.0.0">
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Иконка лаунчера</label>
                                    <input accept=".png,.ico" class="form-control" id="iconUpload" type="file">
                                    <div class="form-text">Форматы: PNG, ICO. Максимальный размер: 100 КБ. Разрешение:
                                        до 128x128 пикселей.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Выбор шаблона -->
                        <div class="settings-section">
                            <h5 class="section-title">
                                <i class="ri-palette-line"></i>
                                Выбор шаблона лаунчера
                            </h5>
                            <p class="text-muted mb-3">Выберите визуальный стиль лаунчера. Каждый шаблон автоматически
                                настроит оптимальные параметры окна.</p>

                            <div class="template-selector" id="templateSelector">

                                <!-- vistor -->
                                <div class="template-card" data-template="vistor" data-default-width="1100"
                                    data-default-height="700" data-min-width="700" data-min-height="600"
                                    data-max-width="1100" data-max-height="800" data-fullscreen="true"
                                    data-frameless="true" data-disable-resize="true" data-css-drag="true"
                                    data-enable-f1="true">
                                    <div class="template-radio">
                                        <input type="radio" name="template" value="vistor" id="template-vistor">
                                    </div>
                                    <img src="{{template_plugin}}/tpl/screen/vistor.jpg" alt="vistor template"
                                        class="template-image"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="template-image-fallback vistor">
                                        <i class="ri-firefox-line"></i>
                                    </div>
                                    <div class="template-content">
                                        <div class="template-title">vistor</div>
                                        <div class="template-description">Анимированный дизайн высокого качества</div>
                                    </div>
                                </div>

                                <!-- Custom Template -->
                                <div class="template-card" data-template="custom" data-default-width="900"
                                    data-default-height="700" data-min-width="800" data-min-height="600"
                                    data-max-width="1200" data-max-height="900" data-fullscreen="true"
                                    data-frameless="false" data-disable-resize="true" data-css-drag="false">
                                    <div class="template-radio">
                                        <input type="radio" name="template" value="custom" id="template-custom">
                                    </div>
                                    <div class="template-badge">Свой</div>
                                    <img src="{{template_plugin}}/tpl/screen/custom.jpg" alt="Custom template"
                                        class="template-image"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="template-image-fallback custom">
                                        <i class="ri-upload-cloud-line"></i>
                                    </div>
                                    <div class="template-content">
                                        <div class="template-title">Свой шаблон</div>
                                        <div class="template-description">Загрузите собственные файлы шаблона</div>
                                    </div>
                                </div>



                            </div>
                        </div>

                        <!-- Кастомные файлы шаблона -->
                        <div class="settings-section" id="custom-template-section" style="display: none;">
                            <h5 class="section-title">
                                <i class="ri-upload-cloud-2-line"></i>
                                Файлы пользовательского шаблона
                            </h5>
                            <div class="custom-template-upload">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="customHtmlFile" class="form-label">
                                            Файл шаблона (index.html) <i class="text-danger">*</i>
                                        </label>
                                        <input class="form-control" type="file" id="customHtmlFile" accept=".html">
                                        <div class="form-text">
                                            Обязательный файл. Должен называться index.html и быть не больше 100 КБ.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="customCssFile" class="form-label">
                                            Файл стилей (launcher.css)
                                        </label>
                                        <input class="form-control" type="file" id="customCssFile" accept=".css">
                                        <div class="form-text">
                                            Опционально. Должен называться launcher.css и быть не больше 100 КБ.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="customLangFile" class="form-label">
                                            Файл локализации (lang.json)
                                        </label>
                                        <input class="form-control" type="file" id="customLangFile" accept=".json">
                                        <div class="form-text">
                                            Опционально. Должен называться lang.json и быть не больше 100 КБ.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="customLogoFile" class="form-label">
                                            Изображение лого
                                        </label>
                                        <input class="form-control" type="file" id="customLogoFile"
                                            accept=".png,.jpg,.jpeg,.gif,.bmp,.svg">
                                        <div class="form-text">
                                            Опционально. Форматы: PNG, JPG, JPEG, GIF, BMP, SVG. До 250 КБ.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Настройки окна -->
                        <div class="settings-section">
                            <h5 class="section-title">
                                <button class="btn btn-link p-0 text-decoration-none section-collapse-btn" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#windowSettingsCollapse"
                                    aria-expanded="false" aria-controls="windowSettingsCollapse">
                                    <i class="ri-window-line"></i>
                                    Настройки окна лаунчера
                                    <i class="ri-arrow-down-s-line collapse-icon ms-2"></i>
                                </button>
                            </h5>

                            <div class="collapse" id="windowSettingsCollapse">
                                <p class="text-muted mb-3">Настройки автоматически применяются при выборе шаблона, но вы
                                    можете их изменить.</p>

                                <div class="row g-3">
                                    <!-- Размеры по умолчанию -->
                                    <div class="col-md-6">
                                        <label class="form-label"
                                            data-bs-content="<img src='{{template_plugin}}/img/min.jpg' alt='Пример подсказки' style='max-width: 300px; border-radius: 5px;'>"
                                            data-bs-html="true" data-bs-toggle="popover" data-bs-trigger="hover"
                                            for="windowWidth" tabindex="0">
                                            Ширина окна <i class="ri-information-line"></i>
                                        </label>
                                        <div class="input-group">
                                            <input class="form-control" id="windowWidth" type="number" value="900">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label"
                                            data-bs-content="<img src='{{template_plugin}}/img/max.jpg' alt='Пример подсказки' style='max-width: 300px; border-radius: 5px;'>"
                                            data-bs-html="true" data-bs-toggle="popover" data-bs-trigger="hover"
                                            for="windowHeight" tabindex="0">
                                            Высота окна <i class="ri-information-line"></i>
                                        </label>
                                        <div class="input-group">
                                            <input class="form-control" id="windowHeight" type="number" value="700">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>

                                    <!-- Минимальные размеры -->
                                    <div class="col-md-6">
                                        <label class="form-label" for="minWidth">Мин. ширина окна</label>
                                        <div class="input-group">
                                            <input class="form-control" id="minWidth" type="number" value="900">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label" for="minHeight">Мин. высота окна</label>
                                        <div class="input-group">
                                            <input class="form-control" id="minHeight" type="number" value="700">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>

                                    <!-- Максимальные размеры -->
                                    <div class="col-md-6">
                                        <label class="form-label" for="maxWidth">Макс. ширина окна</label>
                                        <div class="input-group">
                                            <input class="form-control" id="maxWidth" type="number" value="900">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label" for="maxHeight">Макс. высота окна</label>
                                        <div class="input-group">
                                            <input class="form-control" id="maxHeight" type="number" value="700">
                                            <span class="input-group-text">px</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Настройки поведения -->
                        <div class="settings-section">
                            <h5 class="section-title">
                                <button class="btn btn-link p-0 text-decoration-none section-collapse-btn" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#behaviorSettingsCollapse"
                                    aria-expanded="false" aria-controls="behaviorSettingsCollapse">
                                    <i class="ri-settings-5-line"></i>
                                    Настройки поведения
                                    <i class="ri-arrow-down-s-line collapse-icon ms-2"></i>
                                </button>
                            </h5>

                            <div class="collapse" id="behaviorSettingsCollapse">
                                <div class="row g-3">
                                    <div class="col-lg-4 col-md-6">
                                        <div class="setting-card">
                                            <label class="form-label">Полноэкранный режим</label>
                                            <small class="d-block text-muted mb-2">Запускать лаунчер в полноэкранном
                                                режиме</small>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" id="fullscreenSwitch" role="switch"
                                                    type="checkbox">
                                                <label class="form-check-label" for="fullscreenSwitch">Включить по
                                                    умолчанию</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 col-md-6">
                                        <div class="setting-card">
                                            <label class="form-label">Рамка Windows</label>
                                            <small class="d-block text-muted mb-2">Системная рамка с кнопками управления
                                                окном</small>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" id="frameless" role="switch"
                                                    type="checkbox">
                                                <label class="form-check-label" for="frameless">Включить рамку</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 col-md-6">
                                        <div class="setting-card">
                                            <label class="form-label">Изменение размера</label>
                                            <small class="d-block text-muted mb-2">Возможность растягивать окно
                                                лаунчера</small>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" id="disableResize" role="switch"
                                                    type="checkbox">
                                                <label class="form-check-label" for="disableResize">Запретить
                                                    изменение</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 col-md-6">
                                        <div class="setting-card">
                                            <label class="form-label">Перетаскивание</label>
                                            <small class="d-block text-muted mb-2">Перетаскивание окна за элементы с
                                                классом "drag"</small>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" id="CSSDragProperty" role="switch"
                                                    type="checkbox">
                                                <label class="form-check-label" for="CSSDragProperty">Включить</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 col-md-6">
                                        <div class="setting-card">
                                            <label class="form-label">Режим администратора</label>
                                            <small class="d-block text-muted mb-2">Доступ к странице создания архивов по
                                                F1, изменения в реал-тайме шаблона</small>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" id="enableAdminMode" role="switch"
                                                    type="checkbox">
                                                <label class="form-check-label" for="enableAdminMode">Включить</label>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- Дополнительные ссылки -->
                        <div class="settings-section">
                            <h5 class="section-title">
                                <i class="ri-links-line"></i>
                                Дополнительные ссылки
                            </h5>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label" for="accountLink">Ссылка на личный кабинет</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="ri-account-circle-line"></i></span>
                                        <input class="form-control" id="accountLink"
                                            placeholder="https://example.com/account" type="url">
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label" for="registerLink">Ссылка на регистрацию</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="ri-user-add-line"></i></span>
                                        <input class="form-control" id="registerLink"
                                            placeholder="https://example.com/register" type="url">
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label" for="forumLink">Ссылка на форум</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="ri-question-answer-line"></i></span>
                                        <input class="form-control" id="forumLink"
                                            placeholder="https://example.com/forum" type="url">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопка сборки -->
                        <div class="settings-section">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-primary btn-lg" id="compile-btn" type="submit">
                                    <i class="ri-rocket-line"></i>
                                    Начать компиляцию лаунчера
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Статус сборки -->
                    <div class="mt-4" id="status-container" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="ri-settings-2-line"></i>
                                    Статус сборки
                                </h5>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        id="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                </div>
                                <p class="text-muted" id="status-message">Ожидание запуска задачи...</p>

                                <div class="mt-3" id="result-container" style="display: none;">
                                    <a class="btn btn-success disabled" href="#" id="download-btn">
                                        <i class="ri-download-2-line"></i> Скачать готовый лаунчер
                                    </a>
                                    <button class="btn btn-secondary ms-2" id="new-build-btn">
                                        <i class="ri-refresh-line"></i> Собрать новый
                                    </button>
                                </div>

                                <div class="alert alert-danger mt-3" id="error-container" style="display: none;">
                                    <strong>Ошибка!</strong> <span id="error-message"></span>
                                    <button class="btn btn-warning btn-sm float-end" id="retry-build-btn">
                                        <i class="ri-refresh-line"></i> Попробовать снова
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const GO_SERVER_ADDRESS = '{{go_server_address|raw}}';

        if (!GO_SERVER_ADDRESS) {
            console.error("Критическая ошибка: Адрес Go-сервера не был передан из PHP. Убедитесь, что в PHP-шаблонизаторе установлена переменная 'go_server_address'.");
            alert("Критическая ошибка конфигурации UI. Свяжитесь с администратором.");
            return;
        }

        // Элементы формы
        const compileForm = document.getElementById('compile-form');
        const compileBtn = document.getElementById('compile-btn');
        const statusContainer = document.getElementById('status-container');
        const progressBar = document.getElementById('progress-bar');
        const statusMessage = document.getElementById('status-message');
        const resultContainer = document.getElementById('result-container');
        const downloadBtn = document.getElementById('download-btn');
        const newBuildBtn = document.getElementById('new-build-btn');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const retryBuildBtn = document.getElementById('retry-build-btn');

        // Элементы для работы с шаблонами
        const templateCards = document.querySelectorAll('.template-card');
        const customTemplateSection = document.getElementById('custom-template-section');

        let pollingInterval;

        // === ОБРАБОТЧИКИ ДЛЯ СПОЙЛЕРОВ ===

        function initCollapseSpoiler(collapseId, buttonSelector) {
            const collapseElement = document.getElementById(collapseId);
            const collapseButton = document.querySelector(buttonSelector);

            if (collapseElement && collapseButton) {
                // Обработчик события показа спойлера
                collapseElement.addEventListener('show.bs.collapse', function () {
                    collapseButton.setAttribute('aria-expanded', 'true');
                    console.log(`Спойлер ${collapseId} открывается`);
                });

                // Обработчик события скрытия спойлера
                collapseElement.addEventListener('hide.bs.collapse', function () {
                    collapseButton.setAttribute('aria-expanded', 'false');
                    console.log(`Спойлер ${collapseId} закрывается`);
                });

                // Обработчик события полного показа спойлера
                collapseElement.addEventListener('shown.bs.collapse', function () {
                    console.log(`Спойлер ${collapseId} полностью открыт`);
                });

                // Обработчик события полного скрытия спойлера
                collapseElement.addEventListener('hidden.bs.collapse', function () {
                    console.log(`Спойлер ${collapseId} полностью закрыт`);
                });

                // Улучшенный клик по всему заголовку (не только по кнопке)
                const sectionTitle = collapseButton.closest('.section-title');
                if (sectionTitle) {
                    sectionTitle.addEventListener('click', function (event) {
                        // Предотвращаем двойное срабатывание, если клик был по самой кнопке
                        if (event.target === collapseButton || collapseButton.contains(event.target)) {
                            return;
                        }

                        // Программно кликаем по кнопке collapse
                        collapseButton.click();
                    });
                }
            }
        }

        // Инициализируем оба спойлера
        initCollapseSpoiler('windowSettingsCollapse', '[data-bs-target="#windowSettingsCollapse"]');
        initCollapseSpoiler('behaviorSettingsCollapse', '[data-bs-target="#behaviorSettingsCollapse"]');

        // === ФУНКЦИИ ДЛЯ РАБОТЫ С ШАБЛОНАМИ ===

        /**
         * Применение настроек шаблона к форме
         * @param {HTMLElement} templateCard - карточка выбранного шаблона
         */
        function applyTemplateSettings(templateCard) {
            const data = templateCard.dataset;
            // Применяем размеры окна
            // Атрибуты в разметке: data-default-width, data-default-height, data-min-width, data-min-height, data-max-width, data-max-height
            document.getElementById('windowWidth').value = data.defaultWidth || '900';
            document.getElementById('windowHeight').value = data.defaultHeight || '700';
            document.getElementById('minWidth').value = data.minWidth || '800';
            document.getElementById('minHeight').value = data.minHeight || '600';
            document.getElementById('maxWidth').value = data.maxWidth || '1200';
            document.getElementById('maxHeight').value = data.maxHeight || '900';

            // Применяем настройки поведения и устанавливаем disabled состояние
            // Соответствие data-атрибутов -> dataset: data-fullscreen -> dataset.fullscreen, data-frameless -> dataset.frameless, data-disable-resize -> dataset.disableResize, data-css-drag -> dataset.cssDrag, data-enable-f1 -> dataset.enableF1
            const behaviorSettings = [
                { dataKey: 'fullscreen', elementId: 'fullscreenSwitch', defaultValue: false },
                { dataKey: 'frameless', elementId: 'frameless', defaultValue: false, inverted: true },
                { dataKey: 'disableResize', elementId: 'disableResize', defaultValue: false },
                { dataKey: 'cssDrag', elementId: 'CSSDragProperty', defaultValue: false },
                { dataKey: 'enableF1', elementId: 'enableAdminMode', defaultValue: false }
            ];

            behaviorSettings.forEach(setting => {
                const element = document.getElementById(setting.elementId);
                const rawValue = data[setting.dataKey]; // may be 'true', 'false', 'off' or undefined

                if (!element) return;

                // Если явно указан 'off' — делаем control disabled и сбрасываем значение
                if (rawValue === 'off') {
                    element.disabled = true;
                    element.checked = false;
                    const parentCard = element.closest('.setting-card');
                    if (parentCard) parentCard.classList.add('disabled-setting');
                    return;
                }

                // Обычное состояние — включаем control
                element.disabled = false;
                const parentCard = element.closest('.setting-card');
                if (parentCard) parentCard.classList.remove('disabled-setting');

                // Вычисляем checked: если rawValue задан как 'true'/'false' — используем его, иначе берем defaultValue
                let checked;
                if (rawValue === undefined) {
                    checked = !!setting.defaultValue;
                } else {
                    checked = rawValue === 'true';
                }

                if (setting.inverted) checked = !checked;
                element.checked = checked;
            });

            console.log(`Применены настройки для шаблона: ${data.template || templateCard.getAttribute('data-template')}`);
        }

        /**
         * Обновление выбранного шаблона
         * @param {string} selectedValue - значение выбранного шаблона
         */
        function updateSelectedTemplate(selectedValue) {
            let selectedCard = null;

            templateCards.forEach(card => {
                const radio = card.querySelector('input[type="radio"]');
                if (radio.value === selectedValue) {
                    card.classList.add('selected');
                    radio.checked = true;
                    selectedCard = card;
                } else {
                    card.classList.remove('selected');
                    radio.checked = false;
                }
            });

            // Показать/скрыть секцию кастомного шаблона
            toggleCustomTemplateSection(selectedValue === 'custom');

            // Применить настройки выбранного шаблона
            if (selectedCard) {
                applyTemplateSettings(selectedCard);
            }
        }

        /**
         * Переключение видимости секции кастомного шаблона
         * @param {boolean} show - показать или скрыть секцию
         */
        function toggleCustomTemplateSection(show = false) {
            if (customTemplateSection) {
                customTemplateSection.style.display = show ? 'block' : 'none';

                const customCard = document.querySelector('[data-template="custom"]');
                if (customCard) {
                    if (show) {
                        customCard.classList.add('custom-template-highlight');
                    } else {
                        customCard.classList.remove('custom-template-highlight');
                    }
                }
            }
        }

        /**
         * Получение выбранного шаблона
         * @returns {string} - значение выбранного шаблона
         */
        function getSelectedTemplate() {
            const selectedRadio = document.querySelector('input[name="template"]:checked');
            return selectedRadio ? selectedRadio.value : 'default';
        }

        // === ИНИЦИАЛИЗАЦИЯ СЕЛЕКТОРА ШАБЛОНОВ ===

        // Обработчик кликов по карточкам шаблонов
        templateCards.forEach(card => {
            card.addEventListener('click', function () {
                const templateValue = this.dataset.template;
                updateSelectedTemplate(templateValue);
            });
        });

        // Обработчик изменения радиокнопок
        document.querySelectorAll('input[name="template"]').forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.checked) {
                    updateSelectedTemplate(this.value);
                }
            });
        });

        // Инициализация - выбираем первый доступный шаблон на странице и применяем его настройки
        (function initDefaultTemplate() {
            const firstCard = document.querySelector('.template-card');
            if (firstCard && firstCard.dataset && firstCard.dataset.template) {
                updateSelectedTemplate(firstCard.dataset.template);
            } else {
                updateSelectedTemplate('default');
            }
        })();

        // === ОСНОВНЫЕ ОБРАБОТЧИКИ СОБЫТИЙ ===

        compileForm.addEventListener('submit', handleCompileRequest);
        newBuildBtn.addEventListener('click', resetUI);
        retryBuildBtn.addEventListener('click', resetUI);

        function resetUI() {
            compileForm.style.display = 'block';
            statusContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            downloadBtn.classList.add('disabled');
            downloadBtn.href = "#";
            downloadBtn.style.display = 'inline-block';
            downloadBtn.innerHTML = '<i class="ri-download-2-line"></i> Скачать готовый лаунчер';
            compileBtn.disabled = false;

            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            updateProgress(0, "Ожидание...");
        }

        function updateProgress(progress, message) {
            const p = Math.max(0, Math.min(100, progress));
            progressBar.style.width = p + '%';
            progressBar.innerText = p + '%';
            progressBar.setAttribute('aria-valuenow', p);
            progressBar.classList.remove('bg-success', 'bg-danger');
            if (p < 100) {
                progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
            }
            statusMessage.innerText = message;
        }

        function handleCompileRequest(event) {
            event.preventDefault();
            compileBtn.disabled = true;

            // Проверка выбора шаблона
            const selectedTemplateRadio = document.querySelector('input[name="template"]:checked');
            if (!selectedTemplateRadio) {
                noticeError('Пожалуйста, выберите шаблон лаунчера перед компиляцией.');
                compileBtn.disabled = false;
                return;
            }

            // Сбор данных формы
            const buildData = {
                dataUrl: document.getElementById('dataUrl').value,
                title: document.getElementById('pageTitle').value,
                windowWidth: parseInt(document.getElementById('windowWidth').value) || 900,
                windowHeight: parseInt(document.getElementById('windowHeight').value) || 700,
                minWidth: parseInt(document.getElementById('minWidth').value) || 800,
                minHeight: parseInt(document.getElementById('minHeight').value) || 600,
                maxWidth: parseInt(document.getElementById('maxWidth').value) || 1200,
                maxHeight: parseInt(document.getElementById('maxHeight').value) || 900,
                launcherVersion: document.getElementById('launcherVersion').value || "1.0.0",
                template: getSelectedTemplate(),
                accountLink: document.getElementById('accountLink').value,
                registrationLink: document.getElementById('registerLink').value,
                forumLink: document.getElementById('forumLink').value,
                fullscreen: document.getElementById('fullscreenSwitch').checked,
                frameless: !document.getElementById('frameless').checked, // Инвертируем логику!
                disableResize: document.getElementById('disableResize').checked,
                CSSDragProperty: document.getElementById('CSSDragProperty').checked,
                enableAdminMode: document.getElementById('enableAdminMode').checked,
                iconBase64: "",
                customHtmlBase64: "",
                customCssBase64: "",
                customLangJsonBase64: "",
                customLogoBase64: ""
            };

            const iconFile = document.getElementById('iconUpload').files[0];
            const customHtmlFile = document.getElementById('customHtmlFile').files[0];
            const customCssFile = document.getElementById('customCssFile').files[0];
            const customLangFile = document.getElementById('customLangFile').files[0];
            const customLogoFile = document.getElementById('customLogoFile').files[0];

            const MAX_SIZE = 100 * 1024; // 100 КБ
            const MAX_LOGO_SIZE = 250 * 1024; // 250 КБ для лого

            // Проверки размеров файлов
            if (iconFile && iconFile.size > MAX_SIZE) {
                alert('Ошибка: Размер иконки не должен превышать 100 КБ.');
                compileBtn.disabled = false;
                return;
            }

            if (buildData.template === 'custom') {
                if (!customHtmlFile) {
                    alert('Для пользовательского шаблона необходимо выбрать как минимум файл index.html.');
                    compileBtn.disabled = false;
                    return;
                }
                if (customHtmlFile.size > MAX_SIZE) {
                    alert('Ошибка: Размер HTML файла не должен превышать 100 КБ.');
                    compileBtn.disabled = false;
                    return;
                }
                if (customCssFile && customCssFile.size > MAX_SIZE) {
                    alert('Ошибка: Размер CSS файла не должен превышать 100 КБ.');
                    compileBtn.disabled = false;
                    return;
                }
                if (customLangFile && customLangFile.size > MAX_SIZE) {
                    alert('Ошибка: Размер lang.json файла не должен превышать 100 КБ.');
                    compileBtn.disabled = false;
                    return;
                }
                if (customLogoFile && customLogoFile.size > MAX_LOGO_SIZE) {
                    alert('Ошибка: Размер файла лого не должен превышать 250 КБ.');
                    compileBtn.disabled = false;
                    return;
                }
            }

            // Функции для чтения файлов
            const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
                if (!file) return resolve("");
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });

            const checkImageDimensions = (file) => new Promise((resolve, reject) => {
                if (!file) return resolve();
                const image = new Image();
                image.onload = () => {
                    if (image.width > 128 || image.height > 128) {
                        reject(new Error('Разрешение иконки не должно превышать 128x128 пикселей.'));
                    } else {
                        resolve();
                    }
                };
                image.onerror = () => reject(new Error('Не удалось прочитать файл иконки.'));
                image.src = URL.createObjectURL(file);
            });

            // Чтение файлов и отправка запроса
            checkImageDimensions(iconFile)
                .then(() => {
                    return Promise.all([
                        readFileAsBase64(iconFile),
                        readFileAsBase64(customHtmlFile),
                        readFileAsBase64(customCssFile),
                        readFileAsBase64(customLangFile),
                        readFileAsBase64(customLogoFile),
                    ]);
                })
                .then(([iconBase64, customHtml, customCss, customLang, customLogo]) => {
                    buildData.iconBase64 = iconBase64;
                    buildData.customHtmlBase64 = customHtml;
                    buildData.customCssBase64 = customCss;
                    buildData.customLangJsonBase64 = customLang;
                    buildData.customLogoBase64 = customLogo;

                    sendInitialRequest(buildData);
                })
                .catch(err => {
                    alert('Ошибка подготовки данных: ' + err.message);
                    compileBtn.disabled = false;
                });
        }

        // Функция отправки запроса (остается без изменений)
        function sendInitialRequest(data) {
            compileForm.style.display = 'none';
            statusContainer.style.display = 'block';
            errorContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            updateProgress(0, 'Отправка запроса на сервер...');

            fetch('/admin/plugin/sphereLauncher2/compile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `Сервер вернул ошибку ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    if (result.task_id) {
                        updateProgress(2, 'Задача создана. Начинаем отслеживание статуса...');
                        startPolling(result.task_id);
                    } else {
                        throw new Error('Сервер не вернул ID задачи.');
                    }
                })
                .catch(err => {
                    statusContainer.style.display = 'block';
                    errorContainer.style.display = 'block';
                    errorMessage.innerText = err.message;
                    resultContainer.style.display = 'block';
                    downloadBtn.style.display = 'none';
                    compileBtn.disabled = false;
                });
        }

        function startPolling(taskId) {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            pollingInterval = setInterval(() => {
                pollTaskStatus(taskId);
            }, 2000);
        }

        function pollTaskStatus(taskId) {
            const statusUrl = `/admin/plugin/sphereLauncher2/status/${taskId}`;

            fetch(statusUrl)
                .then(response => {
                    if (response.status === 404) {
                        throw new Error('Задача не найдена на сервере. Возможно, сервер был перезапущен.');
                    }
                    if (!response.ok) {
                        throw new Error('Ошибка сети при запросе статуса.');
                    }
                    return response.json();
                })
                .then(task => {
                    console.log("Получен статус задачи:", task);

                    if (task.error && task.status !== 'failed') {
                        throw new Error(task.error);
                    }

                    updateProgress(task.progress, task.message);

                    if (task.status === 'completed' || task.status === 'failed') {
                        clearInterval(pollingInterval);

                        if (task.status === 'completed') {
                            statusMessage.innerText = "Сборка успешно завершена! Сохраняем файл на ваш сервер...";
                            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                            progressBar.classList.add('bg-success');
                            resultContainer.style.display = 'block';
                            downloadBtn.style.display = 'inline-block';
                            downloadBtn.classList.add('disabled');
                            downloadBtn.innerHTML = "Идёт сохранение...";

                            fetch('/admin/plugin/sphereLauncher2/download', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({
                                    result_url: task.result_url
                                })
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.json().then(err => {
                                            throw new Error(err.error || 'Ошибка при сохранении файла на сервер.');
                                        });
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        statusMessage.innerText = "Файл готов к скачиванию!";
                                        downloadBtn.href = data.file_path;
                                        downloadBtn.innerHTML = '<i class="ri-download-2-line"></i> Скачать Launcher.exe';
                                        downloadBtn.classList.remove('disabled');
                                        downloadBtn.target = '_blank';
                                    } else {
                                        throw new Error(data.error || 'Неизвестная ошибка при сохранении файла.');
                                    }
                                })
                                .catch(err => {
                                    console.error('Ошибка при сохранении файла:', err);
                                    errorContainer.style.display = 'block';
                                    errorMessage.innerText = 'Не удалось сохранить готовый лаунчер на ваш сервер. ' + err.message;
                                    downloadBtn.style.display = 'none';
                                });

                        } else {
                            statusMessage.innerText = "Сборка завершилась с ошибкой.";
                            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                            progressBar.classList.add('bg-danger');
                            errorContainer.style.display = 'block';
                            errorMessage.innerText = task.error;
                            resultContainer.style.display = 'block';
                            downloadBtn.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Ошибка при опросе статуса:', error);
                    clearInterval(pollingInterval);
                    errorContainer.style.display = 'block';
                    errorMessage.innerText = error.message;
                    resultContainer.style.display = 'block';
                    downloadBtn.style.display = 'none';
                });
        }
    });
</script>
{% endblock %}

{% block css %}
<style>
    /* Основные стили для улучшенной структуры */
    .settings-section {
        margin-bottom: 1rem;
        border-radius: 10px;
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
    }

    .section-title i {
        margin-right: 0.5rem;
    }

    /* Стили для карточек настроек */
    .setting-card {
        padding: 1rem;
        border-radius: 8px;
        height: 100%;
    }

    .setting-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
    }

    /* Стили для загрузки кастомного шаблона */
    .custom-template-upload {
        padding: 1.5rem;
        border-radius: 8px;
    }

    /* Селектор шаблонов */
    .template-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .template-card {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .template-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #0d6efd;
    }

    .template-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.2);
        transform: translateY(-2px);
    }

    .template-card.selected::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        z-index: 2;
    }

    .template-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        object-position: center;
        display: block;
    }

    .template-image-fallback {
        width: 100%;
        height: 180px;
        display: none;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
        position: relative;
    }

    /* Цвета для fallback изображений */
    .template-image-fallback.default {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .template-image-fallback.cyberpunk {
        background: linear-gradient(135deg, #ff0080 0%, #7928ca 100%);
    }

    .template-image-fallback.flat {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .template-image-fallback.duxy {
        background: linear-gradient(135deg, #8360c3 0%, #2ebf91 100%);
    }

    .template-image-fallback.fonar {
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }

    .template-image-fallback.futuristic {
        background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
    }

    .template-image-fallback.material {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    }

    .template-image-fallback.skeuomorphism {
        background: linear-gradient(135deg, #8360c3 0%, #2ebf91 100%);
    }

    .template-image-fallback.gsax {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
    }

    .template-image-fallback.gagarka {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }

    .template-image-fallback.lafa {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
    }

    .template-image-fallback.pinocolate {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .template-image-fallback.sfox {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: #333;
    }

    .template-image-fallback.custom {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
    }

    .template-content {
        padding: 16px;
    }

    .template-title {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 8px;
    }

    .template-description {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 0;
        line-height: 1.4;
    }

    .template-radio {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 3;
    }

    .template-radio input[type="radio"] {
        width: 20px;
        height: 20px;
        accent-color: #0d6efd;
    }

    .template-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        z-index: 3;
    }

    .custom-template-highlight {
        border: 2px dashed #ffc107 !important;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    }

    /* Анимации */
    .template-card {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .template-selector {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .template-image,
        .template-image-fallback {
            height: 150px;
            font-size: 36px;
        }

        .template-content {
            padding: 12px;
        }

        .settings-section {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    }

    /* Улучшенные switch элементы */
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .form-check-input:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Стили для progress bar */
    .progress {
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        border-radius: 10px;
    }

    /* Кнопки */
    .btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }

    /* Стили для disabled настроек */
    .setting-card.disabled-setting {
        opacity: 0.6;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        pointer-events: none;
        position: relative;
    }

    .setting-card.disabled-setting::before {
        content: "Недоступно для выбранного шаблона";
        position: absolute;
        top: 8px;
        right: 8px;
        background: #6c757d;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
        z-index: 2;
    }

    .setting-card.disabled-setting .form-check-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .setting-card.disabled-setting .form-label,
    .setting-card.disabled-setting small {
        color: #6c757d !important;
    }

    /* Анимация для плавного перехода */
    .setting-card {
        transition: all 0.3s ease;
    }

    /* Стили для спойлеров настроек */
    .section-collapse-btn {
        color: inherit !important;
        font-weight: 600;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        margin: 0;
        padding: 0;
        font-size: inherit;
    }

    .section-collapse-btn:hover {
        color: #0d6efd !important;
    }

    .section-collapse-btn:focus {
        color: #0d6efd !important;
    }

    .collapse-icon {
        transition: transform 0.3s ease;
        margin-left: auto;
    }

    .section-collapse-btn[aria-expanded="true"] .collapse-icon {
        transform: rotate(180deg);
    }

    .section-collapse-btn[aria-expanded="false"] .collapse-icon {
        transform: rotate(0deg);
    }

    /* Анимация для содержимого спойлера */
    .collapse {
        transition: all 0.35s ease;
    }

    .collapsing {
        transition: height 0.35s ease;
    }

    /* Улучшенный hover эффект для заголовка спойлера */
    .section-title:has(.section-collapse-btn) {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0;
        transition: background-color 0.2s ease;
        cursor: pointer;
    }

    .section-title:has(.section-collapse-btn):hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    /* Дополнительный отступ для содержимого спойлера */
    .collapse .row {
        padding-top: 1rem;
    }
</style>
{% endblock %}