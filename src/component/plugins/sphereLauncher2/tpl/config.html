{% extends 'struct.html' %}

{% block title %}{{ phrase('sl2_json_config_generator') }}{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row ">
        <div class="col-xl-12">
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">
                        1. {{ phrase('sl2_json_config_generator_launcher') }}
                    </div>
                </div>
                <div class="card-body">

                    <div class="shadow p-3 mb-5 bg-body rounded">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="fw-bold text-primary mb-2">{{ phrase('sl2_about_launcher_config') }}</h6>
                                <p class="mb-2">{{ phrase('sl2_launcher_config_desc_1') }}</p>
                                <p class="mb-2">{{ phrase('sl2_launcher_config_desc_2') }}</p>
                                <p class="mb-0">{{ phrase('sl2_launcher_config_desc_3') }}</p>
                            </div>

                            <div class="col-md-4">
                                <div id="json-drop-zone"
                                    class="json-drop-zone-compact border border-2 border-dashed border-info rounded p-3 text-center">
                                    <div class="drop-zone-content">
                                        <i class="ri-file-upload-line fs-1 text-info mb-2"></i>
                                        <h6 class="text-info mb-1">{{ phrase('sl2_upload_json') }}</h6>
                                        <p class="small text-muted mb-2">{{ phrase('sl2_drag_launcher_json') }}</p>
                                        <input type="file" id="json-file-input" accept=".json" style="display: none;">
                                        <button type="button" class="btn btn-outline-info btn-sm"
                                            onclick="document.getElementById('json-file-input').click()">
                                            <i class="ri-folder-open-line me-1"></i>{{ phrase('sl2_select') }}
                                        </button>
                                    </div>
                                </div>
                                <div id="drop-zone-status" class="mt-2" style="display: none;">
                                    <div class="alert alert-success py-2 mb-0 small">
                                        <i class="ri-check-line me-1"></i>
                                        <span id="loaded-file-name"></span> {{ phrase('sl2_loaded_success') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="json-generator-form">
                        <div class="row g-3">
                            <div class="col-md-6 border-end">
                                <h5>{{ phrase('sl2_loader_settings') }}</h5>
                                <div class="mb-3">
                                    <label class="form-label">{{ phrase('sl2_csv_links') }}</label>
                                    <div class="input-group">
                                        <input class="form-control" id="csv-input"
                                            placeholder="https://example.com/updates.csv" type="url">
                                        <button class="btn btn-outline-secondary" id="add-csv-btn"
                                            type="button">{{ phrase('sl2_add_more') }}</button>
                                    </div>
                                    <ul class="list-group mt-2" id="csv-list"></ul>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ phrase('sl2_archive_links') }}</label>
                                    <div class="input-group">
                                        <input class="form-control" id="archive-input"
                                            placeholder="https://example.com/archives/" type="url">
                                        <button class="btn btn-outline-secondary" id="add-archive-btn"
                                            type="button">{{ phrase('sl2_add_more') }}</button>
                                    </div>
                                    <ul class="list-group mt-2" id="archive-list"></ul>
                                </div>

                                <div class="mb-3 mt-3">
                                    <label class="form-label d-flex justify-content-between align-items-center">{{ phrase('sl2_account_manager') }}
                                        <small class="text-muted">({{ phrase('sl2_autologin') }})</small>
                                    </label>
                                    <div class="p-2 bg-white border rounded">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="autologin-enable">
                                            <label class="form-check-label small" for="autologin-enable">{{ phrase('sl2_enable_account_manager') }}</label>
                                        </div>

                                        {{ phrase('sl2_autologin_desc_1') }}
                                        {{ phrase('sl2_autologin_desc_2') }}
                                        {{ phrase('sl2_autologin_warning') }}

                                        <div class="mb-2">
                                            <label class="form-label small">{{ phrase('sl2_pattern') }}</label>
                                            <input class="form-control form-control-sm" id="autologin-pattern"
                                                placeholder="-login=%login% -password=%password% -charname=%charname%"
                                                type="text">
                                            <small class="text-muted">{{ phrase('sl2_placeholder_autologin') }}</small>
                                        </div>

                                        <!-- Autologin description removed at user request -->
                                    </div>
                                </div>

                                <!-- Block: File transfer on language change (translationPaths) - table -->
                                <div class="mb-3 mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">{{ phrase('sl2_file_transfer_lang') }}</label>
                                        <div class="form-check form-switch m-0">
                                            <input class="form-check-input" type="checkbox" id="tp-enable-checkbox">
                                            <label class="form-check-label small"
                                                for="tp-enable-checkbox">{{ phrase('sl2_enable') }}</label>
                                        </div>
                                    </div>
                                    <div class="p-2 bg-white border rounded">
                                        <div class="table-responsive">
                                            <table class="table table-sm align-middle mb-0" id="tp-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width:70px;">{{ phrase('sl2_language') }}</th>
                                                        <th>Src Path</th>
                                                        <th>Dst Path</th>
                                                        <th style="width:120px;">{{ phrase('sl2_default') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr data-lang="ru">
                                                        <td><span class="badge bg-secondary">ru</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-ru" placeholder="/system/files/ru" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-ru" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="ru" disabled></td>
                                                    </tr>
                                                    <tr data-lang="en">
                                                        <td><span class="badge bg-secondary">en</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-en" placeholder="/system/files/en" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-en" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="en" disabled></td>
                                                    </tr>
                                                    <tr data-lang="es">
                                                        <td><span class="badge bg-secondary">es</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-es" placeholder="/system/files/es" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-es" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="es" disabled></td>
                                                    </tr>
                                                    <tr data-lang="pt">
                                                        <td><span class="badge bg-secondary">pt</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-pt" placeholder="/system/files/pt" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-pt" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="pt" disabled></td>
                                                    </tr>
                                                    <tr data-lang="uk">
                                                        <td><span class="badge bg-secondary">uk</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-uk" placeholder="/system/files/uk" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-uk" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="uk" disabled></td>
                                                    </tr>
                                                    <tr data-lang="el">
                                                        <td><span class="badge bg-secondary">el</span></td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-src-el" placeholder="/system/files/el" disabled>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm"
                                                                id="tp-dst-el" placeholder="/system" disabled></td>
                                                        <td class="text-center"><input type="radio" name="tp-default"
                                                                value="el" disabled></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <small class="text-muted">{{ phrase('sl2_fill_tp_desc') }}</small>
                                    </div>
                                </div>

                            </div>

                            <div class="col-md-6">
                                <h5>{{ phrase('sl2_apps_to_launch') }}</h5>
                                <div class="p-3 bg-light rounded">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">{{ phrase('sl2_button_names_for_langs') }}</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡·ðŸ‡º {{ phrase('sl2_russian_ru') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-ru"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="{{ phrase('sl2_play') }}">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡ºðŸ‡¸ {{ phrase('sl2_english_en') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-en"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="Play">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡ªðŸ‡¸ {{ phrase('sl2_spanish_es') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-es"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="Jugar">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡µðŸ‡¹ {{ phrase('sl2_portuguese_pt') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-pt"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="Jogar">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡ºðŸ‡¦ {{ phrase('sl2_ukrainian_uk') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-uk"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="Ð“Ñ€Ð°Ñ‚Ð¸">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">ðŸ‡¬ðŸ‡· {{ phrase('sl2_greek_el') }}</label>
                                                <input class="form-control form-control-sm" id="app-name-el"
                                                    placeholder="{{ phrase('sl2_play') }}" type="text" value="Î Î±Î¯Î¾Ï„Îµ">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label">{{ phrase('sl2_executable_file_path') }}</label>
                                            <input value="system/l2.exe" class="form-control" id="app-exe-input"
                                                placeholder="{{ phrase('sl2_exe_path_placeholder') }}" type="text"
                                                value="system/l2.exe">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">{{ phrase('sl2_launch_args_optional') }}</label>
                                            <input class="form-control" id="app-args-input" placeholder="" type="text">
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <label class="form-label mb-0">{{ phrase('sl2_triggers_optional') }}</label>
                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    id="add-trigger-btn">{{ phrase('sl2_add_trigger') }}</button>
                                            </div>
                                            <div id="trigger-container" class="vstack gap-2"></div>
                                            <small class="text-muted">{{ phrase('sl2_triggers_desc') }}</small>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button class="btn btn-outline-primary btn-sm" id="add-app-btn"
                                                type="button">{{ phrase('sl2_add_app') }}</button>
                                        </div>
                                    </div>
                                </div>
                                <ul class="list-group mt-2" id="app-list"></ul>
                            </div>

                            <hr class="my-4">

                            <div class="col-md-6">
                                <label class="form-label" for="json-launcher-version">{{ phrase('sl2_launcher_version') }}</label>
                                <input class="form-control" id="json-launcher-version" type="text" value="1.0.0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="json-launcher-link">{{ phrase('sl2_launcher_download_link') }}</label>
                                <input class="form-control" id="json-launcher-link"
                                    placeholder="https://example.com/launcher.exe" type="url">
                            </div>

                            <hr class="my-4">

                            <div class="col-12">
                                <h5>{{ phrase('sl2_news_feed') }}</h5>
                                <div class="p-3 bg-light rounded">
                                    <div class="row g-3">
                                        <div class="col-md-2">
                                            <label class="form-label">{{ phrase('sl2_language') }}</label>
                                            <select class="form-select" id="news-lang-select">
                                                <option selected value="ru">{{ phrase('sl2_russian_ru') }}</option>
                                                <option value="en">{{ phrase('sl2_english_en') }}</option>
                                                <option value="es">{{ phrase('sl2_spanish_es') }}</option>
                                                <option value="pt">{{ phrase('sl2_portuguese_pt') }}</option>
                                                <option value="uk">{{ phrase('sl2_ukrainian_uk') }}</option>
                                                <option value="el">{{ phrase('sl2_greek_el') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5"><label class="form-label">{{ phrase('sl2_title') }}</label><input
                                                class="form-control" id="news-name-input"
                                                placeholder="{{ phrase('sl2_news_title') }}" type="text"></div>
                                        <div class="col-md-5"><label class="form-label">{{ phrase('sl2_date') }}</label><input
                                                class="form-control" id="news-date-input" placeholder="{{ phrase('sl2_date_format') }}"
                                                type="text"></div>
                                        <div class="col-12"><label class="form-label">{{ phrase('sl2_description') }}</label><textarea
                                                class="form-control" id="news-desc-input"
                                                placeholder="{{ phrase('sl2_news_desc_placeholder') }}" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-6"><label class="form-label">{{ phrase('sl2_image_url') }}</label><input
                                                class="form-control" id="news-image-input"
                                                placeholder="https://example.com/image.png" type="url"></div>
                                        <div class="col-md-6"><label class="form-label">{{ phrase('sl2_link_url') }}</label><input
                                                class="form-control" id="news-link-input"
                                                placeholder="https://example.com/full-news" type="url"></div>
                                        <div class="col-12 text-end"><button class="btn btn-outline-primary btn-sm"
                                                id="add-news-btn" type="button">{{ phrase('sl2_add_news') }}</button></div>
                                    </div>
                                </div>
                                <div class="mt-3" id="news-container"></div>
                            </div>

                            <hr class="my-4">

                            <div class="col-12 text-center">
                                <button class="btn btn-success btn-lg" id="generate-json-btn" type="button">
                                    <i class="ri-file-download-line"></i> {{ phrase('sl2_generate_and_download_json') }}
                                </button>
                                <br>

                                <small class="d-block text-muted">
                                    {{ phrase('sl2_upload_json_to_site_note') }}<br>
                                    {{ phrase('sl2_specify_link_in_constructor') }}
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block js %}
<style>
    .json-drop-zone-compact {
        min-height: 140px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .json-drop-zone-compact:hover {
        border-color: #0dcaf0 !important;
        background-color: rgba(13, 202, 240, 0.05);
    }

    .json-drop-zone-compact.drag-over {
        border-color: #198754 !important;
        background-color: rgba(25, 135, 84, 0.1);
        transform: scale(1.05);
    }

    .json-drop-zone-compact.drag-over .drop-zone-content {
        color: #198754;
    }

    .json-drop-zone-compact.error {
        border-color: #dc3545 !important;
        background-color: rgba(220, 53, 69, 0.1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // === JSON FILE UPLOAD FUNCTIONALITY ===
        const dropZone = document.getElementById('json-drop-zone');
        const fileInput = document.getElementById('json-file-input');
        const dropZoneStatus = document.getElementById('drop-zone-status');
        const loadedFileName = document.getElementById('loaded-file-name');

        // Handle drag and drop
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleJsonFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleJsonFile(e.target.files[0]);
            }
        });

        function handleJsonFile(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                showError('{{ phrase('sl2_select_json_file_error') }}');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    loadJsonData(jsonData);
                    showSuccess(file.name);
                } catch (error) {
                    showError('{{ phrase('sl2_json_read_error') }}' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showSuccess(fileName) {
            dropZone.classList.remove('error');
            loadedFileName.textContent = fileName;
            dropZoneStatus.style.display = 'block';
            dropZoneStatus.innerHTML = `
            <div class="alert alert-success py-2 mb-0 small">
                <i class="ri-check-line me-1"></i>
                <span>${fileName}</span> {{ phrase('sl2_loaded_success') }}
            </div>
        `;
        }

        function showError(message) {
            dropZone.classList.add('error');
            dropZoneStatus.style.display = 'block';
            dropZoneStatus.innerHTML = `
            <div class="alert alert-danger py-2 mb-0 small">
                <i class="ri-error-warning-line me-1"></i>
                ${message}
            </div>
        `;
        }

        function loadJsonData(data) {
            // {{ phrase('sl2_clear_all_data') }}
            clearAllData();

            // {{ phrase('sl2_loading') }} CSV URLs
            if (data.download && data.download.csv) {
                data.download.csv.forEach(url => {
                    addToList('csv-list', url);
                });
            }

            // {{ phrase('sl2_loading') }} Archive URLs
            if (data.download && data.download.archives) {
                data.download.archives.forEach(url => {
                    addToList('archive-list', url);
                });
            }

            // {{ phrase('sl2_loading') }} launcher info
            if (data.lastLauncherVersion) {
                document.getElementById('json-launcher-version').value = data.lastLauncherVersion;
            }
            if (data.launcherLink) {
                document.getElementById('json-launcher-link').value = data.launcherLink;
            }

            // {{ phrase('sl2_loading') }} applications
            if (data.application && Array.isArray(data.application)) {
                data.application.forEach(app => {
                    loadApplicationData(app);
                });
            }

            // {{ phrase('sl2_loading') }} news
            if (data.news) {
                Object.keys(data.news).forEach(lang => {
                    if (Array.isArray(data.news[lang])) {
                        data.news[lang].forEach(newsItem => {
                            loadNewsData(lang, newsItem);
                        });
                    }
                });
            }
            // {{ phrase('sl2_loading') }} autologin
            if (data.autologin) {
                const ag = data.autologin;
                if (ag.pattern) {
                    document.getElementById('autologin-pattern').value = ag.pattern;
                }
                // autologin description field was removed from UI
                // enable if autologin block exists
                document.getElementById('autologin-enable').checked = true;
            }

            // {{ phrase('sl2_loading') }} translationPaths
            const tpEnableCheckboxLoad = document.getElementById('tp-enable-checkbox');
            if (data.translationPaths) {
                // If helper exists, apply immediately, otherwise store pending for later
                if (typeof setTranslationTableFromObject === 'function') {
                    if (tpEnableCheckboxLoad) {
                        tpEnableCheckboxLoad.checked = true;
                    }
                    try {
                        setTranslationTableFromObject(data.translationPaths);
                    } catch (e) {
                        // ignore
                    }
                    // enable inputs if table present
                    const tpTableLocal = document.getElementById('tp-table');
                    if (tpTableLocal && tpEnableCheckboxLoad && tpEnableCheckboxLoad.checked) {
                        tpTableLocal.querySelectorAll('input').forEach(i => i.disabled = false);
                    }
                } else {
                    // store pending data to be applied when other script initializes
                    window._pendingTranslationPaths = data.translationPaths;
                    // mark that we want feature enabled
                    if (tpEnableCheckboxLoad) tpEnableCheckboxLoad.checked = true;
                }
            } else if (tpEnableCheckboxLoad) {
                tpEnableCheckboxLoad.checked = false;
                const tpTableLocal = document.getElementById('tp-table');
                if (tpTableLocal) tpTableLocal.querySelectorAll('input').forEach(i => i.disabled = true);
            }
        }

        function clearAllData() {
            document.getElementById('csv-list').innerHTML = '';
            document.getElementById('archive-list').innerHTML = '';
            document.getElementById('app-list').innerHTML = '';
            document.getElementById('news-container').innerHTML = '';

            document.getElementById('json-launcher-version').value = '1.0.0';
            document.getElementById('json-launcher-link').value = '';

            // clear autologin
            document.getElementById('autologin-enable').checked = false;
            document.getElementById('autologin-pattern').value = '';

            // clear translationPaths table inputs (safe lookup)
            const tpTableLocal = document.getElementById('tp-table');
            if (tpTableLocal) {
                tpTableLocal.querySelectorAll('tbody tr').forEach(tr => {
                    const lang = tr.dataset.lang;
                    const src = tr.querySelector(`#tp-src-${lang}`);
                    const dst = tr.querySelector(`#tp-dst-${lang}`);
                    const radio = tr.querySelector('input[type="radio"][name="tp-default"]');
                    if (src) src.value = '';
                    if (dst) dst.value = '';
                    if (radio) radio.checked = false;
                });
                // disable all inputs
                tpTableLocal.querySelectorAll('input').forEach(i => i.disabled = true);
            }
            // reset enable checkbox
            const tpEnableCheckbox = document.getElementById('tp-enable-checkbox');
            if (tpEnableCheckbox) {
                tpEnableCheckbox.checked = false;
            }
        }

        function addToList(listId, value) {
            const list = document.getElementById(listId);
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
            <span class="text-break">${value}</span>
            <button type="button" class="btn btn-danger btn-sm remove-btn">
                <i class="ri-delete-bin-line"></i>
            </button>
        `;
            list.appendChild(listItem);
        }

        function loadApplicationData(app) {
            const appList = document.getElementById('app-list');
            const supportedLanguages = ['ru', 'en', 'es', 'pt', 'uk', 'el'];

            let nameTranslations = {};

            if (typeof app.name === 'string') {
                nameTranslations.ru = app.name;
            } else if (Array.isArray(app.name) && app.name.length > 0) {
                nameTranslations = app.name[0] || {};
            }

            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';

            listItem.dataset.exe = app.exe || '';
            listItem.dataset.args = app.args || '';
            listItem.dataset.translations = JSON.stringify(nameTranslations);
            listItem.dataset.triggers = JSON.stringify(app.trigger || []);

            const namesDisplay = supportedLanguages
                .filter(lang => nameTranslations[lang])
                .map(lang => `${lang.toUpperCase()}: "${nameTranslations[lang]}"`)
                .join(', ');

            let triggersSummary = '';
            if (app.trigger && Array.isArray(app.trigger) && app.trigger.length) {
                const parts = app.trigger.map(t => {
                    if (t.name === 'copy') {
                        return `copy(${t.src || ''} -> ${t.dst || ''})`;
                    }
                    return t.name || '';
                });
                triggersSummary = `<small class="d-block text-warning">{{ phrase('sl2_triggers') }}: ${parts.join(', ')}</small>`;
            }

            listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ phrase('sl2_application') }}: ${app.exe || ''}</strong>
                    <small class="d-block text-muted">{{ phrase('sl2_arguments') }}: ${app.args || '{{ phrase('sl2_none') }}'}</small>
                    <small class="d-block text-info">{{ phrase('sl2_names') }}: ${namesDisplay}</small>
                    ${triggersSummary}
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-btn">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
        `;

            appList.appendChild(listItem);
        }

        function loadNewsData(lang, newsItem) {
            const newsContainer = document.getElementById('news-container');

            let langGroup = newsContainer.querySelector(`.news-language-group[data-lang="${lang}"]`);
            if (!langGroup) {
                langGroup = document.createElement('div');
                langGroup.className = 'news-language-group mb-3';
                langGroup.dataset.lang = lang;
                langGroup.innerHTML = `
                <h5>{{ phrase('sl2_news') }} (${lang})</h5>
                <ul class="list-group"></ul>
            `;
                newsContainer.appendChild(langGroup);
            }

            const newsList = langGroup.querySelector('.list-group');
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';

            listItem.dataset.name = newsItem.name || '';
            listItem.dataset.description = newsItem.description || '';
            listItem.dataset.image = newsItem.image || '';
            listItem.dataset.link = newsItem.link || '';
            listItem.dataset.date = newsItem.date || '';

            listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${newsItem.name || ''}</strong> <small class="text-muted">(${newsItem.date || ''})</small>
                    <p class="mb-1 text-break">${newsItem.description || ''}</p>
                    <small class="text-muted text-break">{{ phrase('sl2_image') }}: ${newsItem.image || '{{ phrase('sl2_none') }}'}<br>{{ phrase('sl2_link') }}: ${newsItem.link || '{{ phrase('sl2_none') }}'}</small>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-btn ms-2">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
        `;
            newsList.appendChild(listItem);
        }


    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- {{ phrase('sl2_simple_lists_management') }} (CSV, {{ phrase('sl2_archives') }}) ---
        function setupSimpleList(inputId, btnId, listId) {
            const input = document.getElementById(inputId);
            const addBtn = document.getElementById(btnId);
            const list = document.getElementById(listId);

            addBtn.addEventListener('click', () => {
                const value = input.value.trim();
                if (value) {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <span class="text-break">${value}</span>
                        <button type="button" class="btn btn-danger btn-sm remove-btn">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    `;
                    list.appendChild(listItem);
                    input.value = '';
                }
            });
        }

        setupSimpleList('csv-input', 'add-csv-btn', 'csv-list');
        setupSimpleList('archive-input', 'add-archive-btn', 'archive-list');

        // ...existing code...

        // --- Translation Paths (translationPaths) - table-driven ---
        const tpTable = document.getElementById('tp-table');
        function setTranslationTableFromObject(obj) {
            if (!obj) return;
            Object.keys(obj).forEach(lang => {
                const row = tpTable.querySelector(`tr[data-lang="${lang}"]`);
                if (!row) return;
                const tp = obj[lang] || {};
                const srcInput = row.querySelector(`#tp-src-${lang}`) || row.querySelector('input[id^="tp-src-"]');
                const dstInput = row.querySelector(`#tp-dst-${lang}`) || row.querySelector('input[id^="tp-dst-"]');
                if (srcInput) srcInput.value = tp.srcPath || '';
                if (dstInput) dstInput.value = tp.dstPath || '';
                if (tp.default) {
                    const radio = row.querySelector('input[type="radio"][name="tp-default"]');
                    if (radio) radio.checked = true;
                }
            });
        }
        // expose for first script loadJsonData
        window.setTranslationTableFromObject = setTranslationTableFromObject;

        // Enable/disable translation table inputs based on checkbox
        const tpEnableCheckbox = document.getElementById('tp-enable-checkbox');
        function setTpEnabled(enabled) {
            if (!tpTable) return;
            tpTable.querySelectorAll('input').forEach(inp => inp.disabled = !enabled);
        }
        if (tpEnableCheckbox) {
            // default: disabled
            tpEnableCheckbox.checked = false;
            setTpEnabled(false);
            tpEnableCheckbox.addEventListener('change', (e) => {
                setTpEnabled(e.target.checked);
            });
        }

        // If loadJsonData stored pending translationPaths earlier, apply them now
        if (window._pendingTranslationPaths && typeof setTranslationTableFromObject === 'function') {
            // enable table inputs first
            if (tpEnableCheckbox) {
                tpEnableCheckbox.checked = true;
                setTpEnabled(true);
            }
            try {
                setTranslationTableFromObject(window._pendingTranslationPaths);
            } catch (e) {
                console.warn('Failed to apply pending translationPaths', e);
            }
            // clear pending
            delete window._pendingTranslationPaths;
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.remove-btn')) {
                const listItem = e.target.closest('li');
                const listGroup = listItem.parentElement;
                listItem.remove();

                // {{ phrase('sl2_remove_empty_news_group') }}
                if (listGroup.children.length === 0 && listGroup.parentElement.classList.contains('news-language-group')) {
                    listGroup.parentElement.remove();
                }
            }
        });

        const appExeInput = document.getElementById('app-exe-input');
        const appArgsInput = document.getElementById('app-args-input');
        const addAppBtn = document.getElementById('add-app-btn');
        const appList = document.getElementById('app-list');
        const supportedLanguages = ['ru', 'en', 'es', 'pt', 'uk', 'el'];
        const triggerContainer = document.getElementById('trigger-container');
        const addTriggerBtn = document.getElementById('add-trigger-btn');

        function createTriggerRow(prefill) {
            const div = document.createElement('div');
            div.className = 'border rounded p-2 trigger-row';
            div.innerHTML = `
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small mb-1">{{ phrase('sl2_type') }}</label>
                    <select class="form-select form-select-sm trigger-type">
                        <option value="">-- {{ phrase('sl2_not_selected') }} --</option>
                        <option value="copy">copy</option>
                        <option value="WindowMinimize">WindowMinimize</option>
                        <option value="WindowClose">WindowClose</option>
                        <option value="StartGameReport">StartGameReport</option>
                    </select>
                </div>
                <div class="col-md-4 copy-fields d-none">
                    <label class="form-label small mb-1">{{ phrase('sl2_src_folder') }}</label>
                    <input type="text" class="form-control form-control-sm trigger-src" placeholder="system/files/x1">
                </div>
                <div class="col-md-4 copy-fields d-none">
                    <label class="form-label small mb-1">{{ phrase('sl2_dst_folder') }}</label>
                    <input type="text" class="form-control form-control-sm trigger-dst" placeholder="system/">
                </div>
                <div class="col-md-6 url-field d-none">
                    <label class="form-label small mb-1">URL</label>
                    <input type="text" class="form-control form-control-sm trigger-url" placeholder="https://example.com/api">
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-trigger-btn" title="{{ phrase('sl2_delete_trigger') }}"><i class="ri-close-line"></i></button>
                </div>
                <div class="col-12 mt-2">
                    <div class="alert alert-secondary py-2 mb-0 small trigger-description" style="min-height:40px;">
                        <strong>{{ phrase('sl2_description') }}:</strong> <span class="desc-text">{{ phrase('sl2_select_type_desc') }}</span>
                    </div>
                </div>
            </div>`;
            triggerContainer.appendChild(div);
            if (prefill) {
                const select = div.querySelector('.trigger-type');
                select.value = prefill.name || '';
                if (prefill.name === 'copy') {
                    div.querySelectorAll('.copy-fields').forEach(el => el.classList.remove('d-none'));
                    div.querySelector('.trigger-src').value = prefill.src || '';
                    div.querySelector('.trigger-dst').value = prefill.dst || '';
                }
                if (prefill.name === 'StartGameReport') {
                    div.querySelectorAll('.url-field').forEach(el => el.classList.remove('d-none'));
                    div.querySelector('.trigger-url').value = prefill.url || '';
                }
                // update description for prefilled row
                updateTriggerDescription(div);
            }
        }

        addTriggerBtn.addEventListener('click', () => createTriggerRow());

        triggerContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('trigger-type')) {
                const row = e.target.closest('.trigger-row');
                const val = e.target.value;
                if (val === 'copy') {
                    row.querySelectorAll('.copy-fields').forEach(el => el.classList.remove('d-none'));
                    row.querySelectorAll('.url-field').forEach(el => { el.classList.add('d-none'); el.querySelector('input').value = ''; });
                } else if (val === 'StartGameReport') {
                    row.querySelectorAll('.url-field').forEach(el => el.classList.remove('d-none'));
                    row.querySelectorAll('.copy-fields').forEach(el => { el.classList.add('d-none'); el.querySelector('input').value = ''; });
                } else {
                    row.querySelectorAll('.copy-fields').forEach(el => { el.classList.add('d-none'); el.querySelector('input').value = ''; });
                    row.querySelectorAll('.url-field').forEach(el => { el.classList.add('d-none'); el.querySelector('input').value = ''; });
                }
            }
        });

        // Update trigger description on type or field changes
        triggerContainer.addEventListener('input', (e) => {
            const row = e.target.closest && e.target.closest('.trigger-row');
            if (!row) return;
            if (e.target.classList.contains('trigger-src') || e.target.classList.contains('trigger-dst') || e.target.classList.contains('trigger-type') || e.target.classList.contains('trigger-url')) {
                updateTriggerDescription(row);
            }
        });

        function updateTriggerDescription(row) {
            const type = row.querySelector('.trigger-type').value;
            const descEl = row.querySelector('.desc-text');
            if (!descEl) return;
            if (type === 'copy') {
                const src = row.querySelector('.trigger-src').value.trim();
                const dst = row.querySelector('.trigger-dst').value.trim();
                const srcText = src ? `<code>${escapeHtml(src)}</code>` : '<em>{{ phrase('sl2_not_specified') }}</em>';
                const dstText = dst ? `<code>${escapeHtml(dst)}</code>` : '<em>{{ phrase('sl2_not_specified') }}</em>';
                descEl.innerHTML = `{{ phrase('sl2_copy_files_from') }} ${srcText} {{ phrase('sl2_to') }} ${dstText}. {{ phrase('sl2_copy_files_desc') }}`;
            } else if (type === 'WindowMinimize') {
                descEl.textContent = '{{ phrase('sl2_minimize_desc') }}';
            } else if (type === 'WindowClose') {
                descEl.textContent = '{{ phrase('sl2_close_desc') }}';
            } else if (type === 'StartGameReport') {
                const url = row.querySelector('.trigger-url').value.trim();
                const urlText = url ? `<code>${escapeHtml(url)}</code>` : '<em>{{ phrase('sl2_not_specified') }}</em>';
                descEl.innerHTML = `{{ phrase('sl2_start_report_desc') }}: ${urlText}. {{ phrase('sl2_start_report_desc_2') }}`;
            } else {
                descEl.textContent = '{{ phrase('sl2_select_type_desc') }}';
            }
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, function (c) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[c]; });
        }

        triggerContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-trigger-btn')) {
                e.target.closest('.trigger-row').remove();
            }
        });

        addAppBtn.addEventListener('click', () => {
            const exe = appExeInput.value.trim();
            const args = appArgsInput.value.trim();
            const nameTranslations = {};
            let hasAnyName = false;
            supportedLanguages.forEach(lang => {
                const input = document.getElementById(`app-name-${lang}`);
                if (input && input.value.trim()) {
                    nameTranslations[lang] = input.value.trim();
                    hasAnyName = true;
                }
            });
            if (!hasAnyName || !exe) {
                alert('{{ phrase('sl2_fill_app_fields') }}');
                return;
            }
            // Trigger collection
            const triggers = [];
            let triggerError = false;
            triggerContainer.querySelectorAll('.trigger-row').forEach(row => {
                const type = row.querySelector('.trigger-type').value;
                if (!type) return; // skip empty
                if (type === 'copy') {
                    const src = row.querySelector('.trigger-src').value.trim();
                    const dst = row.querySelector('.trigger-dst').value.trim();
                    if (!src || !dst) {
                        triggerError = true;
                    } else {
                        triggers.push({ name: 'copy', src, dst });
                    }
                } else if (type === 'WindowMinimize') {
                    // No parameters required for WindowMinimize
                    triggers.push({ name: 'WindowMinimize' });
                } // Adding a new WindowClose trigger
                else if (type === 'WindowClose') {
                    triggers.push({ name: 'WindowClose' });
                } else if (type === 'StartGameReport') {
                    const url = row.querySelector('.trigger-url').value.trim();
                    if (!url) {
                        triggerError = true;
                    } else {
                        triggers.push({ name: 'StartGameReport', url });
                    }
                }
            });
            if (triggerError) {
                alert('{{ phrase('sl2_fill_trigger_fields') }}');
                return;
            }
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.dataset.exe = exe;
            listItem.dataset.args = args;
            listItem.dataset.translations = JSON.stringify(nameTranslations);
            listItem.dataset.triggers = JSON.stringify(triggers);
            const namesDisplay = supportedLanguages
                .filter(lang => nameTranslations[lang])
                .map(lang => `${lang.toUpperCase()}: "${nameTranslations[lang]}"`)
                .join(', ');
            let triggersSummary = '';
            if (triggers.length) {
                const parts = triggers.map(t => t.name === 'copy' ? `copy(${t.src} -> ${t.dst})` : t.name);
                triggersSummary = `<small class=\"d-block text-warning\">{{ phrase('sl2_triggers') }}: ${parts.join(', ')}<\/small>`;
            }
            listItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ phrase('sl2_application') }}: ${exe}</strong>
                        <small class="d-block text-muted">{{ phrase('sl2_arguments') }}: ${args || '{{ phrase('sl2_none') }}'}</small>
                        <small class="d-block text-info">{{ phrase('sl2_names') }}: ${namesDisplay}</small>
                        ${triggersSummary}
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-btn">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `;
            appList.appendChild(listItem);
            appExeInput.value = '';
            appArgsInput.value = '';
            triggerContainer.innerHTML = ''; // clear triggers for next application
        });


        const newsLangSelect = document.getElementById('news-lang-select');
        const newsNameInput = document.getElementById('news-name-input');
        const newsDateInput = document.getElementById('news-date-input');
        const newsDescInput = document.getElementById('news-desc-input');
        const newsImageInput = document.getElementById('news-image-input');
        const newsLinkInput = document.getElementById('news-link-input');
        const addNewsBtn = document.getElementById('add-news-btn');
        const newsContainer = document.getElementById('news-container');

        addNewsBtn.addEventListener('click', () => {
            const lang = newsLangSelect.value;
            const name = newsNameInput.value.trim();
            const date = newsDateInput.value.trim();
            const description = newsDescInput.value.trim();
            const image = newsImageInput.value.trim();
            const link = newsLinkInput.value.trim();
            if (!lang || !name || !date || !description) {
                alert('{{ phrase('sl2_fill_news_fields') }}');
                return;
            }
            let langGroup = newsContainer.querySelector(`.news-language-group[data-lang="${lang}"]`);
            if (!langGroup) {
                langGroup = document.createElement('div');
                langGroup.className = 'news-language-group mb-3';
                langGroup.dataset.lang = lang;
                langGroup.innerHTML = `<h5>{{ phrase('sl2_news') }} (${lang})</h5><ul class="list-group"></ul>`;
                newsContainer.appendChild(langGroup);
            }
            const newsList = langGroup.querySelector('.list-group');
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.dataset.name = name;
            listItem.dataset.description = description;
            listItem.dataset.image = image;
            listItem.dataset.link = link;
            listItem.dataset.date = date;
            listItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${name}</strong> <small class="text-muted">(${date})</small>
                        <p class="mb-1 text-break">${description}</p>
                        <small class="text-muted text-break">{{ phrase('sl2_image') }}: ${image || '{{ phrase('sl2_none') }}'}<br>{{ phrase('sl2_link') }}: ${link || '{{ phrase('sl2_none') }}'}</small>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-btn ms-2">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `;
            newsList.appendChild(listItem);
            newsNameInput.value = '';
            newsDateInput.value = '';
            newsDescInput.value = '';
            newsImageInput.value = '';
            newsLinkInput.value = '';
        });

        const generateJsonBtn = document.getElementById('generate-json-btn');
        generateJsonBtn.addEventListener('click', () => {
            // {{ phrase('sl2_get_supported_langs') }}
            const supportedLanguages = ['ru', 'en', 'es', 'pt', 'uk', 'el'];

            const config = {
                download: {
                    csv: [],
                    archives: []
                },
                application: [],
                lastLauncherVersion: document.getElementById('json-launcher-version').value || '1.0.0',
                launcherLink: document.getElementById('json-launcher-link').value || '',
                news: {}
            };

            // --- 1. {{ phrase('sl2_collecting') }} CSV URLs ---
            // {{ phrase('sl2_from_list') }}
            document.querySelectorAll('#csv-list li').forEach(item => {
                const span = item.querySelector('span');
                if (span && span.textContent.trim()) {
                    config.download.csv.push(span.textContent.trim());
                }
            });
            // {{ phrase('sl2_from_input') }}
            const csvInput = document.getElementById('csv-input');
            if (csvInput.value.trim()) {
                config.download.csv.push(csvInput.value.trim());
            }

            // --- 2. {{ phrase('sl2_collecting') }} Archive URLs ---
            // {{ phrase('sl2_from_list') }}
            document.querySelectorAll('#archive-list li').forEach(item => {
                const span = item.querySelector('span');
                if (span && span.textContent.trim()) {
                    config.download.archives.push(span.textContent.trim());
                }
            });
            // {{ phrase('sl2_from_input') }}
            const archiveInput = document.getElementById('archive-input');
            if (archiveInput.value.trim()) {
                config.download.archives.push(archiveInput.value.trim());
            }

            // --- 3. {{ phrase('sl2_collecting') }} applications ---
            // {{ phrase('sl2_from_list') }}
            document.querySelectorAll('#app-list li').forEach(item => {
                if (item.dataset.exe && item.dataset.translations) {
                    const translations = JSON.parse(item.dataset.translations || '{}');
                    const triggers = item.dataset.triggers ? JSON.parse(item.dataset.triggers) : [];
                    const appObj = {
                        name: [translations],
                        exe: item.dataset.exe,
                        args: item.dataset.args || ''
                    };
                    if (triggers && Array.isArray(triggers) && triggers.length) {
                        appObj.trigger = triggers;
                    }
                    config.application.push(appObj);
                }
            });
            // {{ phrase('sl2_from_input') }}
            const appExeInput = document.getElementById('app-exe-input');
            if (appExeInput.value.trim()) {
                const nameTranslations = {};
                let hasAnyName = false;
                supportedLanguages.forEach(lang => {
                    const input = document.getElementById(`app-name-${lang}`);
                    if (input && input.value.trim()) {
                        nameTranslations[lang] = input.value.trim();
                        hasAnyName = true;
                    }
                });
                // {{ phrase('sl2_add_if_exe_and_name') }}
                if (hasAnyName) {
                    // {{ phrase('sl2_collect_triggers_from_ui') }}
                    const triggers = [];
                    triggerContainer.querySelectorAll('.trigger-row').forEach(row => {
                        const type = row.querySelector('.trigger-type').value;
                        if (!type) return;
                        if (type === 'copy') {
                            const src = row.querySelector('.trigger-src').value.trim();
                            const dst = row.querySelector('.trigger-dst').value.trim();
                            if (src && dst) triggers.push({ name: 'copy', src, dst });
                        } else if (type === 'WindowMinimize') {
                            triggers.push({ name: 'WindowMinimize' });
                        } else if (type === 'WindowClose') {
                            triggers.push({ name: 'WindowClose' });
                        } else if (type === 'StartGameReport') {
                            const url = row.querySelector('.trigger-url').value.trim();
                            if (url) triggers.push({ name: 'StartGameReport', url });
                        }
                    });
                    const appObj = {
                        name: [nameTranslations],
                        exe: appExeInput.value.trim(),
                        args: document.getElementById('app-args-input').value.trim() || ''
                    };
                    if (triggers.length) appObj.trigger = triggers;
                    config.application.push(appObj);
                }
            }

            // --- 4. {{ phrase('sl2_collecting') }} news ---
            // {{ phrase('sl2_from_created_groups') }}
            document.querySelectorAll('.news-language-group').forEach(group => {
                const lang = group.dataset.lang;
                if (lang) {
                    if (!config.news[lang]) {
                        config.news[lang] = [];
                    }
                    group.querySelectorAll('ul li').forEach(item => {
                        if (item.dataset.name && item.dataset.description && item.dataset.date) {
                            config.news[lang].push({
                                name: item.dataset.name,
                                description: item.dataset.description,
                                image: item.dataset.image || '',
                                link: item.dataset.link || '',
                                date: item.dataset.date
                            });
                        }
                    });
                }
            });
            // {{ phrase('sl2_from_input') }}
            const newsNameInput = document.getElementById('news-name-input');
            const newsDescInput = document.getElementById('news-desc-input');
            const newsDateInput = document.getElementById('news-date-input');
            // {{ phrase('sl2_add_if_obligatory_filled') }}
            if (newsNameInput.value.trim() && newsDescInput.value.trim() && newsDateInput.value.trim()) {
                const lang = document.getElementById('news-lang-select').value;
                const newsItem = {
                    name: newsNameInput.value.trim(),
                    description: newsDescInput.value.trim(),
                    image: document.getElementById('news-image-input').value.trim() || '',
                    link: document.getElementById('news-link-input').value.trim() || '',
                    date: newsDateInput.value.trim()
                };
                if (!config.news[lang]) {
                    config.news[lang] = [];
                }
                config.news[lang].push(newsItem);
            }

            // --- 6. {{ phrase('sl2_collecting') }} translationPaths ---
            const tpEnable = document.getElementById('tp-enable-checkbox') && document.getElementById('tp-enable-checkbox').checked;
            if (tpEnable) {
                const tpRows = document.querySelectorAll('#tp-table tbody tr');
                config.translationPaths = {};
                let defaultCount = 0;
                tpRows.forEach(tr => {
                    const lang = tr.dataset.lang;
                    if (!lang) return;
                    const src = (tr.querySelector(`#tp-src-${lang}`) || tr.querySelector('input[id^="tp-src-"]')).value.trim();
                    const dst = (tr.querySelector(`#tp-dst-${lang}`) || tr.querySelector('input[id^="tp-dst-"]')).value.trim();
                    const radio = tr.querySelector('input[type="radio"][name="tp-default"]');
                    const isDefault = radio && radio.checked;
                    if (src || dst) {
                        config.translationPaths[lang] = {
                            srcPath: src,
                            dstPath: dst
                        };
                        if (isDefault) {
                            config.translationPaths[lang].default = true;
                            defaultCount++;
                        }
                    } else if (isDefault) {
                        // default selected but no paths provided â€” count as invalid
                        defaultCount++;
                    }
                });
                if (defaultCount !== 1) {
                    alert('{{ phrase('sl2_select_one_default_tp') }}');
                    return;
                }
            }


            // --- 5. {{ phrase('sl2_generate_and_download') }} ---
            // Autologin: {{ phrase('sl2_add_if_checked_and_pattern') }}
            const autologinEnable = document.getElementById('autologin-enable').checked;
            const autologinPattern = document.getElementById('autologin-pattern').value.trim();
            if (autologinEnable && autologinPattern) {
                config.autologin = {
                    pattern: autologinPattern
                };
            }
            const jsonString = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonString], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'launcher.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

    });
</script>
{% endblock %}