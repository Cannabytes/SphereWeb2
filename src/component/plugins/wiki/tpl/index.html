{% extends 'struct.html' %}

{% block content %}

<style>
    /* Base styles for class tree */
    .class-tree {
        text-align: center;
        font-family: monospace;
    }

    .tree-node {
        display: inline-block;
        margin: 10px;
        position: relative;
    }

    .tree-connector {
        width: 1px;
        height: 20px;
        background: rgba(204, 204, 204, 0.11);
        margin: 0 auto;
    }

    .tree-children {
        display: flex;
        justify-content: center;
        position: relative;
    }

    /* For multiple children we draw a dynamic horizontal line element instead of a full-width pseudo-element */
    .tree-children.multiple {
        flex-wrap: nowrap;
    }

    .tree-horizontal {
        position: absolute;
        top: 0;
        height: 1px;
        background: rgba(204, 204, 204, 0.11);
    }

    .tree-children>.tree-node {
        margin-top: 20px;
    }

    .tree-children>.tree-node::before {
        content: '';
        position: absolute;
        top: -20px;
        left: 50%;
        width: 1px;
        height: 20px;
        background: rgba(204, 204, 204, 0.11);
        transform: translateX(-50%);
    }

    .class-node {
        display: inline-block;
        padding: 6px 8px;
        border: 1px solid #cccccc1c;
        border-radius: 6px;
        transition: background 0.2s, box-shadow 0.2s;
        text-align: center;
        min-width: 120px;
        box-sizing: border-box;
    }

    /* Text color transition for hover / keyboard focus */
    .class-node .class-title,
    .class-node .class-meta {
        transition: color 0.18s ease;
        color: inherit;
        /* keep bootstrap/text-muted/text-success baseline */
    }

    /* Only change color for the specific text element hovered or focused.
       Do NOT change when hovering the whole .class-node. */
    .class-meta:hover,
    .class-meta:focus,
    .class-meta:focus-visible {
        color: #0d6efd !important;
        outline: none;
    }

    .class-image {
        width: 50px;
        height: 50px;
        display: block;
        border-radius: 3px;
        margin: 0 auto 6px auto;
        object-fit: cover;
    }

    /* Tooltip for class descriptions */
    .class-tooltip {
        position: absolute;
        z-index: 1050;
        max-width: 320px;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 8px 10px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        font-size: 13px;
        line-height: 1.3;
        display: none;
        pointer-events: none;
    }

    .class-node[aria-describedby] {
        position: relative;
    }

    /* Small screen adjustments (phones) */
    @media (max-width: 767.98px) {

        /* Make sidebar and content stack naturally via existing bootstrap cols, but refine small controls */
        .card .card-body .d-flex.mb-3 {
            display: flex !important;
            flex-direction: column;
            gap: 8px;
        }

        .card .card-body .d-flex.mb-3 .form-control {
            width: 100%;
            margin-right: 0;
        }

        .card .card-body .d-flex.mb-3 .btn {
            align-self: stretch;
        }

        /* Increase touch target for list links */
        .list-group-item a,
        .list-group-item .badge {
            display: inline-block;
            padding: 8px 10px;
            margin-bottom: 6px;
        }

        /* Tree becomes vertical on phones for readability */
        .tree-children {
            flex-direction: column !important;
            align-items: center;
        }

        .tree-children.multiple {
            flex-wrap: wrap !important;
        }

        .tree-node {
            display: block;
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
        }

        .tree-children>.tree-node::before {
            top: -10px;
            height: 10px;
        }

        .tree-connector {
            height: 10px;
        }

        .tree-horizontal {
            display: none !important;
        }

        .class-node {
            min-width: unset;
            width: 100%;
        }

        .class-image {
            width: 44px;
            height: 44px;
        }
    }

    /* Medium screens tweaks */
    @media (min-width: 768px) and (max-width: 1199.98px) {
        .class-node {
            min-width: 110px;
        }

        .class-image {
            width: 46px;
            height: 46px;
        }
    }

    /* Ensure menu items are displayed as a vertical list */
    .list-group-item .small {
        display: flex;
        flex-direction: column; /* Stack links vertically */
        gap: 10px; /* Add spacing between links */
    }

    .list-group-item .small a {
        display: flex;
        align-items: center; /* Align icon and text */
        text-decoration: none; /* Optional: Remove underline */
        font-size: 1.1rem; /* Increase text size */
    }

    .list-group-item .small a img {
        width: 20px; /* Increase icon size */
        height: 20px; /* Ensure consistent height */
        margin-right: 10px; /* Adjust spacing between icon and text */
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-xl-3 col-lg-4">
            <div class="card mb-1">
                <div class="card-body">
                    <ul class="list-group list-group-flush mb-1">
                        {# Сгруппированные предметы: Оружие, Броня, Бижутерия, Рецепты, Другие #}
                        <li class="list-group-item">
                            <div>
                                <strong>{{ phrase('Items') }}</strong>
                                <div class="small mt-1">
                                    <a href="/wiki/items/weapons">
                                        <img class="rounded"
                                            src="/uploads/images/icon/weapon_arcana_mace_i01.webp">{{ phrase('Weapons') }}</a>
                                    <a href="/wiki/items/armors">
                                        <img class="rounded"
                                            src="/uploads/images/icon/armor_t89_ul_i00.webp">{{ phrase('Armors') }}</a>
                                    <a href="/wiki/items/jewelry">
                                        <img class="rounded"
                                            src="/uploads/images/icon/accessory_earring_of_zaken_i00.webp">{{ phrase('Jewelry') }}</a>
                                    <a href="wiki/items/armors/other">
                                        <img class="rounded"
                                            src="/uploads/images/icon/br_aga_zaken_i00.webp">Остальная броня</a>
                                    <a href="/wiki/items/etcitems">
                                        <img class="rounded"
                                            src="/uploads/images/icon/etc_spell_shot_gold_i01.webp">{{ phrase('Other items') }}</a>
                                    <a href="/wiki/category/armorsets">
                                        <img class="rounded"
                                            src="/uploads/images/icon/armor_t1004_ul_i00.webp">{{ phrase('Armor sets') }}</a>
                                </div>
                                <!-- Global Item search (opens modal for live search) -->
                                <div class="mt-3">
                                    <div class="d-flex">
                                        <input id="wiki-item-search" type="search" class="form-control form-control-sm me-2" placeholder="{{ phrase('Open item search (press Enter)') }}" aria-label="Search Items">
                                        <button id="wiki-item-go" type="button" class="btn btn-sm text-muted" title="{{ phrase('Open search') }}">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>

                        {# Раздел NPC с подкатегориями: Монсты, Рейд Боссы и типы #}
                        <li class="list-group-item">
                            <div>
                                <strong>{{ phrase('NPC') }}</strong>
                                <div class="small mt-1">
                                    <a href="/wiki/npcs/monsters">
                                        <img class="rounded"
                                            src="/src/component/plugins/wiki/tpl/img/other/mobs.webp">{{ phrase('Monsters') }}</a>
                                    <a href="/wiki/npcs/raidboses">
                                        <img class="rounded"
                                            src="/src/component/plugins/wiki/tpl/img/other/rb.webp">{{ phrase('Raid Bosses') }}</a>
                                    <a href="/wiki/npcs/epicbosses">
                                        <img class="rounded"
                                            src="/src/component/plugins/wiki/tpl/img/other/epicrb.webp">{{ phrase('Epic Bosses') }}</a>
                                </div>
                            </div>
                            <!-- Global NPC search (opens modal for live search) -->
                            <div class="mt-3">
                                <div class="d-flex">
                                    <input id="wiki-npc-search" type="search" class="form-control form-control-sm me-2" placeholder="{{ phrase('Open search (press Enter)') }}" aria-label="Search NPCs">
                                    <button id="wiki-npc-go" type="button" class="btn btn-sm text-muted" title="{{ phrase('Open search') }}">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </li>

                        {# Раздел Добыча: Дроп и Спойл #}
                        <li class="list-group-item">
                            <div>
                                <strong>{{ phrase('Loot') }}</strong>
                                <div class="small mt-1">
                                    <a href="/wiki/items/drop">
                                        <img class="rounded"
                                            src="/src/component/plugins/wiki/tpl/img/other/drop.webp">{{ phrase('Drop') }}</a>
                                    <a href="/wiki/items/spoil">
                                        <img class="rounded"
                                            src="/src/component/plugins/wiki/tpl/img/other/spoil.webp">{{ phrase('Spoil') }}</a>
                                    <a href="/wiki/items/recipes">
                                        <img class="rounded"
                                            src="/uploads/images/icon/etc_recipe_black_i00.webp">{{ phrase('Recipes and Craft') }}</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-xl-9 col-lg-8">

            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">
                        {{ phrase('Classes, races, skills') }}
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3 border-bottom-0" role="tablist">
                        {% set first = true %}
                        {% for race, classes in classesByRace %}
                        <li class="nav-item">
                            <a class="nav-link {% if first %}active{% endif %}" data-bs-toggle="tab" role="tab"
                                href="#{{ race|lower|replace({' ': ''}) }}"
                                aria-selected="{% if first %}true{% else %}false{% endif %}">{{ race }}</a>
                        </li>
                        {% set first = false %}
                        {% endfor %}
                    </ul>
                    <div class="tab-content">
                        {% set first = true %}
                        {% for race, classes in classesByRace %}
                        <div class="tab-pane {% if first %}show active{% endif %} text-muted"
                            id="{{ race|lower|replace({' ': ''}) }}" role="tabpanel">
                            <div class="row">

                                {% for rootClass in classes %} {% if classes|length==2 %}<div
                                    class=" col-xl-6 col-lg-6">
                                    {% endif %}
                                    <div class="mb-4">
                                        <div class="class-tree">
                                            {{ _self.renderClassTree(rootClass, 0) }}
                                        </div>
                                    </div>
                                    {% if classes|length == 2 %}
                                </div>{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% set first = false %}
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


{% macro renderClassTree(class, level) %}
<div class="tree-node {% if not class.children %}leaf{% endif %}">
    <div class="class-node" tabindex="0">
        {% set imgsrc = '/src/component/plugins/wiki/tpl/img/classlist/' ~ class.id ~ '.png' %}
        {% if class.parent_id is null %}
        {% set imgsrc = '/src/template/sphere/assets/images/race/female/' ~ get_class_race(class.id) ~ '.jpg' %}
        {% endif %}
        <img src="{{ imgsrc }}" alt="{{ class.name }}" class="class-image"
            onerror="this.onerror=null;this.src='/src/component/plugins/wiki/tpl/img/classlist/none.jpg'">
        <div class="text-muted class-title" tabindex="0">{{ class.name }}</div>
    </div>

    {% if class.children %}
    <div class="tree-connector"></div>
    <div class="tree-children {% if class.children|length > 1 %}multiple{% endif %}">
        {% if class.children|length > 1 %}<div class="tree-horizontal"></div>{% endif %}
        {% for child in class.children %}
        {{ _self.renderClassTree(child, level + 1) }}
        {% endfor %}
    </div>
    {% endif %}

</div>
{% endmacro %}

<script>
    // Dynamic sizing of horizontal connectors so they end exactly at first/last child.
    function updateTreeHorizontalLines() {
        document.querySelectorAll('.tree-children.multiple').forEach(container => {
            // Skip hidden (e.g., inactive tab-pane) containers; they'll be recalculated on tab show.
            if (!(container.offsetParent instanceof HTMLElement)) return;
            const line = container.querySelector('.tree-horizontal');
            if (!line) return;

            // On small screens we use vertical stacking; hide the horizontal line and allow wrap
            if (window.innerWidth < 768) {
                line.style.display = 'none';
                container.style.flexWrap = 'wrap';
                return;
            }

            const nodes = Array.from(container.children).filter(el => el.classList && el.classList.contains('tree-node'));
            if (nodes.length < 2) { line.style.width = '0'; line.style.display = 'none'; return; }
            // Prevent wrapping issues – enforce no-wrap for accurate measurement
            container.style.flexWrap = 'nowrap';
            line.style.display = '';
            const cRect = container.getBoundingClientRect();
            const firstRect = nodes[0].getBoundingClientRect();
            const lastRect = nodes[nodes.length - 1].getBoundingClientRect();
            const left = (firstRect.left + firstRect.width / 2) - cRect.left;
            const right = (lastRect.left + lastRect.width / 2) - cRect.left;
            line.style.left = left + 'px';
            line.style.width = (right - left) + 'px';
        });
    }

    let __treeLineResizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(__treeLineResizeTimer);
        __treeLineResizeTimer = setTimeout(updateTreeHorizontalLines, 100);
    });
    document.addEventListener('DOMContentLoaded', updateTreeHorizontalLines);
    // Recalculate when a Bootstrap tab becomes visible
    document.addEventListener('shown.bs.tab', function (e) {
        // Slight delay to ensure layout settled
        setTimeout(updateTreeHorizontalLines, 30);
    });
</script>

<script>
    // Tooltip source: check for inline data-description attribute on the element.
    // Tooltips will only show when a `data-description` attribute is present
    // on a `.class-node` element.

    // Create tooltip element (single reusable)
    const __wikiTooltip = document.createElement('div');
    __wikiTooltip.className = 'class-tooltip';
    document.body.appendChild(__wikiTooltip);

    function showClassTooltip(targetEl) {
        // Use an explicit data-description attribute on the element as the source
        // for the tooltip. Only nodes that include `data-description` will show a tooltip.
        const text = targetEl.getAttribute('data-description');
        if (!text) return;
        __wikiTooltip.innerHTML = text;
        __wikiTooltip.style.display = 'block';
        // Position above the element if enough space, otherwise below
        const rect = targetEl.getBoundingClientRect();
        const ttRect = __wikiTooltip.getBoundingClientRect();
        const margin = 8;
        let top = window.scrollY + rect.top - ttRect.height - margin;
        let left = window.scrollX + rect.left + (rect.width - ttRect.width) / 2;
        // Keep inside viewport horizontally
        const minLeft = 6 + window.scrollX;
        const maxLeft = window.scrollX + document.documentElement.clientWidth - ttRect.width - 6;
        left = Math.max(minLeft, Math.min(maxLeft, left));
        // If not enough space above, place below
        if (top < window.scrollY + 6) {
            top = window.scrollY + rect.bottom + margin;
        }
        __wikiTooltip.style.left = left + 'px';
        __wikiTooltip.style.top = top + 'px';
    }

    function hideClassTooltip() {
        __wikiTooltip.style.display = 'none';
        __wikiTooltip.innerHTML = '';
    }

    // Delegate mouse/focus events for .class-node elements
    document.addEventListener('mouseover', function (e) {
        const el = e.target.closest && e.target.closest('.class-node');
        if (el) {
            showClassTooltip(el);
        }
    });
    document.addEventListener('mouseout', function (e) {
        const related = e.relatedTarget;
        // if leaving to tooltip itself, don't hide
        if (related && (__wikiTooltip === related || __wikiTooltip.contains(related))) return;
        const el = e.target.closest && e.target.closest('.class-node');
        if (el) hideClassTooltip();
    });
    // keyboard accessibility
    document.addEventListener('focusin', function (e) {
        const el = e.target.closest && e.target.closest('.class-node');
        if (el) showClassTooltip(el);
    });
    document.addEventListener('focusout', function (e) {
        const el = e.target.closest && e.target.closest('.class-node');
        if (el) hideClassTooltip();
    });

    // Reposition tooltip on resize/scroll
    window.addEventListener('scroll', function () {
        if (__wikiTooltip.style.display !== 'none') {
            // try to reposition relative to currently active element
            const active = document.querySelector('.class-node:focus, .class-node:hover');
            if (active) showClassTooltip(active);
        }
    }, { passive: true });
    window.addEventListener('resize', function () {
        if (__wikiTooltip.style.display !== 'none') {
            const active = document.querySelector('.class-node:focus, .class-node:hover');
            if (active) showClassTooltip(active);
        }
    });
</script>

    <!-- Modal for NPC search -->
    <div class="modal fade" id="wikiNpcSearchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ phrase('Search NPCs') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <div class="mb-3">
                        <input id="wiki-npc-modal-input" type="search" class="form-control form-control-lg" placeholder="{{ phrase('Type at least X characters to start searching…')|replace({'X': (wiki_min_search_len|default(4))}) }}" autofocus>
                    </div>
                    <div id="wiki-npc-modal-results" style="flex:1 1 auto; min-height:0; overflow:auto; padding-right:6px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Items search -->
    <div class="modal fade" id="wikiItemSearchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ phrase('Search Items') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <div class="mb-3">
                        <input id="wiki-item-modal-input" type="search" class="form-control form-control-lg" placeholder="{{ phrase('Type at least X characters to start searching…')|replace({'X': (wiki_min_search_len|default(4))}) }}" autofocus>
                    </div>
                    <div id="wiki-item-modal-results" style="flex:1 1 auto; min-height:0; overflow:auto; padding-right:6px;"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
// Open modal from sidebar input/button and perform live search inside modal when input length >= configured
(function(){
    const sidebarInput = document.getElementById('wiki-npc-search');
    const openBtn = document.getElementById('wiki-npc-go');
    const modalEl = document.getElementById('wikiNpcSearchModal');
    const modalInputId = 'wiki-npc-modal-input';
    const resultsId = 'wiki-npc-modal-results';
    if(!modalEl) return;

    const bsModal = new bootstrap.Modal(modalEl, { keyboard: true });
    // Backend-provided minimum length (default 4)
    const MIN_LEN = (function(){ try { return Math.max(1, parseInt('{{ wiki_min_search_len|default(4) }}', 10)); } catch(e){ return 4; } })();
    const MSG_SEARCHING = "{{ phrase('Searching…')|e('js') }}";
    const MSG_HINT_INLINE = "{{ phrase('Enter at least X characters to search')|e('js') }}".replace('X', MIN_LEN);
    const MSG_UNEXPECTED = "{{ phrase('Unexpected response')|e('js') }}";
    const MSG_FAILED = "{{ phrase('Search failed')|e('js') }}";
    const MSG_NONE = "{{ phrase('No NPCs found')|e('js') }}";

    let pendingPrefill = null;
    function openModal(prefill){
        pendingPrefill = typeof prefill === 'string' ? prefill : '';
        bsModal.show();
    }

    // Trigger modal on button click or Enter in sidebar input
    openBtn && openBtn.addEventListener('click', function(){ openModal(sidebarInput && sidebarInput.value ? sidebarInput.value : ''); });
    sidebarInput && sidebarInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); openModal(sidebarInput.value); } });

    // Also open modal when user starts typing in the sidebar input so they can continue typing in modal
    let modalOpen = false;
    modalEl.addEventListener('shown.bs.modal', function(){ modalOpen = true; });
    modalEl.addEventListener('hidden.bs.modal', function(){ modalOpen = false; });

    sidebarInput && sidebarInput.addEventListener('input', function(e){
        try {
            const q = (e.target.value || '').trim();
            if(q.length === 0) return; // don't open on empty
            if(modalOpen) return; // already open
            openModal(q);
        } catch (err) { /* ignore */ }
    });

    // Live search inside modal
    let controller = null; let debounceTimer = null;
    function escapeHtml(s){
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        // Use direct literal keys to avoid escaping confusion
        return String(s).replace(/[&<>"']/g, function(c){
            return map[c] || c;
        });
    }
    function renderModalMessage(msg, type='info'){ const el = document.getElementById(resultsId); if(el) el.innerHTML = '<div class="alert alert-' + (type==='error' ? 'danger' : 'info') + ' mb-0' + '">' + msg + '</div>'; }
    function renderModalResults(items){
        const el = document.getElementById(resultsId); if(!el) return; if(!items || !items.length){ renderModalMessage(MSG_NONE); return; }
        const list = document.createElement('div'); list.className = 'list-group';
        items.forEach(it=>{
            const a = document.createElement('a'); a.className = 'list-group-item list-group-item-action'; a.href = '/wiki/npc/id/' + encodeURIComponent(it.id);
            const imgSrc = it.image ? it.image : '/src/component/plugins/wiki/tpl/img/other/nonpc.webp';
            a.innerHTML = '<div class="d-flex align-items-center gap-2">'
                + '<img src="'+escapeHtml(imgSrc)+'" width="48" height="48" class="rounded" style="object-fit:cover;" onerror="this.src=\'/src/component/plugins/wiki/tpl/img/other/nonpc.webp\'" loading="lazy">'
                + '<div class="flex-fill ms-2">'
                    + '<div class="d-flex justify-content-between align-items-start">'
                        + '<div>'
                            + '<div class="fw-semibold">' + escapeHtml(it.name) + '</div>'
                            + '<div class="small text-muted">Lv. ' + escapeHtml(String(it.level)) + '</div>'
                        + '</div>'
                        + '<div class="text-muted small ms-3 text-end">' + escapeHtml(it.type || '') + '</div>'
                    + '</div>'
                + '</div>'
            + '</div>';
            list.appendChild(a);
        });
        el.innerHTML = '';
        el.appendChild(list);
    }

    modalEl.addEventListener('shown.bs.modal', function(){
        const mi = document.getElementById(modalInputId);
        if(!mi) return;
        // attach input handler (ensure single attach by removing first)
        mi.removeEventListener('input', onModalInput);
        mi.addEventListener('input', onModalInput);
        mi.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ bsModal.hide(); } });

        // If we have a pending prefill (opened from sidebar input), populate and focus
        if (pendingPrefill !== null) {
            try {
                mi.value = pendingPrefill || '';
                setTimeout(()=>{
                    try { mi.focus(); mi.setSelectionRange(mi.value.length, mi.value.length); } catch(e){}
                }, 120);
                // trigger immediate search if enough chars
                if ((mi.value || '').trim().length >= MIN_LEN) {
                    doModalSearch(mi.value.trim());
                } else {
                    // show helper message
                    renderModalMessage(MSG_HINT_INLINE);
                }
            } catch (e) { /* ignore */ }
            pendingPrefill = null;
        } else {
            // normal focus
            setTimeout(()=>{ try{ mi.focus(); mi.select(); }catch(e){} }, 80);
        }
    });
    modalEl.addEventListener('hidden.bs.modal', function(){
        const mi = document.getElementById(modalInputId);
        if(mi) mi.removeEventListener('input', onModalInput);
        // abort any ongoing fetch
        if(controller && typeof controller.abort === 'function') try{ controller.abort(); }catch(e){}
        controller = null;
        debounceTimer && clearTimeout(debounceTimer);
    });

    function onModalInput(e){
    const q = (e.target.value || '').trim();
    // mirror the text into the sidebar input
    if (sidebarInput) { try { sidebarInput.value = q; } catch(e){} }
    if(q.length < MIN_LEN){ renderModalMessage(MSG_HINT_INLINE); return; }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=>{ doModalSearch(q); }, 220);
    }

    function doModalSearch(q){
    renderModalMessage(MSG_SEARCHING);
        if(controller && typeof controller.abort === 'function') try{ controller.abort(); }catch(e){}
        controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
    fetch('/wiki/npcs/search?q=' + encodeURIComponent(q), { credentials: 'same-origin', signal: controller ? controller.signal : undefined })
        .then(r=>{ if(!r.ok) throw new Error('network'); return r.json(); })
        .then(json=>{
            if(json && json.items) {
                renderModalResults(json.items);
            } else if(json && json.error) {
                if (json.error === 'too_short') renderModalMessage(MSG_HINT_INLINE);
                else renderModalMessage('Error: '+escapeHtml(json.error),'error');
            } else {
                renderModalMessage(MSG_UNEXPECTED,'error');
            }
        })
        .catch(err=>{ if(err && err.name === 'AbortError') return; renderModalMessage(MSG_FAILED,'error'); });
    }
})();
</script>
<script>
// Open Items search modal and perform live search (same MIN_LEN)
(function(){
    const sidebarInput = document.getElementById('wiki-item-search');
    const openBtn = document.getElementById('wiki-item-go');
    const modalEl = document.getElementById('wikiItemSearchModal');
    const modalInputId = 'wiki-item-modal-input';
    const resultsId = 'wiki-item-modal-results';
    if(!modalEl) return;

    const bsModal = new bootstrap.Modal(modalEl, { keyboard: true });
    const MIN_LEN = (function(){ try { return Math.max(1, parseInt('{{ wiki_min_search_len|default(4) }}', 10)); } catch(e){ return 4; } })();
    const MSG_SEARCHING = "{{ phrase('Searching…')|e('js') }}";
    const MSG_HINT_INLINE = "{{ phrase('Enter at least X characters to search')|e('js') }}".replace('X', MIN_LEN);
    const MSG_UNEXPECTED = "{{ phrase('Unexpected response')|e('js') }}";
    const MSG_FAILED = "{{ phrase('Search failed')|e('js') }}";
    const MSG_NONE = "{{ phrase('No items found')|e('js') }}";

    let pendingPrefill = null;
    function openModal(prefill){ pendingPrefill = typeof prefill === 'string' ? prefill : ''; bsModal.show(); }
    openBtn && openBtn.addEventListener('click', function(){ openModal(sidebarInput && sidebarInput.value ? sidebarInput.value : ''); });
    sidebarInput && sidebarInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); openModal(sidebarInput.value); } });

    // Auto-open when typing
    let modalOpen = false; modalEl.addEventListener('shown.bs.modal', function(){ modalOpen = true; }); modalEl.addEventListener('hidden.bs.modal', function(){ modalOpen = false; });
    sidebarInput && sidebarInput.addEventListener('input', function(e){ const q=(e.target.value||'').trim(); if(q.length===0||modalOpen) return; openModal(q); });

    let controller = null; let debounceTimer = null;
    function escapeHtml(s){ const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }; return String(s).replace(/[&<>"']/g, c=>map[c]||c); }
    function renderModalMessage(msg, type='info'){ const el=document.getElementById(resultsId); if(el) el.innerHTML='<div class="alert alert-'+(type==='error'?'danger':'info')+' mb-0">'+msg+'</div>'; }
    function renderModalResults(items){
        const el=document.getElementById(resultsId); if(!el) return; if(!items||!items.length){ renderModalMessage(MSG_NONE); return; }
        const list=document.createElement('div'); list.className='list-group';
        items.forEach(it=>{
            const a=document.createElement('a'); a.className='list-group-item list-group-item-action'; a.href='/wiki/items/sources/'+ encodeURIComponent(it.id);
            const imgSrc = it.image ? it.image : '/uploads/images/icon/NOIMAGE.webp';
            a.innerHTML = '<div class="d-flex align-items-center gap-2">'
                + '<img src="'+escapeHtml(imgSrc)+'" width="48" height="48" class="rounded" style="object-fit:cover;" onerror="this.src=\'/uploads/images/icon/NOIMAGE.webp\'" loading="lazy">'
                + '<div class="flex-fill ms-2">'
                    + '<div class="d-flex justify-content-between align-items-start">'
                        + '<div>'
                            + '<div class="fw-semibold">' + (it.grade_html ? it.grade_html : '') + ' ' + escapeHtml(it.name) + '</div>'
                            + '<div class="small text-muted">' + escapeHtml(it.type || '') + '</div>'
                        + '</div>'
                    + '</div>'
                + '</div>'
            + '</div>';
            list.appendChild(a);
        });
        el.innerHTML=''; el.appendChild(list);
    }

    function onModalInput(e){ const q=(e.target.value||'').trim(); if(sidebarInput){ try{ sidebarInput.value=q; }catch(e){} } if(q.length<MIN_LEN){ renderModalMessage(MSG_HINT_INLINE); return; } clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>{ doSearch(q); }, 220); }
    function doSearch(q){
        renderModalMessage(MSG_SEARCHING);
        if(controller && typeof controller.abort==='function') try{ controller.abort(); }catch(e){}
        controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
        fetch('/wiki/items/search?q=' + encodeURIComponent(q), { credentials: 'same-origin', signal: controller ? controller.signal : undefined })
            .then(r=>{ if(!r.ok) throw new Error('network'); return r.json(); })
            .then(json=>{
                if(json && json.items){ renderModalResults(json.items); }
                else if(json && json.error){ if(json.error==='too_short') renderModalMessage(MSG_HINT_INLINE); else renderModalMessage('Error: '+escapeHtml(json.error),'error'); }
                else { renderModalMessage(MSG_UNEXPECTED,'error'); }
            })
            .catch(err=>{ if(err && err.name==='AbortError') return; renderModalMessage(MSG_FAILED,'error'); });
    }

    modalEl.addEventListener('shown.bs.modal', function(){
        const mi=document.getElementById(modalInputId); if(!mi) return;
        mi.removeEventListener('input', onModalInput); mi.addEventListener('input', onModalInput);
        mi.addEventListener('keydown', function(e){ if(e.key==='Escape'){ bsModal.hide(); } });
        if(pendingPrefill!==null){ try{ mi.value = pendingPrefill || ''; setTimeout(()=>{ try{ mi.focus(); mi.setSelectionRange(mi.value.length, mi.value.length); }catch(e){} }, 120); if((mi.value||'').trim().length>=MIN_LEN){ doSearch(mi.value.trim()); } else { renderModalMessage(MSG_HINT_INLINE); } } catch(e){} pendingPrefill=null; } else { setTimeout(()=>{ try{ mi.focus(); mi.select(); }catch(e){} }, 80); }
    });
    modalEl.addEventListener('hidden.bs.modal', function(){ const mi=document.getElementById(modalInputId); if(mi) mi.removeEventListener('input', onModalInput); if(controller && typeof controller.abort==='function') try{ controller.abort(); }catch(e){} controller=null; debounceTimer && clearTimeout(debounceTimer); });
})();
</script>
<style>
    /* Make only the results area scrollable to avoid stretching the modal */
    .modal-dialog-scrollable .modal-body { overflow-y: hidden; }
    #wiki-npc-modal-results { overflow: auto; max-height: none; padding-right: 6px; min-height: 96px; }
    #wiki-item-modal-results { overflow: auto; max-height: none; padding-right: 6px; min-height: 96px; }
    /* Ensure inner list doesn't collapse margins */
    #wiki-npc-modal-results .list-group { margin-bottom: 0; }
    #wiki-item-modal-results .list-group { margin-bottom: 0; }
    /* Webkit scrollbar */
    #wiki-npc-modal-results::-webkit-scrollbar { width: 10px; }
    #wiki-npc-modal-results::-webkit-scrollbar-track { background: transparent; }
    #wiki-npc-modal-results::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }
    #wiki-item-modal-results::-webkit-scrollbar { width: 10px; }
    #wiki-item-modal-results::-webkit-scrollbar-track { background: transparent; }
    #wiki-item-modal-results::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }
    /* Firefox */
    #wiki-npc-modal-results { scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.12) transparent; }
    #wiki-item-modal-results { scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.12) transparent; }
    #wiki-npc-modal-results .list-group .list-group-item { padding: 8px 12px; }
    #wiki-item-modal-results .list-group .list-group-item { padding: 8px 12px; }
</style>
{% endblock %}