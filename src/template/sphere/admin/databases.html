{% extends 'struct.html' %}

{% block title %}{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="row">

        <div class="col-xl-12">
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">
                        БД Логина сервера
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-3">
                            <ul class="nav nav-tabs flex-column nav-style-4" role="tablist">
                                {% for i, loginServer in loginServers %}
                                <li class="nav-item" role="presentation">
                                    <a class="loginserver_id_{{loginServer.id}} nav-link {% if i == 0 %}active{% endif %}"
                                       data-bs-toggle="tab" role="tab" aria-current="page"
                                       href="#loginserver_id_{{loginServer.id}}" aria-selected="false" tabindex="-1">LoginServer
                                        ID: {{loginServer.id}}</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-xl-9">
                            <div class="tab-content">
                                {% for i, loginServer in loginServers %}
                                  {% set found = 0 %}
                                  {% for server in getServerAll() %}
                                      {% if server.getLoginId() == loginServer.id %}
                                        {% set found = 1 %}
                                      {% endif %}
                                  {% endfor %}

                                <div class="loginserver_id_{{loginServer.id}} tab-pane text-muted {% if i == 0 %}active show{% endif %}"
                                     id="loginserver_id_{{loginServer.id}}" role="tabpanel">
                                    <div class="col-xl-12">

                                        <nav class="nav nav-style-6 nav-pills mb-3 nav-justified d-sm-flex d-block" role="tablist">
                                            <a class="nav-link active" data-bs-toggle="tab" role="tab" aria-current="page"
                                               href="#nav-db-info_{{loginServer.id}}" aria-selected="false">Информация о базе данных</a>
                                            <a class="nav-link " data-bs-toggle="tab" role="tab"
                                               href="#nav-db-reconnect_{{loginServer.id}}" aria-selected="true">Переподключение к БД <span
                                                  class="badge bg-info-transparent ms-1">Full</span></a>
                                        </nav>
                                        <div class="tab-content">
                                            <div class="tab-pane text-muted show active" id="nav-db-info_{{loginServer.id}}" role="tabpanel">

                                                <div class="">
                                                    <div class="card-header">
                                                        <div class="d-flex w-100">
                                                            <div class="me-4 d-flex align-items-center">
                                                                <i class="ri-database-2-line"></i>
                                                            </div>
                                                            <div class="d-flex align-items-center justify-content-between w-100 flex-wrap">
                                                                <div class="me-3">
                                                                    <p class="text-muted mb-0" role="button"
                                                                       data-bs-original-title="ID LoginServer во внутренней базе SphereAPI"
                                                                       data-bs-toggle="tooltip" data-bs-placement="top">ID</p>
                                                                    <p class="fw-semibold fs-16 mb-0">{{loginServer.id}}</p>
                                                                </div>
                                                                <div class="me-3">
                                                                    <p class="text-muted mb-0" role="button"
                                                                       data-bs-original-title="Кол-во аккаунтов, которые были зарегистрированы или подключены на данный LoginServer (ID:23)"
                                                                       data-bs-toggle="tooltip" data-bs-placement="top">
                                                                        Аккаунтов</p>
                                                                    <p class="fw-semibold fs-16 mb-0">{{loginServer.accountsCount ?? 0}}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="fs-14 fw-semibold mb-0">Подгрузка и выгрузка:</p>
                                                        <p class=" card-text mb-0">Вы можете скачать игровые аккаунты, которые
                                                            привязаны к данному LoginServer, для того чтоб загрузить их в другой
                                                            логин-сервер.</p>

                                                        <div class="btn-group mb-4" role="group"
                                                             aria-label="Basic mixed styles example">

                                                            <button data-loginserverid="{{loginServer.id}}" type="button"
                                                                    class="btn btn-success btn-wave waves-effect waves-light downloadAccounts show_accounts_login_server">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                                     stroke-width="2" stroke-linecap="round"
                                                                     stroke-linejoin="round"
                                                                     class="icon icon-tabler icons-tabler-outline icon-tabler-database-import">
                                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                    <path d="M4 6c0 1.657 3.582 3 8 3s8 -1.343 8 -3s-3.582 -3 -8 -3s-8 1.343 -8 3"/>
                                                                    <path d="M4 6v6c0 1.657 3.582 3 8 3c.856 0 1.68 -.05 2.454 -.144m5.546 -2.856v-6"/>
                                                                    <path d="M4 12v6c0 1.657 3.582 3 8 3c.171 0 .341 -.002 .51 -.006"/>
                                                                    <path d="M19 22v-6"/>
                                                                    <path d="M22 19l-3 -3l-3 3"/>
                                                                </svg>
                                                                Скачать базу аккаунтов логина
                                                            </button>

                                                            <button data-connect-server="{{found}}" data-loginserverid="{{loginServer.id}}"  type="button"
                                                                    class="btn btn-info btn-wave waves-effect waves-light loadAccountsToSphere">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                                     stroke-width="2" stroke-linecap="round"
                                                                     stroke-linejoin="round"
                                                                     class="icon icon-tabler icons-tabler-outline icon-tabler-package-export">
                                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                    <path d="M12 21l-8 -4.5v-9l8 -4.5l8 4.5v4.5"/>
                                                                    <path d="M12 12l8 -4.5"/>
                                                                    <path d="M12 12v9"/>
                                                                    <path d="M12 12l-8 -4.5"/>
                                                                    <path d="M15 18h7"/>
                                                                    <path d="M19 15l3 3l-3 3"/>
                                                                </svg>
                                                                Загрузить базу аккаунтов в логин
                                                            </button>
                                                        </div>
                                                        <input type="file" id="file-input" accept=".zip,.json">


                                                        <div class="fw-semibold fs-16 ">Коннект к LoginServer</div>
                                                        <div class="text-muted fs-11 ">Если Вам больше не нужен данные к
                                                            подключение к этому логин-серверу, вы можете удалить его.
                                                            После удаления, вы не сможете подключиться к этому логин-серверу,
                                                            все аккаунты, которые были зарегистрированы на этом логин-сервере,
                                                            будут удалены.<br>
                                                            Рекомендуется удалить, если Вы больше не будете использовать данный
                                                            логин-сервер.
                                                        </div>



                                                        {% if found %}
                                                            <div class="fw-semibold fs-14 text-success">
                                                            Внимание: Логин-сервер подключен к серверу - {{server.getName()}}
                                                            {{server.getRateExp()}} {{server.getChronicle()}}
                                                            </div>
                                                        {% else %}
                                                        <div class="fw-semibold fs-14 text-danger">
                                                            Внимание: Данный Логин-сервер не используется ни одним из Ваших
                                                            серверов.
                                                        </div>
                                                        {% endif %}

                                                        <button class="btn btn-sm btn-danger deleteLoginServer"
                                                                data-login-id="{{loginServer.id}}" data-bs-toggle="tooltip"
                                                                data-bs-placement="top" data-bs-title="Ещё не работает...">
                                                            <i class="ri-delete-bin-line"></i> Удаление
                                                        </button>

                                                    </div>
                                                </div>
                                                
                                            </div>
                                            <div class="tab-pane text-muted" id="nav-db-reconnect_{{loginServer.id}}"
                                                 role="tabpanel">

                                                <div class="row gy-3">

                                                    <div class="col-xl-12">
                                                        <label for="login_host_{{loginServer.id}}" class="form-label">IP</label>
                                                        <input value="{{loginServer.host}}" type="text" class="form-control form-control-sm rounded-0" id="login_host_{{loginServer.id}}" placeholder="172.217.17.110">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="login_port_{{loginServer.id}}" class="form-label">Port</label>
                                                        <input type="text" class="form-control form-control-sm rounded-0" id="login_port_{{loginServer.id}}" value="{{loginServer.port}}" placeholder="3306">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="login_user_{{loginServer.id}}" class="form-label">User</label>
                                                        <input value="{{loginServer.user}}" type="text" class="form-control form-control-sm rounded-0" id="login_user_{{loginServer.id}}" placeholder="root">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="login_password_{{loginServer.id}}" class="form-label">Password</label>
                                                        <input type="text" class="form-control form-control-sm rounded-0" id="login_password_{{loginServer.id}}" placeholder="password">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <button id="getDBNameLogin" data-login-id="{{loginServer.id}}" type="button" class="btn btn-primary btn-sm">Загрузить список серверов</button>
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <select id="login_name_{{loginServer.id}}" class="form-select form-control-sm" aria-label="Select DB">
                                                            <option value="{{loginServer.name}}" disabled selected>{{loginServer.name}}</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <button data-login-id="{{loginServer.id}}" id="refresh_login_server" type="button" class="btn btn-primary btn-sm mb-3">Обновить БД</button>
                                                    </div>

                                                </div>

                                            </div>
                                           
                                            </div>




                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

    <div id="importProgressContainer" class="mt-3" style="display: none;">
  <div class="mb-1">
    <span id="importProgressLabel" class="fw-semibold">Импорт аккаунтов: 0%</span>
  </div>
  <div class="progress" style="height: 22px;">
    <div
          id="importProgressBar"
          class="progress-bar progress-bar-striped progress-bar-animated"
          role="progressbar"
          style="width: 0%; transition: width 0.6s ease;">
      0%
    </div>
  </div>
</div>
                </div>
            </div>
        </div>


        <div class="col-xl-12">
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">
                        БД Гейм сервера
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-3">
                            <ul class="nav nav-tabs flex-column nav-style-4" role="tablist">
                                {% for i, gameServer in gameServers %}
                                <li class="nav-item" role="presentation">
                                    <a class="gameServer_id_{{gameServer.id}} nav-link {% if i == 0 %}active{% endif %}"
                                       data-bs-toggle="tab" role="tab" aria-current="page"
                                       href="#gameServer_id_{{gameServer.id}}" aria-selected="false" tabindex="-1">GameServer
                                        ID: {{gameServer.id}}</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-xl-9">
                            <div class="tab-content">
                                {% for i, gameServer in gameServers %}
                                <div class="gameServer_id_{{gameServer.id}} tab-pane text-muted {% if i == 0 %}active show{% endif %}"
                                     id="gameServer_id_{{gameServer.id}}" role="tabpanel">
                                    <div class="col-xl-12">

                                        <nav class="nav nav-style-6 nav-pills mb-3 nav-justified d-sm-flex d-block" role="tablist">
                                            <a class="nav-link active" data-bs-toggle="tab" role="tab" aria-current="page"
                                               href="#nav-db-info-game_{{gameServer.id}}" aria-selected="false">Информация о базе данных</a>
                                            <a class="nav-link " data-bs-toggle="tab" role="tab"
                                               href="#nav-db-reconnect-game_{{gameServer.id}}" aria-selected="true">Переподключение к БД <span
                                                  class="badge bg-info-transparent ms-1">Full</span></a>
                                        </nav>
                                        <div class="tab-content">
                                            <div class="tab-pane text-muted show active" id="nav-db-info-game_{{gameServer.id}}" role="tabpanel">

                                                <div class="">
                                                    <div class="card-header">
                                                        <div class="d-flex w-100">
                                                            <div class="me-4 d-flex align-items-center">
                                                                <i class="ri-database-2-line"></i>
                                                            </div>
                                                            <div class="d-flex align-items-center justify-content-between w-100 flex-wrap">
                                                                <div class="me-3">
                                                                    <p class="text-muted mb-0" role="button"
                                                                       data-bs-original-title="ID GameServer во внутренней базе SphereAPI"
                                                                       data-bs-toggle="tooltip" data-bs-placement="top">ID</p>
                                                                    <p class="fw-semibold fs-16 mb-0">{{gameServer.id}}</p>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">


                                                        <div class="fw-semibold fs-14 text-danger mb-3">
                                                            Если Вам больше не нужен данный гейм-сервер, можете удалить его из Sphere.
                                                        </div>

                                                        <button class="btn btn-sm btn-danger deleteGameServer" data-game-id="{{gameServer.id}}" >
                                                            <i class="ri-delete-bin-line"></i> Удаление
                                                        </button>

                                                    </div>
                                                </div>

                                            </div>
                                            <div class="tab-pane text-muted" id="nav-db-reconnect-game_{{gameServer.id}}"
                                                 role="tabpanel">

                                                <div class="row gy-3">

                                                    <div class="col-xl-12">
                                                        <label for="game_host_{{gameServer.id}}" class="form-label">IP</label>
                                                        <input value="{{gameServer.host}}" type="text" class="form-control form-control-sm rounded-0" id="game_host_{{gameServer.id}}" placeholder="172.217.17.110">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="game_port_{{gameServer.id}}" class="form-label">Port</label>
                                                        <input type="text" class="form-control form-control-sm rounded-0" id="game_port_{{gameServer.id}}" value="{{gameServer.port}}" placeholder="3306">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="game_user_{{gameServer.id}}" class="form-label">User</label>
                                                        <input value="{{gameServer.user}}" type="text" class="form-control form-control-sm rounded-0" id="game_user_{{gameServer.id}}" placeholder="root">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <label for="game_password_{{gameServer.id}}" class="form-label">Password</label>
                                                        <input type="text" class="form-control form-control-sm rounded-0" id="game_password_{{gameServer.id}}" placeholder="password">
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <button id="getDBNameGame" data-game-id="{{gameServer.id}}" type="button" class="btn btn-primary btn-sm">Загрузить список серверов</button>
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <select id="game_name_{{gameServer.id}}" class="form-select form-control-sm" aria-label="Select DB">
                                                            <option value="{{gameServer.name}}" disabled selected>{{gameServer.name}}</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-xl-12">
                                                        <button data-game-id="{{gameServer.id}}" id="refresh_game_server" type="button" class="btn btn-primary btn-sm mb-3">Обновить БД</button>
                                                    </div>

                                                </div>

                                            </div>

                                        </div>




                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>


</div>




{% endblock %}

{% block css %}
<style>
    #file-input {
        display: none; /* Прячем его, чтобы не мозолил глаза */
    }
</style>
<link rel="stylesheet" href="{{template}}/assets/libs/sweetalert2/sweetalert2.min.css">
{% endblock %}

{% block js %}
<!-- Bootstrap Modal -->
<div class="modal fade" id="accountsModal" tabindex="-1" aria-labelledby="accountsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountsModalLabel">LoginServer Player Accounts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="accounts_list" rows="14"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" id="copyAccounts" class="btn btn-secondary">
                    <i class="fe fe-copy"></i> Скопировать
                </button>
                <button type="button" id="downloadAccounts" class="btn btn-primary">
                    <i class="fe fe-download"></i> Скачать
                </button>
            </div>
        </div>
    </div>
</div>


<script src="{{template}}/assets/libs/sweetalert2/sweetalert2.min.js"></script>
<script>
    $(document).ready(function () {
        const collectionInfo = JSON.parse('{{collections|raw}}');

        $(".deleteGameServer").on("click", function () {
            let gameServerId = $(this).attr("data-game-id");
            let panel = $(".gameServer_id_" + gameServerId);
            AjaxSend("/admin/database/delete", "POST", {
                type: "game",
                id: gameServerId,
            }, true).then(function (data) {
                response(data);

                // Проверяем, является ли удаляемая панель активной
                if (panel.hasClass("active show")) {
                    // Получаем следующую панель, которая будет активной
                    let nextPanel = panel.next(".tab-pane");
                    if (nextPanel.length === 0) {
                        nextPanel = panel.prev(".tab-pane");
                    }

                    // Переключаем классы active и show
                    if (nextPanel.length > 0) {
                        $(".nav-link.active").removeClass("active");
                        $(".tab-pane.active.show").removeClass("active show");
                        nextPanel.addClass("active show");
                        $(".nav-link[data-bs-toggle='tab'][href='#" + nextPanel.attr("id") + "']").addClass("active");
                    }
                }
                panel.fadeOut(500, function () {
                    location.reload();
                    $(this).remove();
                });
            })
        });

        $(".deleteLoginServer").on("click", function () {
            let loginServerId = $(this).attr("data-login-id");
            let panel = $(".loginserver_id_" + loginServerId);

            AjaxSend("/admin/database/delete", "POST", {
                type: "login",
                id: loginServerId,
            }, true).then(function (data) {
                response(data);

                // Проверяем, является ли удаляемая панель активной
                if (panel.hasClass("active show")) {
                    // Получаем следующую панель, которая будет активной
                    let nextPanel = panel.next(".tab-pane");
                    if (nextPanel.length === 0) {
                        nextPanel = panel.prev(".tab-pane");
                    }

                    // Переключаем классы active и show
                    if (nextPanel.length > 0) {
                        $(".nav-link.active").removeClass("active");
                        $(".tab-pane.active.show").removeClass("active show");
                        nextPanel.addClass("active show");
                        $(".nav-link[data-bs-toggle='tab'][href='#" + nextPanel.attr("id") + "']").addClass("active");
                    }
                }

                // Добавляем анимацию исчезновения перед удалением
                panel.fadeOut(500, function () {
                    location.reload()
                    $(this).remove();
                });
            })
        });


        $("#copyAccounts").on("click", function () {
            const text = $("#accounts_list").val();
            navigator.clipboard.writeText(text).then(() => {
                alert("Текст скопирован в буфер обмена.");
            }).catch(() => {
                alert("Не удалось скопировать текст.");
            });
        });


        $(".downloadAccounts").on("click", function () {
            const $button = $(this);
            const originalText = $button.html();
            $button.prop("disabled", true).html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Загрузка...
    `);

            const loginId = $button.attr('data-loginserverid');

            fetch("/admin/database/account/download", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ loginId: loginId })
            }).then(response => response.json())
                  .then(data => {
                      console.log(data);

                      // Заполняем textarea списком аккаунтов
                      const accountsData = data.map(item =>
                            `${item.email}:${item.login}:${item.password}`
                      ).join('\n');

                      $("#accounts_list").val(accountsData);

                      // Открываем модальное окно Bootstrap
                      let accountsModal = new bootstrap.Modal(document.getElementById('accountsModal'));
                      accountsModal.show();
                  })
                  .catch(error => {
                      console.error("Ошибка:", error);
                  })
                  .finally(() => {
                      $button.prop("disabled", false).html(originalText);
                  });
        });

        $("#downloadAccounts").on("click", function () {
            const text = $("#accounts_list").val();
            const blob = new Blob([text], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "accounts_list.txt";
            link.click();
            URL.revokeObjectURL(link.href);
        });

        $(document).on("click", ".loadAccountsToSphere", function () {

            const loginId = $(this).attr('data-loginserverid');
            const connectServer = $(this).attr('data-connect-server');

            let additionalFields = '';
            if (connectServer === "0") {
                additionalFields = `
                    <div class="mb-3">
                        <label for="version_client" class="form-label">Chronicle</label>
                        <select class="form-control" id="version_client">
                            {% for client in client_list_default %}
                            <option data-protocol='{{ client.protocol|json_encode }}'>{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="collection" class="form-label">Сборка сервера</label>
                        <select class="form-control" id="collection"></select>
                    </div>
                `;
            }

            $(".loadAccountsToSphere").on("click", function () {
                const loginId = $(this).attr('data-loginserverid');
                Swal.fire({
                    title: '<strong>LoginServer Player Accounts</strong>',
                    icon: 'success',
                    html: `
<div id="swal-content">
                        ${additionalFields}
                    </div>
      <div class="col-xl-12 mb-3">
          <input type="file" class="form-control mb-2" id="fileInput">
          <textarea class="form-control" id="import_accounts" rows="14" placeholder="Содержимое файла появится здесь..."></textarea>
      </div>
      <div class="progress">
          <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
      </div>
    `,
                    showCloseButton: true,
                    showCancelButton: true,
                    focusConfirm: false,
                    confirmButtonText: '<i class="fe fe-download"></i> Начать импортирование',
                }).then((result) => {
                    if (result.isConfirmed) {
                        noticeSuccess("Началось загрузка аккаунтов. Ожидайте.");
                        const collection = $("#collection").val();
                        $.ajax({
                            url: "/admin/database/account/load",
                            method: "POST",
                            data: {
                                loginId: loginId,
                                collection: collection,
                                file: $("#import_accounts").val()
                            },
                            dataType: "json",
                            success: function (response) {
                                console.log(response)
                                pollProgress();
                            },
                            error: function () {
                                // Обрабатываем ошибку
                                noticeError("Произошла ошибка при загрузке аккаунтов.");
                            }
                        });
                    }
                });
            });

            });

        function updateCollections(selectedProtocols) {
            const $collectionSelect = $('#collection');

            if (!$collectionSelect.length) {
                console.error("Не найден элемент #collection");
                return;
            }

            // Проверяем и исправляем видимость селекта
            if ($collectionSelect.css('display') === 'none') {
                $collectionSelect.css('display', 'block');
            }

            // Проверяем все родительские элементы на видимость
            $collectionSelect.parents().each(function() {
                if ($(this).css('display') === 'none') {
                    $(this).css('display', 'block');
                }
            });

            $collectionSelect.empty();

            if (!selectedProtocols) {
                console.warn("Не переданы протоколы хроник");
                return;
            }

            try {
                const protocols = JSON.parse(selectedProtocols);
                console.log("Выбраны протоколы:", protocols);

                const availableCollections = collectionInfo.filter(collection =>
                      collection.protocols.some(p => protocols.includes(p))
                );

                if (availableCollections.length > 0) {
                    const $fragment = $(document.createDocumentFragment());

                    availableCollections.forEach(collection => {
                        $('<option>', {
                            value: collection.name,
                            text: collection.name
                        }).appendTo($fragment);
                    });

                    $collectionSelect
                          .append($fragment)
                          .trigger('change')
                          .show(); // Явно показываем селект

                    // Проверяем видимость после обновления
                    console.log("Селект виден после обновления:", $collectionSelect.is(':visible'));
                    console.log("Стиль display:", $collectionSelect.css('display'));
                } else {
                    $('<option>', {
                        value: '',
                        text: 'Нет доступных сборок',
                        selected: true,
                        disabled: true
                    }).appendTo($collectionSelect);
                }

            } catch (error) {
                console.error("Ошибка обработки протоколов:", error);
            }
        }


        // Добавьте эту функцию для проверки всех свойств, влияющих на видимость
        function checkVisibilityIssues($element) {
            const styles = {
                display: $element.css('display'),
                visibility: $element.css('visibility'),
                opacity: $element.css('opacity'),
                height: $element.css('height'),
                position: $element.css('position'),
                zIndex: $element.css('z-index')
            };

            console.log("Стили элемента:", styles);

            // Исправляем возможные проблемы
            if (styles.visibility === 'hidden') {
                $element.css('visibility', 'visible');
            }
            if (styles.opacity === '0') {
                $element.css('opacity', '1');
            }
            if (styles.height === '0px') {
                $element.css('height', 'auto');
            }
        }



        $(document).on('change', '#version_client', function() {
            const protocols = $(this).find('option:selected').attr('data-protocol');
            updateCollections(protocols);
        });

        $(document).on("change", "#fileInput", function () {
            const file = this.files[0];
            if (!file) {
                noticeError("Выберите файл для загрузки.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                $("#import_accounts").val(e.target.result);
            };
            reader.onerror = function () {
                noticeError("Не удалось прочитать файл.");
            };
            reader.readAsText(file);
        });

        function pollProgress() {
            // Показываем контейнер прогресса, если он ещё скрыт
            $("#importProgressContainer").fadeIn();

            $.ajax({
                url: "/admin/database/account/load/progress",
                method: "POST",
                data: {},
                dataType: "json",
                success: function (data) {
                    const total = data.total || 0;
                    const processed = data.processed || 0;
                    const percent = total ? ((processed / total) * 100).toFixed(2) : 0;

                    // Обновляем прогресс-бар и текстовую метку
                    $("#importProgressBar")
                          .css("width", percent + "%")
                          .text(percent + "%");
                    $("#importProgressLabel").text(`Импорт аккаунтов: ${percent}%`);

                    // Если импорт не закончен, продолжаем опрос
                    if (data.completed === 1) {
                        setTimeout(pollProgress, 1000);
                    }
                    // Когда completed === 2, считаем, что всё готово
                    else if (data.completed === 2) {
                        console.log("Импорт завершён");
                        $("#importProgressBar").css("width", "100%").text("100%");
                        $("#importProgressLabel").text("Импорт завершён на 100%");

                        // Дополнительно можете скрыть панель или вывести другое сообщение
                        // Например:
                        // setTimeout(() => {
                        //   $("#importProgressContainer").fadeOut();
                        // }, 3000);
                    }
                },
                error: function (err) {
                    console.error("Ошибка опроса прогресса", err);
                    // В случае ошибки тоже можно повторить опрос через 1-2 секунды, если нужно
                    setTimeout(pollProgress, 2000);
                }
            });
        }



    });


    $(document).on('click', '#getDBNameLogin', function (event) {
        let loginId = $(this).attr('data-login-id');

        let host = $("#login_host_" + loginId).val();
        let port = $("#login_port_" + loginId).val();
        let user = $("#login_user_" + loginId).val();
        let password = $("#login_password_" + loginId).val();

        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": host,
                "port": port,
                "user": user,
                "password": password,
            },
            dataType: 'json',
            success: function (response) {
                $("#login_name").empty();
                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        return;
                    }
                }
                $.each(response['databases'], function (index, value) {
                    let isDisabled = "";
                    if (value === "information_schema" || value === "mysql" || value === "performance_schema" || value === "sys") {
                        isDisabled = "disabled";
                    }
                    $("#login_name").append('<option value="' + value + '" ' + isDisabled + '>' + value + '</option>');
                });
            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
            }
        })
    });

    $(document).on('click', '#getDBNameGame', function (event) {
        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": $("#game_host").val(),
                "port": $("#game_port").val(),
                "user": $("#game_user").val(),
                "password": $("#game_password").val(),
            },
            dataType: 'json',
            success: function (response) {
                $("#game_name").empty();

                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        return;
                    }
                }
                $.each(response['databases'], function (index, value) {
                    $("#game_name").append('<option value="' + value + '">' + value + '</option>');
                });

            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
            }
        })
    });

    $("#refresh_login_server").on("click", function () {
        let loginId = $(this).attr('data-login-id');
        let host = $("#login_host_" + loginId).val();
        let port = $("#login_port_" + loginId).val();
        let user = $("#login_user_" + loginId).val();
        let password = $("#login_password_" + loginId).val();
        let name = $("#login_name_" + loginId).text().trim();
        AjaxSend("/api/server/update/loginserver", "POST", {
            loginId: loginId,
            host: host,
            port: port,
            user: user,
            password: password,
            name: name
        },);
    })

</script>


{% endblock %}