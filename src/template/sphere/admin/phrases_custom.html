{% extends 'struct.html' %}

{% block title %}Phrases{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="row">

    <div class="col-xxl-12 col-xl-12 col-lg-12 col-md-12 col-sm-12">
      <div class="card custom-card">
        <div class="card-header justify-content-between">
          <div class="card-title">
            <a href="/admin" class="avatar border text-muted me-2">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM12 20C16.42 20 20 16.42 20 12C20 7.58 16.42 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20ZM12 11H16V13H12V16L8 12L12 8V11Z"></path></svg>
            </a>
            {{ phrase('lang') }}
          </div>
        </div>


        <div class="card-body">

          Язык который требуется добавить
          <select class="form-select" id="country" name="country">
            <option value="ru">Русский</option>
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="pt">Português</option>
            <option value="ua">Українська</option>
            <option value="gr">Greek</option>
          </select>

          <button id="addNewTableLang" type="submit" class="btn btn-primary">Добавить перевод</button>

        </div>


      </div>
    </div>

  </div>

  <div class="row">
    <div class="col-xl-12">
      <div class="card custom-card">
        <div class="card-header">
          <div class="">
            <button id="add_new_phrase" class="btn btn-sm btn-primary-light">{{ phrase('add_phrase') }}</button>
          </div>

          <div class="">
            <button id="save_phrases" class="btn btn-sm btn-primary-light">{{ phrase('save_table') }}</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table id="phraseDataTable" class="table table-bordered  w-100 text-wrap">

              <thead>

              <tr>
                <th data-save="false" style="width: 1px;"></th>
                <th data-save="false">{{phrase('key')}}</th>
                <th data-save="false">Translations</th>
              </tr>

              </thead>

              {% for key, phrases in all_phrase_custom().phrases %}
              <tr>
                <td>
                  <div class="dropdown">
                    <a aria-label="anchor" class="nav-link text-muted" href="javascript:void(0);"
                       data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i
                      class="fe fe-more-vertical"></i></a>
                    <div class="dropdown-menu dropdown-menu-end" style="">


                      <a class="dropdown-item d-inline-flex align-items-center copy" href="javascript:void(0)"><i
                        class="fe fe-copy me-2"></i>{% verbatim %}{{ phrase({% endverbatim %}{% if is_numeric(key) %}{{
                        key }}{% else %}'{{ key }}'{% endif %}{% verbatim %}) }}{% endverbatim %}</a></a>
                      <a class="dropdown-item d-inline-flex align-items-center" href="javascript:void(0)"><i
                        class="fe fe-corner-up-left me-2"></i> Reply</a>
                      <a class="dropdown-item d-inline-flex align-items-center" href="javascript:void(0)"><i
                        class="fe fe-flag me-2"></i> Report Abuse</a>
                      <a class="dropdown-item d-inline-flex align-items-center removePhrase" data-key="{{key}}" href="javascript:void(0)"><i
                        class="fe fe-trash-2 me-2"></i> Delete</a>
                    </div>
                  </div>
                </td>
                <td>{{ key }}</td>
                <td>
                  <div class="phrase-grid">
                    {% for lang, phrase in phrases %}
                    <div class="phrase-field" data-lang="{{lang}}">
                      <div class="phrase-field-label">{{lang|upper}}</div>
                      <div class="phrase-field-value" data-lang="{{lang}}">{{ phrase ?? '' }}</div>
                    </div>
                    {% endfor %}
                  </div>
                </td>
              </tr>
              {% endfor %}

            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End:: row-2 -->

</div>

{% endblock %}


{% block css %}

<style>
  /* Сетка переводов внутри одной колонки, чтобы таблица не растягивалась по ширине */
  .phrase-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: .5rem;
  }

  .phrase-field {
    border: 1px solid var(--bs-border-color);
    border-radius: .375rem;
    padding: .5rem;
    background: var(--bs-body-bg);
  }

  .phrase-field-label {
    font-size: .75rem;
    font-weight: 600;
    opacity: .8;
    margin-bottom: .25rem;
  }

  .phrase-field-value {
    min-height: 38px;
    white-space: pre-wrap;
    word-break: break-word;
    cursor: text;
  }

  .phrase-field textarea.form-control {
    min-height: 70px;
  }
</style>

{% endblock %}

{% block js %}
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="{{template}}/assets/js/datatables.js"></script>

<script>

  $(document).ready(function () {

    // Список языков из бекенда (то, что уже есть в таблице при загрузке)
    var initialLangs = {{ all_phrase_custom().lang_list|json_encode|raw }};
    var knownLangs = new Set(Array.isArray(initialLangs) ? initialLangs : []);

    // Убираем из select уже существующие языки
    knownLangs.forEach(function(lang) {
      $('#country option[value="' + lang + '"]').remove();
    });

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function getRowKey($row) {
      var $keyCell = $row.find('td').eq(1);
      var $input = $keyCell.find('input, textarea');
      if ($input.length) {
        return ($input.val() || '').trim();
      }
      return ($keyCell.text() || '').trim();
    }

    function buildPhraseField(lang, value, asTextarea) {
      var label = String(lang).toUpperCase();
      var safeValue = value == null ? '' : String(value);
      if (asTextarea) {
        return (
          '<div class="phrase-field" data-lang="' + escapeHtml(lang) + '">' +
            '<div class="phrase-field-label">' + escapeHtml(label) + '</div>' +
            '<textarea class="form-control phrase-input" data-lang="' + escapeHtml(lang) + '" placeholder="' + escapeHtml(label) + '">' +
              escapeHtml(safeValue) +
            '</textarea>' +
          '</div>'
        );
      }
      return (
        '<div class="phrase-field" data-lang="' + escapeHtml(lang) + '">' +
          '<div class="phrase-field-label">' + escapeHtml(label) + '</div>' +
          '<div class="phrase-field-value" data-lang="' + escapeHtml(lang) + '">' + escapeHtml(safeValue) + '</div>' +
        '</div>'
      );
    }

    function ensureFieldExists($row, lang, valueForSpecialLangName) {
      var $grid = $row.find('.phrase-grid');
      if (!$grid.length) return;
      if ($grid.find('.phrase-field[data-lang="' + lang + '"]').length) return;

      var key = getRowKey($row);
      var value = '';
      if (key === 'lang_name' && valueForSpecialLangName != null) {
        value = valueForSpecialLangName;
      }

      var isNewRow = $row.hasClass('phrase-row-new');
      $grid.append(buildPhraseField(lang, value, isNewRow));
    }

    // Удаление строки
    $(document).on('click', '.removePhrase', function() {
      $(this).closest('tr').remove();
    });

    // Добавить язык (не колонки, а поля внутри сетки)
    $('#addNewTableLang').on('click', function() {
      var newLang = $('#country').val();
      var newLangName = $('#country option:selected').text();
      if (!newLang) return;

      if ($('.phrase-grid .phrase-field[data-lang="' + newLang + '"]').length > 0) {
        alert('Этот язык уже существует в таблице!');
        return;
      }

      knownLangs.add(newLang);

      $('#phraseDataTable tbody tr').each(function() {
        ensureFieldExists($(this), newLang, newLangName);
      });

      $('#country option[value="' + newLang + '"]').remove();
    });

    // Копирование
    $(document).on('click','.copy',  function () {
      var textToCopy = $(this).text().trim();
      navigator.clipboard.writeText(textToCopy).then(function () { }).catch(function (error) {
        console.error("Ошибка при копировании: ", error);
      });
    });

    // DataTable
    $('#phraseDataTable').DataTable({
      responsive: false,
      autoWidth: true,
      lengthChange: false,
      pageLength: 3000,
      searching: false,
      ordering: false
    });

    // Сохранение
    $('#save_phrases').click(function () {
      var data = {};

      $('#phraseDataTable tbody tr').each(function () {
        var $row = $(this);
        var key = getRowKey($row);
        if (!key) return;

        var row_data = {};
        $row.find('.phrase-field').each(function() {
          var lang = ($(this).data('lang') || '').toString().trim().toLowerCase();
          if (!lang) return;

          var $textarea = $(this).find('textarea.phrase-input');
          if ($textarea.length) {
            row_data[lang] = ($textarea.val() || '').trim();
            return;
          }

          var $value = $(this).find('.phrase-field-value');
          row_data[lang] = ($value.text() || '').trim();
        });

        if (Object.keys(row_data).length > 0) {
          data[key] = row_data;
        }
      });

      var jsonData = JSON.stringify(data);
      AjaxSend("/admin/phrases/custom", "POST", {phrases: jsonData}, false)
    });

    // Добавить новую фразу
    $('#add_new_phrase').click(function () {
      var newRow = $('<tr>');
      newRow.addClass('phrase-row-new');

      // Добавляем кнопку в первую колонку
      var dropdownCell = `
        <td>
            <div class="dropdown">
                <a aria-label="anchor" class="nav-link text-muted" href="javascript:void(0);"
                   data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   <i class="fe fe-more-vertical"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-end" style="">
                    <a class="dropdown-item d-inline-flex align-items-center copy" href="javascript:void(0)">
                        <i class="fe fe-copy me-2"></i><span class="dropdown-key"></span>
                    </a>
                </div>
            </div>
        </td>`;
      newRow.append(dropdownCell);

      // Ключ
      newRow.append('<td><input type="text" class="form-control phrase-key-input" placeholder="{{phrase('key')}}" /></td>');

      // Переводы
      var $translationsCell = $('<td>');
      var $grid = $('<div class="phrase-grid">');
      Array.from(knownLangs).forEach(function(lang) {
        $grid.append(buildPhraseField(lang, '', true));
      });
      $translationsCell.append($grid);
      newRow.append($translationsCell);

      $('#phraseDataTable tbody').prepend(newRow);

      newRow.find('.phrase-key-input').focus();
      newRow.find('.phrase-key-input').on('input', function() {
        var keyValue = ($(this).val() || '').trim();
        var updatedText = keyValue
          ? "{% verbatim %}{{ phrase('{% endverbatim %}" + keyValue + "{% verbatim %}') }}{% endverbatim %}"
          : '';
        newRow.find('.dropdown-key').text(updatedText);
        newRow.find('a').attr('aria-label', updatedText);
      });
    });

    // Редактирование перевода по клику (для существующих строк)
    $('#phraseDataTable').on('click', '.phrase-field-value', function (e) {
      var $value = $(this);
      var $field = $value.closest('.phrase-field');

      if ($field.find('textarea.phrase-input').length) return;

      var original = $value.text();
      $field.data('original-text', original);
      $value.replaceWith($('<textarea class="form-control phrase-input">').val(original));
      $field.find('textarea.phrase-input').focus();
      e.stopPropagation();
    });

    $('#phraseDataTable').on('keydown', 'textarea.phrase-input', function (e) {
      var $textarea = $(this);
      var $field = $textarea.closest('.phrase-field');

      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        $textarea.blur();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        var originalText = $field.data('original-text') || '';
        $textarea.replaceWith($('<div class="phrase-field-value">').text(originalText));
      }
    });

    $('#phraseDataTable').on('blur', 'textarea.phrase-input', function () {
      var $textarea = $(this);
      var $field = $textarea.closest('.phrase-field');
      if ($field.closest('tr').hasClass('phrase-row-new')) {
        return;
      }

      var value = $textarea.val();
      $textarea.replaceWith($('<div class="phrase-field-value">').text(value));
    });

    $('#phraseDataTable').on('click', 'textarea.phrase-input', function (e) {
      e.stopPropagation();
    });
  });

</script>
{% endblock %}
