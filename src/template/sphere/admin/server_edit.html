{% extends 'struct.html' %}

{% block title %}Изменение данных сервера{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="row">
        <div class="col-xl-12">
            <div class="card custom-card">
                <form action="/admin/create/server/edit" method="POST" class="card-body add-products p-0">
                    <div class="p-4">
                        <div class="row gx-5">
                            <div class="col-xxl-6 col-xl-12 col-lg-12 col-md-6">
                                <div class="card custom-card shadow-none mb-0 border-0">
                                    <div class="card-body p-0">
                                        <div class="row gy-3">
                                            <input name="id" type="hidden" value="{{server.getId()}}">
                                            <div class="col-xl-3">
                                                <label for="name" class="form-label">Название сервера</label>
                                                <input name="name" type="text" class="form-control" id="name"
                                                    value="{{server.getName()}}" placeholder="Name">
                                            </div>
                                            <div class="col-xl-2">
                                                <label for="rateExp" class="form-label">RateExp</label>
                                                <input name="rateExp" type="number" class="form-control" id="rateExp"
                                                    value="{{server.getRateExp()}}" placeholder="1200">
                                            </div>
                                            <div class="col-xl-2">
                                                <label for="rateSp" class="form-label">RateSp</label>
                                                <input name="rateSp" type="number" class="form-control" id="rateSp"
                                                    value="{{server.getRateSp()}}" placeholder="10">
                                            </div>
                                            <div class="col-xl-2">
                                                <label for="rateAdena" class="form-label">RateAdena</label>
                                                <input name="rateAdena" type="number" class="form-control"
                                                    id="rateAdena" value="{{server.getRateAdena()}}" placeholder="10">
                                            </div>
                                            <div class="col-xl-2">
                                                <label for="rateDrop" class="form-label">RateDrop</label>
                                                <input name="rateDrop" type="number" class="form-control" id="rateDrop"
                                                    value="{{server.getRateDrop()}}" placeholder="1">
                                            </div>

                                            <div class="col-xl-2">
                                                <label for="platform" class="form-label">Platform</label>
                                                <select class="form-control" data-trigger name="platform" id="platform">
                                                    <option {% if server.getPlatform()=='java' %}selected{% endif %}
                                                        value="java">Java</option>
                                                    <option {% if server.getPlatform()=='pts' %}selected{% endif %}
                                                        value="pts">PTS</option>
                                                </select>
                                            </div>

                                            <div class="col-xl-4">
                                                <label for="version_client" class="form-label">Chronicle</label>
                                                <select class="form-control" data-trigger name="version_client"
                                                    id="version_client">
                                                    {% for client in client_list_default %}
                                                    <option data-protocol="{{client.protocol|json_encode}}" {% if
                                                        client['name']==server.getChronicle() %}selected{% endif %}>{{
                                                        client['name'] }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <div class="col-xl-5">
                                                <label for="collection"
                                                    class="form-label">{{phrase('server_build')}}</label>
                                                <select class="form-control" data-trigger id="collection"
                                                    name="collection">
                                                </select>
                                            </div>

                                            <div class="col-xl-4 pts_cached_data d-none">
                                                <label for="cached_ip" class="form-label">CacheD IP</label>
                                                <input name="cached_ip" type="text" class="form-control" id="cached_ip"
                                                    value="{{cached.IP}}" placeholder="158.211.11.124">
                                            </div>
                                            <div class="col-xl-4 pts_cached_data d-none">
                                                <label for="cached_port" class="form-label">CacheD Port</label>
                                                <input name="cached_port" type="text" class="form-control"
                                                    id="cached_port" value="{{cached.Port}}" placeholder="2012">
                                            </div>
                                            <div class="col-xl-4 pts_cached_data d-none">
                                                <label for="cached_WebAdmin" class="form-label">WebAdmin</label>
                                                <input name="cached_WebAdmin" type="text" class="form-control"
                                                    id="cached_WebAdmin" value="{{cached.WebAdmin}}"
                                                    placeholder="WebAdmin">
                                            </div>


                                            <hr class="hr">


                                            <div class="row gy-2 gx-3 align-items-center mb-4">


                                                <div class="col-xl-12">

                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" role="switch"
                                                            name="enableStatusServer" id="enableStatusServer" {% if
                                                            server.statusServerMem.enable %}checked="" {% endif %}>
                                                        <label class="form-check-label"
                                                            for="enableStatusServer">{{phrase('enable_server_status_display')}}</label>
                                                    </div>
                                                    {{phrase('if_enable_and_not_set_ip_and_port_status_server')}}


                                                    <div class="row">
                                                        <div class="col-xl-6">
                                                            <div class="form-floating mb-3">
                                                                <input type="text" class="form-control"
                                                                    value="{{server.statusServerMem.statusLoginServerIP}}"
                                                                    name="statusLoginServerIP" id="statusLoginServerIP"
                                                                    placeholder="127.0.0.1">
                                                                <label for="statusLoginServerIP">IP Login Server</label>
                                                            </div>
                                                        </div>

                                                        <div class="col-xl-3">
                                                            <div class="form-floating">
                                                                <input type="number" class="form-control"
                                                                    value="{{server.statusServerMem.statusLoginServerPort}}"
                                                                    name="statusLoginServerPort"
                                                                    id="statusLoginServerPort" placeholder="7777">
                                                                <label for="statusLoginServerPort">Port Login
                                                                    Server</label>
                                                            </div>
                                                        </div>

                                                    </div>

                                                    <div class="row">
                                                        <div class="col-xl-6">
                                                            <div class="form-floating mb-3">
                                                                <input type="text" class="form-control"
                                                                    value="{{server.statusServerMem.statusGameServerIP}}"
                                                                    name="statusGameServerIP" id="statusGameServerIP"
                                                                    placeholder="127.0.0.1">
                                                                <label for="statusGameServerIP">IP Game Server</label>
                                                            </div>
                                                        </div>

                                                        <div class="col-xl-3">
                                                            <div class="form-floating">
                                                                <input type="number" class="form-control"
                                                                    value="{{server.statusServerMem.statusGameServerPort}}"
                                                                    name="statusGameServerPort"
                                                                    id="statusGameServerPort" placeholder="7777">
                                                                <label for="statusGameServerPort">Port Game
                                                                    Server</label>
                                                            </div>
                                                        </div>

                                                    </div>



                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" role="switch"
                                                            name="showStatusBar" id="showStatusBar" {% if
                                                            server.showStatusBar() %}checked="" {% endif %}>
                                                        <label class="form-check-label" for="showStatusBar">{{
                                                            phrase('Show Status Bar') }}</label>
                                                    </div>

                                                </div>


                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xxl-6 col-xl-12 col-lg-12 col-md-6">
                                <div class="card custom-card shadow-none mb-0 border-0">
                                    <div class="card-body p-0">
                                        <div class="row gy-4">

                                            <div class="card bg-success-transparent mb-0 mt-2 border-success">
                                                <div class="d-flex p-2 border-bottom-0">
                                                    <div class="d-sm-flex">
                                                        <div class="">
                                                            <img src="{{template}}/assets/images/gopher_1.webp" alt=""
                                                                class="avatar avatar-xxl">
                                                        </div>
                                                        <div class="mt-0 ms-3 text-start">
                                                            <p class="fs-13 text-muted mb-0">{{
                                                                phrase('warning_need_allow_sphere_api') }}</p>


                                                            <div class="row g-3 align-items-center">
                                                                <div class="input-group">
                                                                    <input id="sphereapi"
                                                                        value="{{ config().sphereApi().getIp() }}"
                                                                        type="text"
                                                                        class="form-control bg-light border-0"
                                                                        placeholder="Search Contact"
                                                                        aria-describedby="search-contact-member">
                                                                    <button class="btn btn-light copy"
                                                                        data-object-id="sphereapi" type="button"
                                                                        id="search-contact-member"><i
                                                                            class="ri-file-copy-2-line text-muted"></i>
                                                                    </button>
                                                                </div>
                                                            </div>


                                                        </div>
                                                    </div>

                                                </div>
                                            </div>


                                            <div class="row">
                                                <div class="col-xl-6">
                                                    <div class="card-header justify-content-between">
                                                        <div class="card-title">
                                                            {{ phrase('DB for LoginServer') }}
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        {# Список логин серверов #}
                                                        <div id="logindblist">

                                                            {% for loginserver in loginservers %}
                                                            <div
                                                                class="form-check form-switch mb-2 d-flex align-items-center justify-content-between">
                                                                <div class="d-flex align-items-center">
                                                                    <input class="form-check-input" type="radio" {% if
                                                                        loginserver.default %}checked{% endif %}
                                                                        name="loginserver" value="{{loginserver.id}}"
                                                                        id="logindb_{{loginserver.id}}">
                                                                    <label class="form-check-label ms-2"
                                                                        for="logindb_{{loginserver.id}}">
                                                                        {{loginserver.host}}@{{loginserver.name}}
                                                                    </label>
                                                                    <a class="text-success ms-2"
                                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                                        data-bs-original-title="{{ phrase('count_accounts_in_login_server', loginserver.accountsCount ?? 0) }}"
                                                                        href="#">[{{loginserver.accountsCount ??
                                                                        0}}]</a>
                                                                </div>
                                                                <button type="button"
                                                                    class="btn btn-sm btn-outline-primary edit-login-db"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#editLoginDbModal"
                                                                    data-db-id="{{loginserver.id}}"
                                                                    data-db-host="{{loginserver.host}}"
                                                                    data-db-port="{{loginserver.port}}"
                                                                    data-db-user="{{loginserver.user}}"
                                                                    data-db-name="{{loginserver.name}}">
                                                                    <i class="ri-edit-line"></i>
                                                                </button>
                                                            </div>
                                                            {% endfor %}

                                                        </div>

                                                        <div class="collapse" id="add_new_login_server_panel">
                                                            <div class="row gy-3">

                                                                <div class="col-xl-12">
                                                                    <label for="login_host"
                                                                        class="form-label">IP</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="login_host" placeholder="172.217.17.110">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="login_port"
                                                                        class="form-label">Port</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="login_port" value="3306" placeholder="3306">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="login_user"
                                                                        class="form-label">User</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="login_user" placeholder="root">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="login_password"
                                                                        class="form-label">Password</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="login_password" placeholder="password">
                                                                </div>

                                                                <button id="getDBNameLogin" type="button"
                                                                    class="btn btn-primary btn-sm mb-0">Выбрать БД
                                                                </button>
                                                                <div class="col-xl-12">
                                                                    <select id="login_name"
                                                                        class="form-select form-control-sm"
                                                                        aria-label="Select DB"></select>
                                                                </div>


                                                                <button id="add_new_login_server" type="button"
                                                                    class="btn btn-primary btn-sm mb-3">Добавить
                                                                </button>

                                                            </div>
                                                        </div>
                                                        <a class="ecommerce-more-link" data-bs-toggle="collapse"
                                                            href="#add_new_login_server_panel" aria-expanded="false"
                                                            aria-controls="add_new_login_server_panel">{{ phrase('Add new login server') }}</a>
                                                    </div>
                                                </div>

                                                <div class="col-xl-6">
                                                    <div class="card-header justify-content-between">
                                                        <div class="card-title">
                                                            {{ phrase('DB for GameServer') }}
                                                        </div>
                                                    </div>
                                                    <div class="card-body">

                                                        <div id="gamedblist">

                                                            {% for gameserver in gameservers %}
                                                            <div
                                                                class="form-check form-switch mb-2 d-flex align-items-center justify-content-between">
                                                                <div class="d-flex align-items-center">
                                                                    <input class="form-check-input" type="radio" {% if
                                                                        gameserver.default %}checked{% endif %}
                                                                        name="gameserver" value="{{gameserver.id}}"
                                                                        id="gamedb_{{gameserver.id}}">
                                                                    <label class="form-check-label ms-2"
                                                                        for="gamedb_{{gameserver.id}}">
                                                                        {{gameserver.host}}@{{gameserver.name}}
                                                                    </label>
                                                                </div>
                                                                <button type="button"
                                                                    class="btn btn-sm btn-outline-primary edit-game-db"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#editGameDbModal"
                                                                    data-db-id="{{gameserver.id}}"
                                                                    data-db-host="{{gameserver.host}}"
                                                                    data-db-port="{{gameserver.port}}"
                                                                    data-db-user="{{gameserver.user}}"
                                                                    data-db-name="{{gameserver.name}}">
                                                                    <i class="ri-edit-line"></i>
                                                                </button>
                                                            </div>
                                                            {% endfor %}

                                                        </div>


                                                        <div class="collapse" id="add_new_game_server_panel">

                                                            <div class="row gy-3">

                                                                <div class="col-xl-12">
                                                                    <label for="game_host" class="form-label">IP</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="game_host" placeholder="172.217.17.110">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="game_port"
                                                                        class="form-label">Port</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="game_port" value="3306" placeholder="3306">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="game_user"
                                                                        class="form-label">User</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="game_user" placeholder="root">
                                                                </div>

                                                                <div class="col-xl-12">
                                                                    <label for="game_password"
                                                                        class="form-label">Password</label>
                                                                    <input type="text"
                                                                        class="form-control form-control-sm rounded-0"
                                                                        id="game_password" placeholder="password">
                                                                </div>

                                                                <button id="getDBNameGame" type="button"
                                                                    class="btn btn-primary btn-sm mb-0">Выбрать БД
                                                                </button>
                                                                <div class="col-xl-12">
                                                                    <select id="game_name"
                                                                        class="form-select form-control-sm"
                                                                        aria-label="Select DB"></select>
                                                                </div>


                                                                <button id="add_new_game_server" type="button"
                                                                    class="btn btn-primary btn-sm mb-3">Добавить
                                                                </button>

                                                            </div>

                                                        </div>
                                                        <a class="ecommerce-more-link" data-bs-toggle="collapse"
                                                            href="#add_new_game_server_panel" aria-expanded="false"
                                                            aria-controls="add_new_game_server_panel">{{ phrase('Add Game Server DB') }}</a>
                                                    </div>
                                                </div>
                                            </div>


                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="accordion-body">

                            <ul class="list-group ">
                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">

                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">{{phrase('server_launch_date')}}</p>
                                            <span
                                                class="fs-11 text-muted op-7">{{phrase('official_server_launch_datetime')}}</span>
                                        </div>
                                        <div class="col-2">
                                            <input type="text" class="form-control" id="dateStartServer"
                                                name="dateStartServer" value="{{ server.getDateStartServer() }}"
                                                placeholder="{{ phrase('server_launch_date') }}">
                                        </div>

                                    </div>
                                </li>

                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">
                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">{{ phrase('game_version') }}</p>
                                            <span
                                                class="fs-11 text-muted op-7">{{phrase('knowledge_base_version')}}</span>
                                        </div>


                                        <div class="col-2">
                                            <select class="form-control" data-trigger name="knowledge_base"
                                                id="knowledge_base">
                                                {% for clientVer in chronicleBaseList %}
                                                <option {% if server.getKnowledgeBase()==clientVer %}selected{% endif %}
                                                    value="{{clientVer}}">{{clientVer}}</option>
                                                {% endfor %}
                                            </select>

                                        </div>

                                    </div>
                                </li>

                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">
                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">{{ phrase(572) }}</p>
                                            <span
                                                class="fs-11 text-muted op-7">{{phrase('max_players_for_progress_bar')}}</span>
                                        </div>

                                        <div class="col-2">
                                            <input value="{{server.getMaxOnline()}}" type="number" class="form-control"
                                                name="max_online" id="max_online" placeholder="Max online">
                                        </div>

                                    </div>
                                </li>


                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">
                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">{{ phrase('server_time_zone') }}</p>
                                            <span class="fs-11 text-muted op-7">
                                                {{ phrase('necessary_to_specify_server_time_zone') }}
                                            </span>
                                        </div>

                                        <div class="col-2">
                                            <select name="timezone_server" class="form-control" id="timezone_server">
                                                {% for timezone in timezone_list() %}
                                                <option {% if server.getTimeZone()==timezone %}selected{% endif %}
                                                    value="{{timezone}}">{{timezone}}</option>
                                                {% endfor %}
                                            </select>

                                        </div>

                                    </div>
                                </li>

                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">
                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">{{phrase('reset_hwid')}}</p>
                                            <span
                                                class="fs-11 text-muted op-7">{{phrase('enable_hwid_reset_function')}}</span>
                                        </div>
                                        <div class="col-2 form-check form-check-lg form-switch">
                                            <input {% if server.isResetHWID() %}checked{% endif %} name="resetHWID"
                                                class="form-check-input" type="checkbox" id="resetHWID">
                                        </div>
                                    </div>
                                </li>

                                <li class="list-group-item">
                                    <div class="d-sm-flex align-items-top">
                                        <div class="ms-sm-2 ms-0 mt-sm-0 mt-1 fw-semibold flex-fill">
                                            <p class="mb-0 lh-1">Отправка предметов в warehouse</p>
                                            <span class="fs-11 text-muted op-7">Разрешить игрокам отправлять свои
                                                предметы в warehouse при сбросе персонажа. Полезно при критической
                                                ошибке при заходе на персонажа.
                                                <br>Внимание: Если есть предметы в инвентаре игрока, которые нельзя
                                                отправить в склад, они будут отправлены.</span>
                                        </div>
                                        <div class="col-2 form-check form-check-lg form-switch">
                                            <input {% if server.isResetItemsToWarehouse() %}checked{% endif %}
                                                name="resetItemsToWarehouse" class="form-check-input" type="checkbox"
                                                id="resetItemsToWarehouse">
                                        </div>
                                    </div>
                                </li>

                            </ul>

                        </div>

                    </div>


                    <div class="px-4 py-3 border-top border-block-start-dashed d-sm-flex justify-content-between">
                        <button type="button" class="btn btn-danger-light m-1 removeServer"
                            data-server-id="{{server.getId()}}">{{ phrase('delete') }}</button>
                        <button type="submit" class="btn btn-success-light m-1">{{ phrase(271) }}<i
                                class="bi bi-plus-lg ms-2"></i></button>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <!--End::row-1 -->


</div>

<!-- Модальное окно для редактирования Login DB -->
<div class="modal fade" id="editLoginDbModal" tabindex="-1" aria-labelledby="editLoginDbModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLoginDbModalLabel">Редактировать Login Server DB</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editLoginDbForm">
                    <input type="hidden" id="edit_login_db_id" name="db_id">
                    <div class="row gy-3">
                        <div class="col-xl-12">
                            <label for="edit_login_host" class="form-label">IP</label>
                            <input type="text" class="form-control" id="edit_login_host" name="host"
                                placeholder="172.217.17.110">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_login_port" class="form-label">Port</label>
                            <input type="text" class="form-control" id="edit_login_port" name="port" value="3306"
                                placeholder="3306">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_login_user" class="form-label">User</label>
                            <input type="text" class="form-control" id="edit_login_user" name="user" placeholder="root">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_login_password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="edit_login_password" name="password"
                                placeholder="password">
                        </div>
                        <div class="col-xl-12">
                            <button type="button" id="edit_getDBNameLogin" class="btn btn-primary btn-sm mb-0">Выбрать
                                БД</button>
                            <select id="edit_login_name" class="form-select mt-2" name="name"
                                aria-label="Select DB"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveEditLoginDb">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования Game DB -->
<div class="modal fade" id="editGameDbModal" tabindex="-1" aria-labelledby="editGameDbModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGameDbModalLabel">Редактировать Game Server DB</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGameDbForm">
                    <input type="hidden" id="edit_game_db_id" name="db_id">
                    <div class="row gy-3">
                        <div class="col-xl-12">
                            <label for="edit_game_host" class="form-label">IP</label>
                            <input type="text" class="form-control" id="edit_game_host" name="host"
                                placeholder="172.217.17.110">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_game_port" class="form-label">Port</label>
                            <input type="text" class="form-control" id="edit_game_port" name="port" value="3306"
                                placeholder="3306">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_game_user" class="form-label">User</label>
                            <input type="text" class="form-control" id="edit_game_user" name="user" placeholder="root">
                        </div>
                        <div class="col-xl-12">
                            <label for="edit_game_password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="edit_game_password" name="password"
                                placeholder="password">
                        </div>
                        <div class="col-xl-12">
                            <button type="button" id="edit_getDBNameGame" class="btn btn-primary btn-sm mb-0">Выбрать
                                БД</button>
                            <select id="edit_game_name" class="form-select mt-2" name="name"
                                aria-label="Select DB"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveEditGameDb">Сохранить</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block css %}
<link rel="stylesheet" href="{{template}}/assets/libs/choices.js/public/assets/styles/choices.min.css">
<link rel="stylesheet" href="{{template}}/assets/libs/quill/quill.snow.css">
<link rel="stylesheet" href="{{template}}/assets/libs/quill/quill.bubble.css">

<link rel="stylesheet" href="{{template}}/assets/libs/filepond/filepond.min.css">
<link rel="stylesheet"
    href="{{template}}/assets/libs/filepond-plugin-image-preview/filepond-plugin-image-preview.min.css">
<link rel="stylesheet" href="{{template}}/assets/libs/filepond-plugin-image-edit/filepond-plugin-image-edit.min.css">

<link rel="stylesheet" href="{{template}}/assets/libs/flatpickr/flatpickr.min.css">
{% endblock %}

{% block js %}

<script src="{{template}}/assets/libs/simplebar/simplebar.min.js"></script>
<script src="{{template}}/assets/js/simplebar.js"></script>

<script src="{{template}}/assets/libs/flatpickr/flatpickr.min.js"></script>

<script>
    flatpickr("#dateStartServer", {
        enableTime: true,
        altInput: true,
        altFormat: "Y-m-d H:i",
        dateFormat: "Y-m-d H:i",
        defaultTime: "13:45",
        time_24hr: true,
    });
</script>

<script>
    const collectionInfo = JSON.parse('{{collections|raw}}');
    const collectionInfoPTS = JSON.parse('{{collectionsPTS|raw}}');

    //Добавление логин-сервера
    $("#add_new_login_server").on("click", function () {
        let host = $("#login_host").val();
        let name = $("#login_name").val();
        AjaxSend("/admin/db/add/new/connect", "POST", {
            type: "loginserver",
            host: host,
            port: $("#login_port").val(),
            user: $("#login_user").val(),
            password: $("#login_password").val(),
            name: name,
        }, true)
            .then(function (response) {
                responseAnalysis(response);

                if (response && response.success === true) {
                    // Формируем разметку с использованием response.id
                    let newLoginDB = `
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="radio"
                           name="loginserver" value="${response.id}"
                           id="logindb_${response.id}">
                    <label class="form-check-label" for="logindb_${response.id}">
                        ${host}@${name}
                    </label>
                </div>`;

                    // Убираем выбор с других радиокнопок
                    $("#logindblist input[type='radio']").prop("checked", false);

                    // Добавляем новую разметку в div с id="logindblist"
                    $("#logindblist").append(newLoginDB);

                    // Ставим галочку для нового радио
                    $(`#logindb_${response.id}`).prop("checked", true);

                    $('#add_new_login_server_panel').collapse('hide')

                }
            })
            .catch(function (error) {
                console.error("Error during Ajax call:", error);
            });
    });

    $("#add_new_game_server").on("click", function () {
        let host = $("#game_host").val();
        let name = $("#game_name").val();
        AjaxSend("/admin/db/add/new/connect", "POST", {
            type: "gameserver",
            host: host,
            port: $("#game_port").val(),
            user: $("#game_user").val(),
            password: $("#game_password").val(),
            name: name,
        }, true)
            .then(function (response) {
                responseAnalysis(response);

                if (response && response.success === true) {
                    // Формируем разметку с использованием response.id
                    let newGameDB = `
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="radio"
                           name="gameserver" value="${response.id}"
                           id="gamedb_${response.id}">
                    <label class="form-check-label" for="gamedb_${response.id}">
                        ${host}@${name}
                    </label>
                </div>`;

                    // Снимаем все галочки
                    $("#gamedblist input[type='checkbox']").prop("checked", false);

                    $("#gamedblist").append(newGameDB);

                    // Ставим галочку для нового чекбокса
                    $(`#gamedb_${response.id}`).prop("checked", true);

                    $('#add_new_game_server_panel').collapse('hide')

                }
            })
            .catch(function (error) {
                console.error("Error during Ajax call:", error);
            });
    });


    $(document).on('click', '#getDBNameLogin', function (event) {
        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": $("#login_host").val(),
                "port": $("#login_port").val(),
                "user": $("#login_user").val(),
                "password": $("#login_password").val(),
            },
            dataType: 'json',
            success: function (response) {
                $("#login_name").empty();
                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        return;
                    }
                }
                $.each(response['databases'], function (index, value) {
                    $("#login_name").append('<option value="' + value + '">' + value + '</option>');
                });
            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
            }
        })
    });

    $(document).on('click', '#getDBNameGame', function (event) {
        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": $("#game_host").val(),
                "port": $("#game_port").val(),
                "user": $("#game_user").val(),
                "password": $("#game_password").val(),
            },
            dataType: 'json',
            success: function (response) {
                $("#game_name").empty();

                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        return;
                    }
                }
                $.each(response['databases'], function (index, value) {
                    $("#game_name").append('<option value="' + value + '">' + value + '</option>');
                });

            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
            }
        })
    });


    $(document).ready(function () {

        $('#platform').on('change', handlePlatformChange);
        handlePlatformChange.call($('#platform'));

        function hasCommonElement(arr1, arr2) {
            return arr1.some(item => arr2.includes(Number(item)));
        }

        // Функция обновления списка сборок
        function updateCollections(selectedProtocols) {
            // Очищаем текущий список
            $('#collection').empty();

            // Определяем, какую коллекцию использовать
            const currentCollectionInfo = $('#platform').val() === 'pts' ? collectionInfoPTS : collectionInfo;

            // Преобразуем строку протоколов в массив чисел
            const protocols = selectedProtocols.map(Number);

            // Фильтруем доступные сборки
            const availableCollections = currentCollectionInfo.filter(collection =>
                hasCommonElement(protocols, collection.protocols)
            );

            // Добавляем опции в select
            if (availableCollections.length > 0) {
                availableCollections.forEach(collection => {
                    $('#collection').append(
                        $('<option>', {
                            value: collection.name,
                            text: collection.name
                        })
                    );
                });
            } else {
                // Если нет доступных сборок, добавляем placeholder
                $('#collection').append(
                    $('<option>', {
                        value: '',
                        text: 'Нет доступных сборок',
                        disabled: true,
                        selected: true
                    })
                );
            }
        }

        // Обработчик изменения выбранной хроники
        $('#version_client').on('change', function () {
            const selectedOption = $(this).find('option:selected');
            const protocolsStr = selectedOption.data('protocol');

            // Проверяем, является ли значение строкой и преобразуем его в массив
            const protocols = typeof protocolsStr === 'string'
                ? JSON.parse(protocolsStr.replace(/[\[\]]/g, '').split(','))
                : protocolsStr;

            updateCollections(protocols);
        });

        function handlePlatformChange() {
            const selectedOption = $('#version_client').find('option:selected');
            const protocolsStr = selectedOption.data('protocol');
            const protocols = typeof protocolsStr === 'string'
                ? JSON.parse(protocolsStr.replace(/[\[\]]/g, '').split(','))
                : protocolsStr;

            if ($(this).val() === 'pts') {
                $("#login_port").val(1433);
                $("#game_port").val(1433);
                $(".pts_cached_data").removeClass("d-none")
            } else {
                $("#login_port").val(3306);
                $("#game_port").val(3306);
                $(".pts_cached_data").addClass("d-none")
            }

            updateCollections(protocols);
        }

        // Инициализация при загрузке страницы
        const initialProtocols = $('#version_client option:selected').data('protocol');
        const serverCollection = "{{server.getCollection()}}";

        if (initialProtocols) {
            const protocols = typeof initialProtocols === 'string'
                ? JSON.parse(initialProtocols.replace(/[\[\]]/g, '').split(','))
                : initialProtocols;

            updateCollections(protocols);

            // После обновления списка коллекций, устанавливаем выбранное значение
            if (serverCollection) {
                $('#collection').val(serverCollection);
            }
        }

    });

</script>
<script>
    $(document).on("click", ".removeServer", function () {
        AjaxSend("/admin/server/delete", "POST", {
            serverId: $(this).data('server-id')
        }, false).then(function (data) {
            console.log(data)
        })
    });

    // Обработчик открытия модального окна для редактирования Login DB
    $(document).on("click", ".edit-login-db", function () {
        const dbId = $(this).data('db-id');
        const dbHost = $(this).data('db-host');
        const dbPort = $(this).data('db-port');
        const dbUser = $(this).data('db-user');
        // const dbName = $(this).data('db-name'); // Не заполняем!

        // Заполняем форму данными
        $('#edit_login_db_id').val(dbId);
        $('#edit_login_host').val(dbHost);
        $('#edit_login_port').val(dbPort);
        $('#edit_login_user').val(dbUser);
        $('#edit_login_password').val(''); // Пароль не заполняем из соображений безопасности
        $('#edit_login_name').empty().prop('disabled', true); // Очищаем select и делаем неактивным
        $('#saveEditLoginDb').prop('disabled', true); // Кнопка Сохранить неактивна
    });

    // Обработчик открытия модального окна для редактирования Game DB
    $(document).on("click", ".edit-game-db", function () {
        const dbId = $(this).data('db-id');
        const dbHost = $(this).data('db-host');
        const dbPort = $(this).data('db-port');
        const dbUser = $(this).data('db-user');
        // const dbName = $(this).data('db-name'); // Не заполняем!

        // Заполняем форму данными
        $('#edit_game_db_id').val(dbId);
        $('#edit_game_host').val(dbHost);
        $('#edit_game_port').val(dbPort);
        $('#edit_game_user').val(dbUser);
        $('#edit_game_password').val(''); // Пароль не заполняем из соображений безопасности
        $('#edit_game_name').empty().prop('disabled', true); // Очищаем select и делаем неактивным
        $('#saveEditGameDb').prop('disabled', true); // Кнопка Сохранить неактивна
    });

    // Обработчик кнопки "Выбрать БД" для редактирования Login DB
    $(document).on('click', '#edit_getDBNameLogin', function () {
        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": $("#edit_login_host").val(),
                "port": $("#edit_login_port").val(),
                "user": $("#edit_login_user").val(),
                "password": $("#edit_login_password").val(),
            },
            dataType: 'json',
            success: function (response) {
                $("#edit_login_name").empty();
                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        $('#edit_login_name').prop('disabled', true);
                        $('#saveEditLoginDb').prop('disabled', true);
                        return;
                    }
                }
                if (response['databases'] && response['databases'].length > 0) {
                    $.each(response['databases'], function (index, value) {
                        $("#edit_login_name").append('<option value="' + value + '">' + value + '</option>');
                    });
                    $('#edit_login_name').prop('disabled', false);
                    // Включаем кнопку Сохранить только если выбрана БД
                    if ($('#edit_login_name').val()) {
                        $('#saveEditLoginDb').prop('disabled', false);
                    }
                } else {
                    $('#edit_login_name').prop('disabled', true);
                    $('#saveEditLoginDb').prop('disabled', true);
                }
            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
                $('#edit_login_name').prop('disabled', true);
                $('#saveEditLoginDb').prop('disabled', true);
            }
        });
    });

    // Следим за изменением select, чтобы включать/выключать кнопку Сохранить
    $(document).on('change', '#edit_login_name', function () {
        if ($(this).val()) {
            $('#saveEditLoginDb').prop('disabled', false);
        } else {
            $('#saveEditLoginDb').prop('disabled', true);
        }
    });

    // Обработчик кнопки "Выбрать БД" для редактирования Game DB
    $(document).on('click', '#edit_getDBNameGame', function () {
        $.ajax({
            url: "/admin/option/server/db/connect/select/name",
            type: "POST",
            data: {
                "host": $("#edit_game_host").val(),
                "port": $("#edit_game_port").val(),
                "user": $("#edit_game_user").val(),
                "password": $("#edit_game_password").val(),
            },
            dataType: 'json',
            success: function (response) {
                $("#edit_game_name").empty();
                if (response.type === "notice") {
                    if (!ResponseNotice(response)) {
                        $('#edit_game_name').prop('disabled', true);
                        $('#saveEditGameDb').prop('disabled', true);
                        return;
                    }
                }
                if (response['databases'] && response['databases'].length > 0) {
                    $.each(response['databases'], function (index, value) {
                        $("#edit_game_name").append('<option value="' + value + '">' + value + '</option>');
                    });
                    $('#edit_game_name').prop('disabled', false);
                    if ($('#edit_game_name').val()) {
                        $('#saveEditGameDb').prop('disabled', false);
                    }
                } else {
                    $('#edit_game_name').prop('disabled', true);
                    $('#saveEditGameDb').prop('disabled', true);
                }
            },
            error: function (xhr, status, error) {
                console.error('Ошибка при выполнении AJAX-запроса:', error);
                $('#edit_game_name').prop('disabled', true);
                $('#saveEditGameDb').prop('disabled', true);
            }
        });
    });

    $(document).on('change', '#edit_game_name', function () {
        if ($(this).val()) {
            $('#saveEditGameDb').prop('disabled', false);
        } else {
            $('#saveEditGameDb').prop('disabled', true);
        }
    });

    // Обработчик сохранения изменений Login Server DB
    $(document).on('click', '#saveEditLoginDb', function () {
        const formData = {
            loginId: $('#edit_login_db_id').val(),
            host: $('#edit_login_host').val(),
            port: $('#edit_login_port').val(),
            user: $('#edit_login_user').val(),
            password: $('#edit_login_password').val(),
            name: $('#edit_login_name').val()
        };

        // Проверяем, что все обязательные поля заполнены
        if (!formData.loginId || !formData.host || !formData.port || !formData.user || !formData.name) {
            ResponseNotice({
                type: "error",
                message: "Пожалуйста, заполните все обязательные поля"
            });
            return;
        }

        AjaxSend("/admin/server/update/loginserver", "POST", formData, true)
            .then(function (response) {
                responseAnalysis(response);

                if (response && response.ok === true) {
                    // Закрываем модальное окно через Bootstrap 5 API (надёжно)
                    const modalEl = document.getElementById('editLoginDbModal');
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();

                    // Обновляем отображение в списке
                    const dbId = formData.loginId;
                    const newDisplayText = `${formData.host}@${formData.name}`;
                    // Находим label по for
                    const $label = $(`label[for='logindb_${dbId}']`);
                    if ($label.length) {
                        // Если label содержит только текст
                        if ($label.children().length === 0) {
                            $label.text(newDisplayText);
                        } else {
                            // Если есть вложенные элементы, удаляем только текстовые узлы
                            $label.contents().filter(function () { return this.nodeType === 3; }).remove();
                            $label.prepend(newDisplayText);
                        }
                    }

                    // Обновляем data-атрибуты кнопки
                    $(`.edit-login-db[data-db-id="${dbId}"]`)
                        .attr('data-db-host', formData.host)
                        .attr('data-db-port', formData.port)
                        .attr('data-db-user', formData.user)
                        .attr('data-db-name', formData.name);

                    // Очищаем форму
                    $('#editLoginDbForm')[0].reset();
                }
            })
            .catch(function (error) {
                console.error("Error during Ajax call:", error);
            });
    });

    // Обработчик сохранения изменений Game Server DB
    $(document).on('click', '#saveEditGameDb', function () {
        const formData = {
            gameId: $('#edit_game_db_id').val(), // Используем gameId для game server
            host: $('#edit_game_host').val(),
            port: $('#edit_game_port').val(),
            user: $('#edit_game_user').val(),
            password: $('#edit_game_password').val(),
            name: $('#edit_game_name').val()
        };

        // Проверяем, что все обязательные поля заполнены
        if (!formData.gameId || !formData.host || !formData.port || !formData.user || !formData.name) {
            ResponseNotice({
                type: "error",
                message: "Пожалуйста, заполните все обязательные поля"
            });
            return;
        }

        AjaxSend("/admin/server/update/gameserver", "POST", formData, true)
            .then(function (response) {
                responseAnalysis(response);

                if (response && response.ok === true) {
                    // Закрываем модальное окно через Bootstrap 5 API (надёжно)
                    const modalEl = document.getElementById('editGameDbModal');
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();

                    // Обновляем отображение в списке
                    const dbId = formData.gameId;
                    const newDisplayText = `${formData.host}@${formData.name}`;
                    const $label = $(`label[for='gamedb_${dbId}']`);
                    if ($label.length) {
                        if ($label.children().length === 0) {
                            $label.text(newDisplayText);
                        } else {
                            $label.contents().filter(function () { return this.nodeType === 3; }).remove();
                            $label.prepend(newDisplayText);
                        }
                    }

                    $(`.edit-game-db[data-db-id="${dbId}"]`)
                        .attr('data-db-host', formData.host)
                        .attr('data-db-port', formData.port)
                        .attr('data-db-user', formData.user)
                        .attr('data-db-name', formData.name);

                    $('#editGameDbForm')[0].reset();
                }
            })
            .catch(function (error) {
                console.error("Error during Ajax call:", error);
            });
    });
</script>
{% endblock %}