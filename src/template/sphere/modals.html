{# Смена настроек #}
<div class="modal modal-lg fade" id="settings" tabindex="-1" aria-labelledby="settings-ComposeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="/user/change" method="post" class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="settings-ComposeLabel">{{ phrase(54) }}</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body px-4">
        <div class="row">
          <div class="col-xl-6 mb-2">
            <label for="change_u_name" class="form-label">{{ phrase(27) }}<sup><i
                  class="ri-star-s-fill text-success fs-8"></i></sup></label>
            <input name="name" type="text" class="form-control" id="change_u_name" value="{{getUser().getName()}}">
          </div>
          <div class="col-xl-6 mb-2">
            <label for="change_u_timezone" class="form-label">{{ phrase('timezone') }}<sup><i
                  class="ri-star-s-fill text-success fs-8"></i></sup></label>
            <select name="timezone" class="form-control" id="change_u_timezone">
              {% for timezone in timezone_list() %}
              <option {% if getUser().getTimezone() == timezone %}selected {% endif %}value="{{timezone}}">{{timezone}}</option>
              {% endfor %}
            </select>
          </div>

          <i class="border-top d-block my-3"></i>
          {% if getUser().getPassword() != "GOOGLE" %}
          <div class="col-xl-6 mb-2">
            <label for="old_u_password" class="form-label text-dark fw-semibold">{{ phrase('old_password') }}</label>
            <input name="password" type="password" class="form-control" id="old_u_password" autocomplete="new-password">
          </div>
          {% else %}
          <span>У Вас нет пароля, хотите установить?</span>
          {% endif %}
          <div class="col-xl-6 mb-2">
            <label for="new_u_password" class="form-label text-dark fw-semibold">{{ phrase(60) }}</label>
            <input name="new_password" type="password" class="form-control" id="new_u_password" autocomplete="new-password">
          </div>

        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">

        <div class="alert alert-success d-flex align-items-center download_auth_file" role="button">
          <i class="ri-download-cloud-line"></i>
          <div>Загрузить авторизационный файл</div>
        </div>

        <div>
          <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">{{ phrase('cancel') }}</button>
          <button type="submit" data-bs-dismiss="modal" class="btn btn-success">{{ phrase('apply') }}</button>
        </div>
      </div>


    </form>
  </div>
</div>

{# Отправка коинов в игру, на персонажа #}
{% if config().enabled().isEnableSendBalanceGame() %}
<div class="modal modal-lg fade" id="sendToPlayer" tabindex="-1" aria-labelledby="sendToPlayer-ComposeLabel"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="sendToPlayer-ComposeLabel">{{phrase('transfer_to_game')}}</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body px-4">
        <div class="row">

          {# Если пользователь не установил в настройках какой предмет отправлять пользователю #}

          {% if getServer().donate().getItemIdToGameTransfer() == 0 %}
              {{ phrase('no_item_to_send') }}

              {% if getUser().isAdmin() %}
<label class="text-danger">Укажите в админ-панели->Настройки->Пожертвование какой предмет необходимо пересылать персонажу</label>
              {% endif %}

          {% else %}

          {% set item = get_item_info(getServer().donate().getItemIdToGameTransfer()) %}

          {% if getUser().isAuth() %}

          {% if getUser().getDonate() == 0 %}
          <label class="form-label text-dark fw-semibold">{{phrase('no_donate_coin_transfer')}}</label>
          {% else %}

          {% if item == null %}
          {{ phrase('no_item_to_send') }}
          {% else %}

          <div class="col-xl-6 mb-2">
            <label for="send_player_name" class="form-label">{{ phrase('player') }}</label>
            <select {% if getUser().getCountPlayers()== 0 %}disabled{% endif %} class="form-control" data-trigger
                    name="player" id="send_player_name">
              {% if getUser().getCountPlayers() == 0 %}
              <option>{{phrase('no_chars')}}</option>
              {% else %}
              {% for i, account in getUser().getAccounts() %}
              <optgroup label="{{phrase('account')}}: {{account.getAccount()}}">
                {% if account.getCharactersCount() == 0 %}
                <option disabled> &nbsp;&nbsp;&nbsp;&nbsp; {{phrase('no_chars')}}</option>
                {% else %}
                {% for i, character in account.getCharacters() %}
                <option data-account="{{account.getAccount()}}" data-character="{{character.getPlayerName()}}">
                  {{character.getPlayerName()}}
                </option>
                {% endfor %}
                {% endif %}
              </optgroup>
              {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-xl-6 mb-2">
            <label for="muchSphereCoin" class="form-label text-dark fw-semibold">{{phrase(71)}}</label>
            <input min="1" max="{{getUser().getDonate()|round(0, 'floor')}}"
                   value="{{getUser().getDonate()|round(0, 'floor')}} " name="coin"
                   type="number" class="form-control" id="muchSphereCoin">
          </div>
          <label class="mb-0 fs-12 text-muted text-truncate max-w-150 mx-auto ">{{phrase('char_will_be_sent')}}
            <img class="avatar avatar-sm rounded" src="{{item.getIcon()}}"> <span class="text-success">{{ item.itemName }}</span>
            x<span class="text-success" id="itemCountGameTransfer"
                   data-count-donate-item="{{ getServer().donate().getDonateItemToGameTransfer() }}"
                   data-count-items="{{ getServer().donate().getCountItemsToGameTransfer() }}">{{ getServer().donate().getCountItemsToGameTransfer() }}</span></label>
          {% endif %}

          {% endif %}

          {% else %}
          <label class="form-label text-dark fw-semibold">{{phrase('login_then_transfer_donate_coin')}}</label>
          {% endif %}

          {% endif %}

        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        {% if getUser().isAuth() and getServer().donate().getItemIdToGameTransfer() != 0 %}
        <p class="mb-0">
          <span class="fw-semibold text-muted fs-12">{{ phrase('exchange') }} :</span> {{ getServer().donate().getDonateItemToGameTransfer() }} {{ phrase('donate_coin') }} = {{ getServer().donate().getCountItemsToGameTransfer() }} <img class="avatar avatar-xs rounded" src="{{item.getIcon()}}"> {{ item.itemName }}
        </p>
        {% endif %}


        <div>
          {% if getUser().isAuth() %}
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{phrase('close')}}</button>
          {% if getUser().getDonate()|round(0, 'floor') > 0 and item != null %}
          <button id="sendToPlayerBtn" type="submit" class="btn btn-primary">{{phrase(364)}}</button>
          {% endif %}
          {% else %}
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{phrase('close')}}</button>
          {% endif %}
        </div>
      </div>



    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    let maxValue = {{getUser().getDonate() | round(0, 'floor')}};

    $('#muchSphereCoin').on('keypress keydown input', function (event) {
      const key = event.which || event.keyCode;
      if (
            (key < 48 || key > 57) &&
            (key < 96 || key > 105) &&
            key !== 8 &&
            (key < 37 || key > 40)
      ) {
        event.preventDefault();
      }
      let currentValue = parseInt($(this).val());

      if (currentValue > maxValue) {
        currentValue = Math.floor(maxValue);
        $(this).val(currentValue);
      } else {
        $(this).val(Math.floor(currentValue));
      }
    });
  });
</script>


{% endif %}




<div class="modal fade" id="serverSelect" tabindex="-1" aria-labelledby="serverSelect" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        {{ phrase('server') }}
        <select class="form-select form-select-sm  bg-success-transparent text-success select_default_server" aria-label="Default select example">
          {% for server in getServerAll() %}
          <option {% if getUser().getServerId()== server.getId() %}selected{% endif %} value="{{server.getId()}}">
            {{server.getName()}}
          </option>
          {% endfor %}
        </select>
      </div>

    </div>
  </div>
</div>



<script>

  function recalculateSphereCoinValue() {
    const maxValue = {{getUser().getDonate() | round(0, 'floor')}};

    let muchSphereCoinVal = parseInt($('#muchSphereCoin').val());
    if (muchSphereCoinVal > maxValue) {
      muchSphereCoinVal = maxValue;
      $('#muchSphereCoin').val(muchSphereCoinVal);
    }
    let itemCountGameTransferCount = ($('#itemCountGameTransfer').data('count-items')) / {{ getServer().donate().getDonateItemToGameTransfer() ?? 1 }};
    if (!isNaN(muchSphereCoinVal) && !isNaN(itemCountGameTransferCount) && itemCountGameTransferCount > 0) {
      let result = muchSphereCoinVal * itemCountGameTransferCount;
      result = Math.floor(result)
      $('#itemCountGameTransfer').text(result);
    }
  }

  $('#muchSphereCoin').on('input', recalculateSphereCoinValue);
  $(document).ready(recalculateSphereCoinValue);
</script>


{% if config().enabled().isEnableBonusCode() %}
<div class="modal modal-lg fade" id="bonusCodeModal" tabindex="-1" aria-labelledby="bonusCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="bonusCodeModalLabel">{{phrase('code_bonus')}}</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4">
        <div class="row">
          {% if getUser().isAuth() %}
          <div class="col-xl-12 mb-3">
            <label for="form-code" class="form-label text-dark fw-semibold">{{phrase('enter_bonus_code')}}<sup><i class="ri-star-s-fill text-success fs-8"></i></sup></label>
            <input type="text" class="form-control" id="form-code" placeholder="{{phrase('code_bonus')}}">
          </div>
          {% else %}
          <div class="col-xl-12">
            {{phrase('need_auth_for_bonus_code')|raw}}
          </div>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        {% if getUser().isAuth() %}
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{phrase('cancel')}}</button>
        <button type="button" class="btn btn-primary" id="bonusCode">{{phrase('receive')}}</button>
        {% else %}
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{phrase('close')}}</button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function() {
    // Очистка поля ввода при открытии модального окна
    $('#bonusCodeModal').on('show.bs.modal', function() {
      $('#form-code').val('');
    });

    $('#bonusCode').on('click', function() {
      let code = $('#form-code').val();

      if (!code) {
        return;
      }

      // Отправляем AJAX запрос
      AjaxSend('/bonus/code', 'POST', {code: code})
      var modal = bootstrap.Modal.getInstance(document.getElementById('bonusCodeModal'));
      modal.hide();

    });
  });
</script>
{% endif %}



{% if getUser().isAuth() %}
<div class="modal modal-lg fade" id="syncAccount" tabindex="-1" aria-labelledby="syncAccountLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="syncAccountLabel">{{phrase('link_account_to_profile')}}</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4">
        <div class="row">

          {{phrase(556)|raw}}

          <div class="alert alert-primary alert-dismissible fade show custom-alert-icon shadow-sm" role="alert">
            <svg class="svg-primary" xmlns="http://www.w3.org/2000/svg" height="1.5rem" viewBox="0 0 24 24" width="1.5rem" fill="#000000"><path d="M0 0h24v24H0z" fill="none"></path><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
            Аккаунт будет добавлен для сервера <span class="h5">{{getServer(getUser().getServerId()).getName()}} x{{getServer(getUser().getServerId()).getRateExp()}} - {{getServer(getUser().getServerId()).Chronicle()}}</span>
           </div>


          <div class="col-xl-6 mb-2">
            <label for="syncLogin" class="form-label text-dark fw-semibold">{{ phrase('account') }}</label>
            <input type="text" class="form-control" id="syncLogin" autocomplete="off">
          </div>

          <div class="col-xl-6 mb-2">
            <label for="syncPassword" class="form-label text-dark fw-semibold">{{ phrase('password') }}</label>
            <input type="password" name="syncPassword" class="form-control" id="syncPassword"
                   autocomplete="new-password">
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light"
                data-bs-dismiss="modal">{{ phrase('close') }}
        </button>
        <button id="syncUserAccount" type="button" class="btn btn-primary">{{ phrase(438) }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  $("#syncUserAccount").on("click", function () {
    AjaxSend('/account/synchronization', 'POST', {
      login: $("#syncLogin").val(),
      password: $("#syncPassword").val(),
    }, true).then(function (response) {
      if (response.ok == true) {
        $("#syncAccount").modal("hide");
        noticeSuccess("{{phrase('account_linked_success')}}");
        location.reload();
      } else {
        noticeError(response.message)
      }
    })
  });

  $('.download_auth_file').on('click', function () {
    $(this).prop('disabled', true);
    AjaxSend('/api/user/global/add/email/check', 'POST', {}, false);
  });
</script>

<!-- Оптимизированное модальное окно склада -->

<!-- окно разбития !-->
<!-- Модальное окно разбития предметов -->
<div class="modal fade" id="splitItemModal" tabindex="-1" aria-labelledby="splitItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="splitItemModalLabel">{{phrase('unstack_item')}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <img id="splitItemIcon" src="" alt="Предмет" class="img-fluid border rounded p-2" style="width: 64px; height: 64px; object-fit: contain;">
          <h5 id="splitItemName" class="mt-2"></h5>
          <span class="badge bg-secondary" id="splitItemCount"></span>
        </div>

        <div class="form-group">
          <label for="splitItemQuantity" class="form-label">{{phrase('unstack_item_count_desc')}}:</label>
          <input type="number" class="form-control" id="splitItemQuantity" min="1" value="1">
          <div class="invalid-feedback">
            {{phrase('unstack_item_count_min_1')}}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{phrase('cancel')}}</button>
        <button type="button" class="btn btn-primary" id="confirmSplitItem">{{phrase('unstack')}}</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно склада с JS-селекторами -->
<div class="modal fade" id="warehouseModal" tabindex="-1" aria-labelledby="warehouseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- Заголовок -->
      <div class="modal-header border-0">
        <h5 class="modal-title d-flex align-items-center" id="warehouseModalLabel">
          <i class="ri-archive-line me-2 text-primary"></i>
          {{phrase('warehouse')}}
          {% if getUser().countWarehouseItems() > 0 %}
          <span class="badge rounded-pill bg-danger ms-2 js-warehouse-modal-count countWarehouseItems">{{getUser().countWarehouseItems()}}</span>
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Основное содержимое -->
      <div class="modal-body">
        {% if not getUser().isAuth() %}
        <!-- Блок для неавторизованных пользователей -->
          <div class="alert alert-danger d-flex" role="alert">
            <i class="ri-login-box-line fs-4 me-2"></i>
            <div>{{phrase('first_reg_then_own_items_wh')}}</div>
          </div>
        {% else %}
        <!-- Блок для авторизованных пользователей -->
          <div class="row">
            <!-- Левая панель: список предметов -->
            <div class="col-md-7 pe-md-2">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">{{ phrase(301) }}</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="selectAllItems" checked >
                      <label class="form-check-label small" for="selectAllItems">
                        {{phrase('sel_all_items')}}
                      </label>
                    </div>
                  </div>
                </div>

                <div class="card-body p-0" style="max-height: 50vh; overflow-y: auto;">
                  {% if getUser().countWarehouseItems() == 0 %}
                  <!-- Пустой склад -->
                    <div class="text-center p-4">
                      <i class="ri-inbox-line text-muted display-4"></i>
                      <p class="mt-2 text-muted">{{phrase('no_items_send_char')}}</p>
                    </div>
                  {% else %}
                  <!-- Список предметов -->
                    <ul class="list-group list-group-flush js-warehouse-items-list">
        {% set okStackBtn = false %}

{% for warehouse in getUser().getWarehouse() %}
  <li class="list-group-item list-group-item-action p-1 border-bottom js-warehouse-item" data-item-count="{{warehouse.count}}">
    <div class="d-flex align-items-center">
      <div class="form-check me-2">
        <input data-object-id="{{warehouse.id}}"
               class="form-check-input warehouseInventory js-warehouse-item-checkbox"
               type="checkbox" id="item_{{warehouse.id}}" checked>
      </div>
      <div class="item-icon me-3">
        <div class="position-relative">
          <img src="{{warehouse.item.getIcon()}}"
               alt="{{warehouse.item.getItemName()}}"
               class="img-fluid border rounded p-1 js-item-icon"
               style="width: 40px; height: 40px; object-fit: contain;">
        </div>
      </div>
      <div class="item-details-n flex-grow-1">
        <div class="fw-medium d-flex justify-content-between align-items-center">
          <div>
            {% if warehouse.enchant > 0 %}
              <span class="badge bg-danger me-1">+{{warehouse.enchant}}</span>
            {% endif %}
            <label class="mb-0 cursor-pointer js-item-name" for="item_{{warehouse.id}}">
              {{warehouse.item.getItemName()}}

              {% if warehouse.count > 1 %}
              <span class="bottom-0 end-0 badge rounded-pill bg-secondary js-item-count">
                x{{warehouse.count}}
              </span>
            {% endif %}
            </label>
          </div>
          <div>

          {% set unstackOk = false %}
          {% if getServer().stackableItem().allowAllItemsSplitting() %}
              {% set unstackOk = true %}
          {% endif %}

          {% if unstackOk == false %}
            {% for id in getServer().stackableItem().getSplittableItems() %}
                {% if id == warehouse.item.getItemId() %}
                  {% set unstackOk = true %}
                {% endif %}
            {% endfor %}
          {% endif %}

          {% if warehouse.count > 1 and unstackOk %}
             <span role="button" class="badge bg-blue splitItem js-split-item-btn me-1">{{phrase('unstack')}}</span>
          {% endif %}



          </div>
        </div>
        <div class="small text-muted">{{phrase(warehouse.phrase)}}</div>
      </div>
    </div>
  </li>


        {% if getServer().stackableItem().isAllowAllItemsStacking() %}
            {% set okStackBtn = true %}
        {% endif %}

        {% if okStackBtn == false %}
            {% for id in getServer().stackableItem().getStackableItems() %}
                {% if id == warehouse.getItemId() %}
                    {% set okStackBtn = true %}
                {% endif %}
            {% endfor %}
        {% endif %}

{% endfor %}
                    </ul>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Правая панель: управление отправкой -->
            <div class="col-md-5 mt-3 mt-md-0 ps-md-2">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent">
                  <span class="fw-bold">{{phrase('send_to_char')}}</span>
                </div>
                <div class="card-body">
                  <!-- Блок выбора персонажа -->
                  {% if getUser().getCountPlayers() == 0 %}
                    <div class="alert alert-info d-flex mb-3" role="alert">
                      <i class="ri-user-3-line fs-5 me-2"></i>
                      <div>{{phrase('no_chars_send_items_wh')}}</div>
                    </div>
                  {% else %}
                    <div class="mb-3">
                      <label for="warehousePlayerSend" class="form-label">
                        {{ phrase(76) }}:
                      </label>
                      <select class="form-select form-select-lg"
                              id="warehousePlayerSend"
                              name="warehousePlayerSend"
                              {% if statusSphereServer() is same as(false) %}disabled{% endif %}>
                        {% set isPlayers = false %}
                        {% for i, account in getUser().getAccounts() %}
                          <optgroup label="{{account.getAccount()}}">
                            {% if account.getCharactersCount() == 0 %}
                              <option disabled>{{phrase('no_chars')}}</option>
                            {% else %}
                              {% for i, character in account.getCharacters() %}
                                {% set isPlayers = true %}
                                <option value="{{character.getPlayerId()}}"
                                        data-account="{{account.getAccount()}}"
                                        data-character="{{character.getPlayerName()}}">
                                  {{character.getPlayerName()}} [{{character.getLevel()}}]
                                </option>
                              {% endfor %}
                            {% endif %}
                          </optgroup>
                        {% endfor %}
                      </select>
                    </div>
                  {% endif %}

                  <!-- Статус сервера -->
                  {% if statusSphereServer() is same as(false) %}
                    <div class="alert alert-danger d-flex mb-3" role="alert">
                      <i class="ri-server-line fs-5 me-2"></i>
                      <div>Сервер недоступен</div>
                    </div>
                  {% endif %}

                  <!-- Кнопка отправки -->
                  <button type="button"
                          id="warehouseSendItemsToPlayer"
                          class="btn btn-primary btn-lg w-100 mt-2"
                          {% if not isPlayers|default(false) or statusSphereServer() is same as(false) or getUser().countWarehouseItems() == 0 %}
                          disabled
                          {% endif %}>
                    <i class="ri-send-plane-line me-2"></i>
                    {{phrase('send_items')}}
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="modal-footer border-0">



        {% if okStackBtn == true %}
            <button type="button" class="btn btn-primary me-auto" id="goStackItems">
                {{phrase('stack_items')}}
            </button>
        {% endif %}

        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          {{phrase('close')}}
        </button>
      </div>


    </div>
  </div>
</div>


<script>

$(document).ready(function() {
  $('.slide.warehouse .side-menu__item').on('mousedown', function(e) {
    if (e.which === 2) {
      e.preventDefault();
      $('#warehouseModal').modal('show');
      return false;
    }
  });
});

/**
 * Определяет, можно ли разбить данный предмет
 *
 * @param {Object} item - объект предмета
 * @param {boolean} isAllowAllItemsSplitting - разрешено ли разбивать все предметы
 * @param {Array} splittableItems - массив ID предметов, которые можно разбивать
 * @returns {boolean} - можно ли разбить предмет
 */
function determineIfItemCanBeSplit(item, isAllowAllItemsSplitting, splittableItems) {
  // Предмет должен иметь количество больше 1
  if (!item || item.count <= 1) {
    return false;
  }

  // Проверяем, stackable ли предмет
  const isStackable = item.itemInfo && item.itemInfo.isStackable === true;
  if (!isStackable) {
    return false;
  }

  // Проверяем, разрешено ли разбивать все предметы
  if (isAllowAllItemsSplitting) {
    return true;
  }

  // Проверяем, входит ли ID предмета в список разрешенных для разбития
  return Array.isArray(splittableItems) && splittableItems.includes(item.itemId.toString());
}

/**
 * Обработчик для кнопки "Разбить" предмет
 */
$(document).on('click', '.js-split-item-btn', function(e) {
  e.preventDefault();
  e.stopPropagation();

  // Находим родительский элемент list-item
  const $listItem = $(this).closest('.js-warehouse-item');
  const $checkbox = $listItem.find('.js-warehouse-item-checkbox');

  // Извлекаем данные о предмете
  const objectId = $checkbox.data('object-id');
  const itemName = $listItem.find('.js-item-name').text().trim();
  const itemIcon = $listItem.find('.js-item-icon').attr('src');
  let itemCount = $listItem.data('item-count') || 1;

  // Заполняем модальное окно данными
  $('#splitItemIcon').attr('src', itemIcon);
  $('#splitItemName').text(itemName);
  $('#splitItemCount').text('Доступно: ' + itemCount);

  // Настраиваем поле ввода
  const $quantityInput = $('#splitItemQuantity');
  $quantityInput.attr('max', itemCount - 1);
  $quantityInput.val(1);
  $quantityInput.removeClass('is-invalid');

  // Валидация поля ввода при изменении
  $quantityInput.off('input').on('input', function() {
    const value = parseInt($(this).val());
    const max = parseInt($(this).attr('max'));

    if (isNaN(value) || value < 1 || value > max) {
      $(this).addClass('is-invalid');
      $('#confirmSplitItem').prop('disabled', true);
    } else {
      $(this).removeClass('is-invalid');
      $('#confirmSplitItem').prop('disabled', false);
    }
  });

  // Сохраняем ID объекта в кнопке подтверждения
  $('#confirmSplitItem').data('object-id', objectId).prop('disabled', false);

  // Перемещаем модальное окно разбития в конец body, если оно ещё там не находится
  if (!$('#splitItemModal').parent().is('body')) {
    $('#splitItemModal').appendTo('body');
  }

  // Сохраняем первое модальное окно, чтобы правильно к нему вернуться
  $('#splitItemModal').data('parentModal', $('#warehouseModal')[0]);

  // Важно: скрываем backdrop первого модального окна перед открытием второго
  $('.modal-backdrop').last().css('opacity', '0');

  // Настраиваем z-index для корректного отображения
  setTimeout(function() {
    const zIndexBase = 1050;
    const backdropCount = $('.modal-backdrop').length;

    // Настраиваем z-index для нового модального окна
    $('#splitItemModal').css('z-index', zIndexBase + (backdropCount * 10) + 10);

    // Находим последний backdrop и настраиваем его z-index и непрозрачность
    $('.modal-backdrop').last().css({
      'z-index': zIndexBase + (backdropCount * 10) + 5,
      'opacity': '0.5'
    });
  }, 50);

  // Открываем модальное окно
  const splitModal = new bootstrap.Modal(document.getElementById('splitItemModal'));
  splitModal.show();
});

$('#splitItemModal').on('hidden.bs.modal', function() {
  // Восстанавливаем видимость backdrop первого модального окна
  $('.modal-backdrop').last().css('opacity', '0.5');
});


/**
 * Система управления модальными окнами для правильной работы вложенных модальных окон
 * Этот код заменяет предыдущую реализацию, вызывающую конфликты
 */
(function() {
  // Проверяем, существует ли уже этот объект
  if (window.modalManager) return;

  // Создаем менеджер модальных окон
  window.modalManager = {
    // Стек открытых модальных окон
    _openedModals: [],

    // Инициализация менеджера
    init: function() {
      // Добавляем базовые стили для модальных окон
      const styles = `
        /* Базовый z-index для модальных окон */
        .modal {
          z-index: 1050;
        }

        /* Базовый z-index для backdrop */
        .modal-backdrop {
          z-index: 1040;
        }

        /* Стили для вложенных модальных окон */
        .modal.level-1 {
          z-index: 1060 !important;
        }

        .modal-backdrop.level-1 {
          z-index: 1050 !important;
        }

        .modal.level-2 {
          z-index: 1070 !important;
        }

        .modal-backdrop.level-2 {
          z-index: 1060 !important;
        }

        /* Для корректного отображения вложенных модальных окон */
        body.multiple-modals-open {
          overflow: hidden;
        }

        /* Предотвращаем скрытие модального окна */
        body.multiple-modals-open .modal.show {
          overflow-x: hidden;
          overflow-y: auto;
        }
      `;

      const styleElem = document.createElement('style');
      styleElem.innerHTML = styles;
      document.head.appendChild(styleElem);

      // Обработчики событий для модальных окон
      this._setupEventListeners();
    },

    // Настройка обработчиков событий
    _setupEventListeners: function() {
      const self = this;

      // Отслеживаем открытие модального окна
      $(document).on('shown.bs.modal', '.modal', function(e) {
        const modalId = $(this).attr('id');

        // Если это новое модальное окно (не то, что уже в стеке)
        if (!self._openedModals.includes(modalId)) {
          self._openedModals.push(modalId);

          // Добавляем класс для отслеживания множественных модальных окон
          if (self._openedModals.length > 1) {
            $('body').addClass('multiple-modals-open');
          }

          // Назначаем уровень для модального окна и последнего backdrop
          const level = self._openedModals.length - 1;
          $(this).addClass('level-' + level);

          // Находим последний добавленный backdrop и назначаем ему класс уровня
          $('.modal-backdrop').last().addClass('level-' + level);

          // Исправляем z-index для правильного порядка
          self._adjustModalLevels();
        }
      });

      // Отслеживаем закрытие модального окна
      $(document).on('hidden.bs.modal', '.modal', function(e) {
        const modalId = $(this).attr('id');

        // Удаляем модальное окно из стека
        const index = self._openedModals.indexOf(modalId);
        if (index > -1) {
          self._openedModals.splice(index, 1);

          // Удаляем класс уровня
          $(this).removeClass(function(index, className) {
            return (className.match(/(^|\s)level-\S+/g) || []).join(' ');
          });

          // Если больше нет открытых модальных окон, удаляем класс
          if (self._openedModals.length <= 1) {
            $('body').removeClass('multiple-modals-open');
          }

          // Удаляем лишние backdrop элементы
          self._cleanupBackdrops();

          // Перенастраиваем уровни оставшихся модальных окон
          self._adjustModalLevels();
        }
      });

      // Кнопка для открытия модального окна разбиения предметов
      $(document).on('click', '.js-split-item-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Логика открытия модального окна разбиения предметов
        const $listItem = $(this).closest('.js-warehouse-item');
        const $checkbox = $listItem.find('.js-warehouse-item-checkbox');

        // Получаем данные предмета и заполняем модальное окно
        const objectId = $checkbox.data('object-id');
        const itemName = $listItem.find('.js-item-name').text().trim();
        const itemIcon = $listItem.find('.js-item-icon').attr('src');
        const itemCount = $listItem.data('item-count') || 1;

        $('#splitItemIcon').attr('src', itemIcon);
        $('#splitItemName').text(itemName);
        $('#splitItemCount').text('Доступно: ' + itemCount);

        // Настраиваем поле ввода
        const $quantityInput = $('#splitItemQuantity');
        $quantityInput.attr('max', itemCount - 1);
        $quantityInput.val(1);
        $quantityInput.removeClass('is-invalid');

        // Валидация при изменении значения
        $quantityInput.off('input').on('input', function() {
          const value = parseInt($(this).val());
          const max = parseInt($(this).attr('max'));

          if (isNaN(value) || value < 1 || value > max) {
            $(this).addClass('is-invalid');
            $('#confirmSplitItem').prop('disabled', true);
          } else {
            $(this).removeClass('is-invalid');
            $('#confirmSplitItem').prop('disabled', false);
          }
        });

        // Сохраняем ID объекта в кнопке подтверждения
        $('#confirmSplitItem').data('object-id', objectId).prop('disabled', false);

        // Открываем модальное окно разбиения
        const splitModal = new bootstrap.Modal(document.getElementById('splitItemModal'));
        splitModal.show();
      });
    },

    // Корректировка уровней модальных окон
    _adjustModalLevels: function() {
      // Перенастраиваем уровни для всех открытых модальных окон
      for (let i = 0; i < this._openedModals.length; i++) {
        const modalId = this._openedModals[i];
        const modal = $('#' + modalId);

        // Удаляем все предыдущие классы уровней
        modal.removeClass(function(index, className) {
          return (className.match(/(^|\s)level-\S+/g) || []).join(' ');
        });

        // Добавляем новый класс уровня
        modal.addClass('level-' + i);
      }

      // Находим все backdrop и корректируем их классы
      $('.modal-backdrop').each(function(index) {
        $(this).removeClass(function(idx, className) {
          return (className.match(/(^|\s)level-\S+/g) || []).join(' ');
        });

        if (index < this._openedModals.length) {
          $(this).addClass('level-' + index);
        }
      }.bind(this));
    },

    // Удаление лишних backdrop элементов
    _cleanupBackdrops: function() {
      // Проверяем количество backdrop элементов
      const backdropCount = $('.modal-backdrop').length;
      const modalCount = this._openedModals.length;

      // Если backdrop больше, чем открытых модальных окон, удаляем лишние
      if (backdropCount > modalCount) {
        // Оставляем только нужное количество backdrop
        $('.modal-backdrop').slice(modalCount).remove();
      }
    }
  };

  // Инициализация менеджера модальных окон при загрузке страницы
  $(document).ready(function() {
    window.modalManager.init();
  });
})();

/**
 * Обработчик подтверждения разбития предмета
 */
$('#confirmSplitItem').off('click').on('click', function() {
  const objectId = $(this).data('object-id');
  const quantity = parseInt($('#splitItemQuantity').val());
  const $button = $(this);
  const originalButtonText = $button.text();

  // Валидация
  if (isNaN(quantity) || quantity < 1) {
    $('#splitItemQuantity').addClass('is-invalid');
    return;
  }

  // Показываем индикатор загрузки
  $button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Выполняется...').prop('disabled', true);

  // Отправляем AJAX запрос
  AjaxSend('/inventory/warehouse/split-item', 'POST', {
    objectId: objectId,
    quantity: quantity
  }).then(function(response) {
    // Обрабатываем ответ
    if (response.ok === true) {
      noticeSuccess(response.message || '{{phrase("unstack_success")}}');

      // Закрываем модальное окно
      const splitModal = bootstrap.Modal.getInstance(document.getElementById('splitItemModal'));
      if (splitModal) {
        splitModal.hide();
      }

      // Обновляем список предметов
      if (response.items && Array.isArray(response.items)) {
        updateWarehouseItemsList(response);
      }
    } else {
      noticeError(response.message || '{{phrase("error_unstack_success")}}');
    }
  }).catch(function(error) {
    noticeError('Ошибка соединения с сервером');
    console.error('Ошибка запроса:', error);
  }).finally(function() {
    // Восстанавливаем кнопку
    $button.html(originalButtonText).prop('disabled', false);
  });
});



// Инициализация обработчиков для чекбокса "Выбрать все"
$(document).ready(function() {
  // Обработчик для чекбокса "Выбрать все"
  $('#selectAllItems').off('change').on('change', function() {
    const isChecked = $(this).prop('checked');
    $('.js-warehouse-items-list .js-warehouse-item-checkbox').prop('checked', isChecked);
  });

  // Обработчик для отдельных чекбоксов предметов
  $(document).on('change', '.js-warehouse-item-checkbox', function() {
    const totalCheckboxes = $('.js-warehouse-items-list .js-warehouse-item-checkbox').length;
    const checkedCheckboxes = $('.js-warehouse-items-list .js-warehouse-item-checkbox:checked').length;

    $('#selectAllItems').prop('checked', totalCheckboxes === checkedCheckboxes);
  });

  // Обработчик для кнопки "Объединить предметы"
  $("#goStackItems").off('click').on('click', function() {
    const $button = $(this);
    $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Выполняется...');

    AjaxSend('/inventory/warehouse/stack', 'POST', {}, true)
          .then(function(response) {
            $button.prop('disabled', false).html('{{phrase("stack_items")}}');

            if (response.success) {
              noticeSuccess(response.message || '{{phrase("success_stack")}}');
              updateWarehouseItemsList(response);
            } else {
              noticeError(response.message || '{{phrase("error_stack")}}');
            }
          })
          .catch(function(error) {
            $button.prop('disabled', false).html('{{phrase("stack_items")}}');
            noticeError('Error');
            console.error('Ошибка запроса:', error);
          });
  });
});

</script>


<script>

/**
 * Модуль для обработки действий со складом (warehouse)
 * Обрабатывает отправку предметов персонажу и удаление их из интерфейса после успешной отправки
 * Обновляет счетчик предметов на складе на основе ответа сервера
 */
$(document).ready(function() {
  // Переопределение обработчика нажатия на кнопку отправки предметов
  $(document).off('click', '#warehouseSendItemsToPlayer').on('click', '#warehouseSendItemsToPlayer', function() {
    const selectedOption = $('#warehousePlayerSend option:selected');
    const account = selectedOption.data('account');
    const character = selectedOption.data('character');

    // Получаем список выбранных предметов
    const selectedItems = [];
    $('.warehouseInventory:checked').each(function() {
      const objectId = $(this).data('object-id');
      if (objectId) {
        selectedItems.push(objectId);
      }
    });

    // Проверяем, есть ли выбранные предметы
    if (selectedItems.length === 0) {
      noticeError('{{phrase("min_1_item_for_send")}}');
      return;
    }

    // Блокируем кнопку и показываем индикатор загрузки
    const $sendButton = $(this);
    $sendButton.prop('disabled', true).html('<i class="ri-loader-2-line me-2"></i> {{phrase("submitting_an_item")}}...');

    // Отправляем запрос на сервер
    AjaxSend('/inventory/send', 'POST', {
      items: selectedItems,
      player: character,
      account: account
    }).then(function(response) {

      // Обработка ответа
      if (response.ok === true) {
        // Если есть предметы для удаления
        if (response.removeObject && Array.isArray(response.removeObject) && response.removeObject.length > 0) {
          // Удаляем предметы из DOM
          handleItemRemoval(response.removeObject);
        }

        // Обновляем счетчик на основе данных из ответа сервера
        if (response.hasOwnProperty('countWarehouseItems')) {
          updateWarehouseCounter(response.countWarehouseItems);
        }

        // Показываем сообщение об успехе
        if (response.message) {
          noticeSuccess(response.message);
        }
      } else {
        // Показываем сообщение об ошибке
        if (response.message) {
          noticeError(response.message);
        } else {
          noticeError('Произошла ошибка при отправке предметов');
        }
      }

      // Восстанавливаем кнопку
      $sendButton.prop('disabled', false).html('<i class="ri-send-plane-line me-2"></i> {{phrase("send_items")}}');
    }).catch(function(error) {
      console.error('Ошибка запроса:', error);
      noticeError('Ошибка соединения с сервером');

      // Восстанавливаем кнопку
      $sendButton.prop('disabled', false).html('<i class="ri-send-plane-line me-2"></i> {{phrase("send_items")}}');
    });
  });

  /**
   * Обработка удаления предметов из DOM после успешной отправки
   * @param {Array} items - массив объектов предметов для удаления
   */
  function handleItemRemoval(items) {
    console.log('Удаление предметов:', items);

    // Перебираем все предметы для удаления
    items.forEach(function(item) {
      // Находим элемент DOM по ObjectId
      const $itemElement = $('.warehouseInventory[data-object-id="' + item.objectId + '"]').closest('li.list-group-item');

      if ($itemElement.length > 0) {
        // Плавно скрываем и удаляем элемент
        $itemElement.fadeOut(300, function() {
          $(this).remove();

          // Если это был последний предмет, показываем сообщение о пустом складе
          checkIfWarehouseEmpty();
        });
      }
    });
  }

  /**
   * Проверяет, остались ли предметы на складе, и если нет, показывает сообщение о пустом складе
   */
  function checkIfWarehouseEmpty() {
    if ($('.warehouseInventory').length === 0) {
      // Создаем HTML для пустого склада
      const emptyWarehouseHTML = `
        <div class="text-center p-4">
          <i class="ri-inbox-line text-muted display-4"></i>
          <p class="mt-2 text-muted">{{phrase('warehouse_is_empty')}}</p>
        </div>
      `;

      // Заменяем содержимое списка
      const $listContainer = $('ul.list-group.list-group-flush', '#warehouseModal');
      if ($listContainer.length) {
        $listContainer.replaceWith(emptyWarehouseHTML);
      } else {
        $('#warehouseModal .card-body').first().html(emptyWarehouseHTML);
      }

      // Блокируем кнопку отправки
      $('#warehouseSendItemsToPlayer').prop('disabled', true);
    }
  }

  /**
   * Обновляет счетчик предметов на складе
   * @param {number} count - количество предметов на складе из ответа сервера
   */
  function updateWarehouseCounter(count) {
    const $badgeElement = $('.countWarehouseItems');

    if (count > 0) {
      // Если есть предметы, обновляем все счетчики на странице
      $badgeElement.text(count);

      // Обновляем badge в заголовке модального окна, если он есть
      const $modalBadge = $('#warehouseModalLabel .badge');
      if ($modalBadge.length > 0) {
        $modalBadge.text(count);
      } else if (count > 0) {
        $('#warehouseModalLabel').append(`<span class="badge rounded-pill bg-danger ms-2 countWarehouseItems">${count}</span>`);
      }
    } else {
      // Если предметов нет, удаляем все счетчики
      $badgeElement.remove();
      $('#warehouseModalLabel .badge').remove();
    }
  }


});

</script>

{% endif %}
