{% extends 'struct.html' %}

{% block title %}{{ phrase('technical support') }}{% endblock %}

{% block content %}

<div class="container-fluid">

    {% if config().enabled().isEnableSupport() == false %}
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-body">
                <blockquote class="blockquote mb-0 text-center">
                    <h6 class="text-danger">{{ phrase('Technical support is disabled') }}</h6>
                    <h6 class="">{{ phrase('As an administrator/moderator you can use this section') }}</h6>
                </blockquote>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="main-mail-container gap-4 mb-5 d-lg-flex">
        <div class="mail-navigation">
            <div class="d-grid align-items-top p-2 border-bottom">
                <a href="{% if getUser().isAuth() %}/support/new{% else %}/login{% endif %}" type="button"
                    class="btn btn-primary btn-sm d-flex align-items-center justify-content-center">
                    <i class="ri-add-circle-line fs-16 align-middle me-1"></i>{{ phrase('Ask a question') }}
                </a>
                {% if getUser().isAdmin() or isUserModerator %}
                <button type="button" class="btn btn-success btn-sm d-flex align-items-center justify-content-center mt-2"
                    data-bs-toggle="modal" data-bs-target="#writeToUserModal">
                    <i class="ri-message-3-line fs-16 align-middle me-1"></i>{{ phrase('Write') }}
                </button>
                {% endif %}
                {% if not getUser().isAdmin() and not isUserModerator and threads|length == 0 %}
                <div class="mt-2 text-center">
                    <small class="text-muted">{{ phrase('Create your first support request') }}</small>
                </div>
                {% endif %}
            </div>
            <div>
                <ul class="list-unstyled mail-main-nav" id="mail-main-nav">
                    {% for section in sections %}
                    <li class="{% if currentSection is defined and currentSection == section.id %}active{% endif %}">
                        <a href="/support/thread/{{section.id}}">
                            <div class="d-flex align-items-center">
                                <span class="me-2 lh-1">
                                    <i class="ri-inbox-archive-line align-middle fs-14"></i>
                                </span>
                                <span class="flex-fill text-nowrap">
                                    {{phrase(section.thread_name)}}
                                </span>
                                <span class="badge bg-info-transparent rounded-1">{{section.thread_count}}</span>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>

                {% if getUser().isAdmin() %}
                <div class="card-footer text-center">
                    <a href="/support/admin/add/section" data-bs-toggle="modal" data-bs-target="#add-section"
                        class="btn btn-sm btn-primary-light m-1"><i
                            class="ri-bar-chart-horizontal-line me-2 align-middle d-inline-block"></i>{{
                        phrase('Categories') }}</a>
                    <a href="/support/admin/add/moderator" data-bs-toggle="modal" data-bs-target="#add-moderator"
                        class="btn btn-sm btn-success-light m-1"><i
                            class="ri-group-line me-2 align-middle d-inline-block"></i>{{ phrase('Add moderator') }}</a>
                </div>
                {% endif %}

            </div>

        </div>


        <div class="modal modal-lg fade" id="add-section" tabindex="-1" aria-labelledby="add-sectionLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="add-sectionLabel">{{ phrase('Categories') }}</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body px-4">
                        <div class="row">
                            <div class="col-xl-6 mb-2">
                                <label for="phraseId" class="form-label"><a target="_blank"
                                        href="/admin/phrases/custom">{{
                                        phrase('Phrase ID category name') }}</a><sup><i
                                            class="ri-star-s-fill text-danger fs-8"></i></sup></label>
                                <input type="text" class="form-control" id="phraseId" value="">
                                <button id="add_section" type="button" class="btn btn-sm btn-success mt-2"><i
                                        class="ri-stack-line me-2"></i> {{ phrase(438) }}
                                </button>
                                <script>
                                    $("#add_section").on("click", function () {
                                        phraseId = $("#phraseId").val();
                                        AjaxSend("/support/admin/add/section", "POST", { phraseId: phraseId }, false);
                                    })
                                </script>
                            </div>
                            <div class="col-xl-6 mb-2">
                                <label class="form-label">{{ phrase('Removing categories') }}</label>

                                <div class="card-body" id="section_delete_list">

                                    {% for section in sections %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{section.id}}"
                                            id="remove_section_{{section.id}}">
                                        <label class="form-check-label" for="remove_section_{{section.id}}">
                                            {{phrase(section.thread_name)}}
                                        </label>
                                    </div>
                                    {% endfor %}

                                </div>

                                <button id="delete_section" type="button" class="btn btn-sm btn-danger mt-2"><i
                                        class="ri-delete-bin-line me-2"></i> {{ phrase('Removal') }}
                                </button>
                                <script>
                                    $("#delete_section").on("click", function () {
                                        let ids = [];
                                        $("#section_delete_list .form-check-input:checked").each(function () {
                                            ids.push($(this).val());
                                        });
                                        if (ids.length === 0) {
                                            noticeError("Нет выбранных элементов")
                                            return;
                                        }
                                        AjaxSend("/support/admin/delete/section", "POST", { ids: ids }, false)
                                    });
                                </script>

                            </div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{ phrase('close') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if getUser().isAdmin() %}
        <div class="modal modal-lg fade" id="add-moderator" tabindex="-1" aria-labelledby="add-moderatorLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="add-moderatorLabel">{{ phrase('Setting up moderators') }}</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body px-4">
                        <div class="row">

                            <div class="col-xl-6 mb-2">
                                <label for="selectEmailToModerator" class="form-label">{{ phrase('user') }}<sup><i
                                            class="ri-star-s-fill text-success fs-8"></i></sup></label>
                                <select class="form-control" name="toMail" id="selectEmailToModerator">
                                    {% for user in getUsers() %}
                                    <option value="{{user.getEmail()}}">{{user.getEmail()}}</option>
                                    {% endfor %}
                                </select>
                                <button id="add_moderator" type="button" class="btn btn-sm btn-primary me-2">{{
                                    phrase('Add moderator') }}
                                </button>

                                <script>
                                    $("#add_moderator").on("click", function () {
                                        // Получаем выбранный email
                                        const selectedEmail = $("#selectEmailToModerator").val();

                                        if (!selectedEmail) {
                                            alert("Выберите пользователя!");
                                            return;
                                        }

                                        // Находим все отмеченные чекбоксы
                                        $("#section_moderator_list .form-check-input:checked").each(function () {
                                            const sectionId = $(this).val();
                                            const tableId = `#section_moderator_list_${sectionId}`;

                                            // Проверяем, есть ли уже такой email в таблице
                                            const existingEmails = $(`${tableId} tbody tr td.email-cell`).map(function () {
                                                return $(this).text();
                                            }).get();

                                            if (!existingEmails.includes(selectedEmail)) {
                                                // Добавляем нового модератора в таблицу
                                                const newRow = `
                    <tr>
                        <td class="email-cell">${selectedEmail}</td>
                        <td class="action-cell">
                            <button type="button" class="btn btn-sm btn-danger remove-moderator">
                                {{ phrase('delete') }}
                            </button>
                        </td>
                    </tr>`;
                                                $(`${tableId} tbody`).append(newRow);
                                            }
                                        });
                                    });

                                    // Делегируем событие на удаление, чтобы работало для новых строк
                                    $(document).on("click", ".remove-moderator", function () {
                                        $(this).closest("tr").remove();
                                    });
                                </script>


                            </div>

                            <div class="col-xl-6 mb-2">
                                <label for="section_moderator_list" class="form-label">{{ phrase('Select category')
                                    }}<sup><i class="ri-star-s-fill text-success fs-8"></i></sup></label>
                                <div class="card-body" id="section_moderator_list">

                                    {% for section in sections %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{section.id}}"
                                            id="moderator_section_{{section.id}}">
                                        <label class="form-check-label" for="moderator_section_{{section.id}}">
                                            {{phrase(section.thread_name)}}
                                        </label>

                                        <div class="table-responsive">
                                            <table data-section-id="{{section.id}}"
                                                id="section_moderator_list_{{section.id}}"
                                                class="table table-sm table-bordered table-hover text-nowrap">
                                                <tbody>
                                                    {% for moderator in section.moderators %}
                                                    <tr>
                                                        <td class="email-cell">{{moderator}}</td>
                                                        <td class="action-cell">
                                                            <button type="button"
                                                                class="btn btn-sm btn-danger remove-moderator">
                                                                Удалить
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                    {% endfor %}

                                </div>
                            </div>

                        </div>
                        <div class="d-flex justify-content-center align-items-center">
                            <button id="update_moderator" type="button" class="btn btn-sm btn-success">{{ phrase(271)
                                }}
                            </button>
                        </div>

                        <script>
                            $("#update_moderator").on("click", function () {
                                const data = [];

                                // Перебираем каждую секцию
                                $("#section_moderator_list .form-check").each(function () {
                                    const sectionId = $(this).find(".form-check-input").val();
                                    const tableId = `#section_moderator_list_${sectionId}`;
                                    const emails = [];

                                    // Собираем email-ы модераторов из таблицы секции
                                    $(`${tableId} tbody tr td.email-cell`).each(function () {
                                        emails.push($(this).text());
                                    });

                                    // Если есть хотя бы один модератор, добавляем данные в массив
                                    if (emails.length > 0) {
                                        data.push({
                                            id: sectionId,
                                            moderators: emails
                                        });
                                    }
                                });

                                AjaxSend("/support/admin/update/moderator", "POST", { data });
                            });

                        </script>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{phrase('close')}}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if getUser().isAdmin() or isUserModerator %}
        <!-- Модальное окно для выбора пользователя -->
        <div class="modal fade" id="writeToUserModal" tabindex="-1" aria-labelledby="writeToUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="writeToUserModalLabel">
                            <i class="ri-message-3-line me-2"></i>{{ phrase('Write to user') }}
                        </h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="supportSectionSelect" class="form-label">{{ phrase('Support category') }} <sup class="text-danger">*</sup></label>
                            <select class="form-control" id="supportSectionSelect" required>
                                {% for section in sections %}
                                <option value="{{section.id}}" {% if loop.first %}selected{% endif %}>{{phrase(section.thread_name)}}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">{{ phrase('Select category for request') }}</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userSearchInput" class="form-label">{{ phrase('Search user') }}</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="ri-search-line"></i>
                                </span>
                                <input type="text" class="form-control" id="userSearchInput" 
                                    placeholder="{{ phrase('Enter name, email or user ID') }}..." autocomplete="off">
                            </div>
                            <small class="text-muted">{{ phrase('Start typing to search users') }}</small>
                        </div>

                        <div class="mb-2 d-flex justify-content-between align-items-center">
                            <div>
                                <span id="selectedUsersCount" class="badge bg-primary">{{ phrase('Selected') }}: 0</span>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllUsers">
                                    <i class="ri-checkbox-multiple-line me-1"></i>{{ phrase('Select all') }}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllUsers">
                                    <i class="ri-checkbox-blank-line me-1"></i>{{ phrase('Deselect all') }}
                                </button>
                            </div>
                        </div>
                        
                        <div id="usersListContainer" class="border rounded" style="max-height: 500px; overflow-y: auto;">
                            <div id="usersList" class="list-group list-group-flush"></div>
                            <div id="usersListLoading" class="text-center p-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ phrase('Loading') }}...</span>
                                </div>
                                <p class="text-muted mt-2 mb-0">{{ phrase('Loading users') }}...</p>
                            </div>
                            <div id="usersListEmpty" class="text-center p-4 text-muted" style="display: none;">
                                <i class="ri-user-unfollow-line fs-48 mb-3 d-block"></i>
                                <p class="mb-0">{{ phrase('Users not found') }}</p>
                            </div>
                        </div>
                        
                        <!-- Пагинация -->
                        <div id="usersPagination" class="mt-3 d-flex justify-content-center align-items-center" style="display: none !important;">
                            <nav aria-label="{{ phrase('Page navigation') }}">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item" id="paginationPrev">
                                        <a class="page-link" href="#" aria-label="{{ phrase('Previous') }}">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <span class="page-link" id="paginationInfo">{{ phrase('Page') }} 1 {{ phrase('of') }} 1</span>
                                    </li>
                                    <li class="page-item" id="paginationNext">
                                        <a class="page-link" href="#" aria-label="{{ phrase('Next') }}">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="sendToSelectedUsers" disabled>
                            <i class="ri-send-plane-line me-1"></i>{{ phrase('Send to selected') }} (<span id="selectedCountFooter">0</span>)
                        </button>
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{ phrase('cancel') }}</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно для ввода сообщения при массовой отправке -->
        <div class="modal fade" id="massMessageModal" tabindex="-1" aria-labelledby="massMessageModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="massMessageModalLabel">
                            <i class="ri-mail-send-line me-2"></i>{{ phrase('Mass message sending') }}
                        </h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="ri-information-line me-2"></i>
                            {{ phrase('Message will be sent to') }} <strong id="massMessageUsersCount">0</strong> {{ phrase('selected users') }}
                        </div>
                        <div class="mb-3">
                            <label for="massMessageEditor" class="form-label">{{ phrase('Message') }} <sup class="text-danger">*</sup></label>
                            <div id="massMessageEditor"></div>
                            <small class="text-muted">{{ phrase('Enter message text that will be sent to all selected users') }}</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{ phrase('cancel') }}</button>
                        <button type="button" class="btn btn-success" id="confirmMassSend">
                            <i class="ri-send-plane-line me-1"></i>{{ phrase('Send') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="total-mails mt-5 mt-lg-0">
            <div class="p-1 d-flex align-items-center border-bottom">
                <div class="mail-option-read d-md-flex d-block">
                    {% if main %}
                    <a aria-label="anchor" href="javascript:location.reload();" class="vertical-phone"
                        data-bs-toggle="tooltip" data-bs-original-title="Refresh">
                        <i class="bx bx-refresh"></i>
                    </a>
                    {% else %}
                    <a aria-label="anchor" href="/support" class="vertical-phone" data-bs-toggle="tooltip"
                        data-bs-original-title="Back to inbox">
                        <i class="bx bx-left-arrow-alt"></i>
                    </a>
                    <a aria-label="anchor" href="javascript:location.reload();" class="vertical-phone"
                        data-bs-toggle="tooltip" data-bs-original-title="Refresh">
                        <i class="bx bx-refresh"></i>
                    </a>
                    {% endif %}
                </div>

                {% if currentSection is defined and currentSection != null %}
                <div class="ms-3">
                    <h6 class="mb-0 text-primary">
                        <i class="ri-inbox-archive-line me-1"></i>
                        {{ phrase(sections[currentSection].thread_name) }}
                    </h6>
                </div>
                {% endif %}
            </div>
            <div class="mail-messages" id="mail-messages">
                {% if not getUser().isAdmin() and not isUserModerator %}
                <div class="alert alert-info mb-3">
                    <i class="ri-information-line me-2"></i>
                    <strong>{{phrase("Your requests")}}:</strong>
                    {% if currentSection is defined and currentSection != null %}
                        {{ phrase("Here are your requests in category") }} "{{ phrase(sections[currentSection].thread_name) }}"
                    {% else %}
                        {{ phrase("Here are all your requests to technical support") }}
                    {% endif %}
                </div>
                {% endif %}

                {% if threads|length == 0 %}
                <div class="text-center py-5">
                    <i class="ri-inbox-line fs-48 text-muted mb-3"></i>
                    <h5 class="text-muted">{{ phrase('No support requests') }}</h5>
                    <p class="text-muted">{{ phrase('You have not created any support requests yet') }}</p>
                    <a href="/support/new" class="btn btn-primary">
                        <i class="ri-add-circle-line me-2"></i>{{ phrase('Create first request') }}
                    </a>
                </div>
                {% else %}
                <ul class="list-unstyled mb-0">
                    {% for thread in threads %}
                    <li class="{% if thread.is_read == false %}active{% endif %}">
                        {% set sectionInfo = get_support_thread_name(thread.thread_id) %}

                        <div class="d-flex align-items-top">
                            <div class="me-2 lh-1">

                                <a aria-label="anchor" href="javascript:void(0);" class="main-mail-star">
                                    {% if thread.is_close %}
                                    <i data-bs-toggle="tooltip" data-bs-original-title="{{ phrase('is_close') }}"
                                        class="bi bi-lock"></i>
                                    {% else %}
                                    <i data-bs-toggle="tooltip" data-bs-original-title="{{ phrase('is_open') }}"
                                        class="bi bi-unlock"></i>
                                    {% endif %}
                                </a>
                                <a aria-label="anchor" href="javascript:void(0);" class="main-mail-star">
                                    {% if thread.private %}
                                    <i data-bs-toggle="tooltip"
                                        data-bs-original-title="{{ phrase('Viewing is closed') }}"
                                        class="bi bi-eye-slash"></i>
                                    {% else %}
                                    <i data-bs-toggle="tooltip" data-bs-original-title="{{ phrase('Viewing is open') }}"
                                        class="bi bi-eye"></i>
                                    {% endif %}
                                </a>
                            </div>


                            <div class="flex-fill ms-0">
                                {% if thread.owner_id == getUser().getId() or getUser().isAdmin() or isUserModerator or
                                thread.private == false %}
                                <a href="/support/read/{{thread.id}}" class="text-decoration-none">{% endif %}
                                    <div class="d-flex align-items-center">
                                        {% set lastUser = getUser(thread.last_user_id) %}
                                        <span class="avatar avatar-lg me-1">
                                            {% if lastUser.isAvatarVideo() %}
                                                <video src="{{ lastUser.getAvatar() }}" class="img-fluid rounded-circle" autoplay loop muted playsinline style="width:56px; height:56px; object-fit:cover;"></video>
                                            {% else %}
                                                <img src="{{ lastUser.getAvatar() }}" alt="img">
                                            {% endif %}
                                        </span>
                                        <div class="w-75"> 
                                            <span class="d-block mb-0">
                                                <span class="text-muted d-inline-block text-truncate w-75">
                                                    {{ phrase(sectionInfo.thread_name) }}
                                                    {% if getUser().isAdmin() or isUserModerator %}
                                                    от {{getUser(thread.owner_id).getName()}}
                                                    {% endif %}
                                                </span>
                                            </span>
                                            <div class="text-muted small d-block text-truncate">
                                                {{getUser(thread.last_user_id).getName()}}:
                                                {% if thread.private and thread.owner_id != getUser().getId() and
                                                getUser().isAdmin() == false and isUserModerator == false %}
                                                <i class="bi bi-eye-slash"></i>
                                                {% else %}
                                                {{strip_html_tags(thread.message)|raw}}
                                                {% endif %}
                                            </div>
                                            <div class="text-muted">
                                                <div class="fw-normal fs-11">
                                                    {{thread.date_update|date("H:m d.m.Y")}}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% if thread.owner_id == getUser().getId() or getUser().isAdmin() or isUserModerator
                                    %}
                                </a>{% endif %}
                            </div>

                        </div>

                    </li>
                    {% endfor %}


                </ul>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{template}}/assets/libs/quill/quill.snow.css">
<style>
    .main-mail-star {
        display: block;
        margin-bottom: 5px;
    }
    .user-checkbox {
        cursor: pointer;
    }
    .user-item:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block js %}

<script src="{{template}}/assets/js/mail.js"></script>
<script src="{{template}}/assets/libs/quill/quill.min.js"></script>

{% if getUser().isAdmin() or isUserModerator %}
<script>
(function() {
    'use strict';
    
    // Translations
    const lang = {
        selected: "{{ phrase('Selected')|e('js') }}",
        loading: "{{ phrase('Loading')|e('js') }}",
        loading_users: "{{ phrase('Loading users')|e('js') }}",
        users_not_found: "{{ phrase('Users not found')|e('js') }}",
        page: "{{ phrase('Page')|e('js') }}",
        of: "{{ phrase('of')|e('js') }}",
        total: "{{ phrase('total')|e('js') }}",
        enter_min_chars: "{{ phrase('Enter minimum')|e('js') }}",
        characters: "{{ phrase('characters')|e('js') }}",
        error_loading_users: "{{ phrase('Error loading users')|e('js') }}",
        please_select_category: "{{ phrase('Please select category')|e('js') }}",
        select_at_least_one_user: "{{ phrase('Select at least one user')|e('js') }}",
        creating_dialog: "{{ phrase('Creating dialog')|e('js') }}",
        error_no_thread_id: "{{ phrase('Error: thread ID not received')|e('js') }}",
        error_creating_dialog: "{{ phrase('Error creating dialog')|e('js') }}",
        message_sent_successfully: "{{ phrase('Messages sent successfully')|e('js') }}",
        to: "{{ phrase('to')|e('js') }}",
        users: "{{ phrase('users')|e('js') }}",
        error_sending_messages: "{{ phrase('Error sending messages')|e('js') }}",
        enter_message_text: "{{ phrase('Enter message text')|e('js') }}",
        editor_init_error: "{{ phrase('Editor initialization error')|e('js') }}",
        no_users_selected: "{{ phrase('No users selected')|e('js') }}",
        sending: "{{ phrase('Sending')|e('js') }}",
        send: "{{ phrase('Send')|e('js') }}"
    };
    
    let searchTimeout = null;
    const MIN_SEARCH_LENGTH = 2;
    const SEARCH_DELAY = 300; // Задержка перед поиском в мс
    const USERS_PER_PAGE = 300; // Количество пользователей на странице
    
    let currentPage = 1;
    let currentQuery = '';
    let totalPages = 1;
    let totalUsers = 0;
    
    const $modal = $('#writeToUserModal');
    const $searchInput = $('#userSearchInput');
    const $usersList = $('#usersList');
    const $usersListLoading = $('#usersListLoading');
    const $usersListEmpty = $('#usersListEmpty');
    const $usersPagination = $('#usersPagination');
    const $paginationPrev = $('#paginationPrev');
    const $paginationNext = $('#paginationNext');
    const $paginationInfo = $('#paginationInfo');
    const $selectedUsersCount = $('#selectedUsersCount');
    const $selectedCountFooter = $('#selectedCountFooter');
    const $selectAllUsers = $('#selectAllUsers');
    const $deselectAllUsers = $('#deselectAllUsers');
    const $sendToSelectedUsers = $('#sendToSelectedUsers');
    const $massMessageModal = $('#massMessageModal');
    const $massMessageUsersCount = $('#massMessageUsersCount');
    const $confirmMassSend = $('#confirmMassSend');
    
    let massMessageQuill = null;
    
    // Инициализация Quill editor для массового сообщения
    function initMassMessageEditor() {
        if (massMessageQuill) {
            return;
        }
        
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['clean']
        ];
        
        massMessageQuill = new Quill('#massMessageEditor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });
    }
    
    // Загрузка пользователей при открытии модального окна
    $modal.on('show.bs.modal', function() {
        $searchInput.val('');
        currentPage = 1;
        currentQuery = '';
        loadUsers(1, '');
        updateSelectedCount();
    });
    
    // Сброс состояния при закрытии модального окна
    $modal.on('hidden.bs.modal', function() {
        $searchInput.val('');
        currentPage = 1;
        currentQuery = '';
        $usersList.empty();
        $usersPagination.hide();
        $('.user-checkbox').prop('checked', false);
        updateSelectedCount();
    });
    
    // Обработка поиска с задержкой
    $searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        // Очищаем предыдущий таймер
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        currentQuery = query;
        currentPage = 1;
        
        if (query.length === 0) {
            // Если поиск пустой, загружаем всех пользователей
            loadUsers(1, '');
            return;
        }
        
        if (query.length < MIN_SEARCH_LENGTH) {
            showEmpty('Введите минимум ' + MIN_SEARCH_LENGTH + ' символа');
            $usersPagination.hide();
            return;
        }
        
        // Устанавливаем новый таймер
        searchTimeout = setTimeout(function() {
            loadUsers(1, query);
        }, SEARCH_DELAY);
    });
    
    // Обработчики пагинации
    $paginationPrev.find('a').on('click', function(e) {
        e.preventDefault();
        if (currentPage > 1) {
            loadUsers(currentPage - 1, currentQuery);
        }
    });
    
    $paginationNext.find('a').on('click', function(e) {
        e.preventDefault();
        if (currentPage < totalPages) {
            loadUsers(currentPage + 1, currentQuery);
        }
    });
    
    // Функция загрузки пользователей
    function loadUsers(page, query) {
        showLoading();
        currentPage = page;
        
        AjaxSend('/admin/users/search-lite', 'POST', {
            q: query || '',
            page: page,
            limit: USERS_PER_PAGE
        }, true).then(function(response) {
            if (response && response.ok) {
                totalUsers = response.total || 0;
                totalPages = response.perPage ? Math.ceil(totalUsers / response.perPage) : 1;
                
                if (response.data && response.data.length > 0) {
                    displayUsers(response.data);
                    updatePagination();
                } else {
                    showEmpty();
                    $usersPagination.hide();
                }
            } else {
                showEmpty(lang.error_loading_users);
                $usersPagination.hide();
            }
        }).catch(function(error) {
            console.error('Ошибка при загрузке пользователей:', error);
            showEmpty(lang.error_loading_users);
            $usersPagination.hide();
        });
    }
    
    // Функция обновления пагинации
    function updatePagination() {
        if (totalPages <= 1) {
            $usersPagination.hide();
            return;
        }
        
        $usersPagination.show();
        $paginationInfo.text(lang.page + ' ' + currentPage + ' ' + lang.of + ' ' + totalPages + ' (' + lang.total + ': ' + totalUsers + ')');
        
        // Обновляем состояние кнопок
        if (currentPage <= 1) {
            $paginationPrev.addClass('disabled');
            $paginationPrev.find('a').attr('tabindex', '-1').attr('aria-disabled', 'true');
        } else {
            $paginationPrev.removeClass('disabled');
            $paginationPrev.find('a').removeAttr('tabindex').removeAttr('aria-disabled');
        }
        
        if (currentPage >= totalPages) {
            $paginationNext.addClass('disabled');
            $paginationNext.find('a').attr('tabindex', '-1').attr('aria-disabled', 'true');
        } else {
            $paginationNext.removeClass('disabled');
            $paginationNext.find('a').removeAttr('tabindex').removeAttr('aria-disabled');
        }
    }
    
    // Функция отображения списка пользователей
    function displayUsers(users) {
        $usersList.empty();
        
        users.forEach(function(user) {
            const avatar = user.avatar || 'none.jpeg';
            // Обработка аватара с учетом query параметров (например, user_1.webm?c=6db1)
            const avatarPath = avatar.split('?')[0] || avatar;
            const avatarParts = avatar.split('?');
            const avatarPathOnly = avatarParts[0] || avatar;
            const avatarQuery = avatarParts.length > 1 ? '?' + avatarParts.slice(1).join('?') : '';
            const avatarUrl = `/uploads/avatar/${encodeURIComponent(avatarPathOnly)}${avatarQuery}`;
            
            // Проверяем, является ли аватар видео (только .webm, как в isAvatarVideo())
            const isVideo = /\.webm$/i.test(avatarPath);
            
            let avatarHtml = '';
            if (isVideo) {
                avatarHtml = `<video src="${avatarUrl}" class="rounded-circle" autoplay loop muted playsinline style="width:40px; height:40px; object-fit:cover;"></video>`;
            } else {
                avatarHtml = `<img src="${avatarUrl}" alt="${escapeHtml(user.name)}" class="rounded-circle" style="width:40px; height:40px; object-fit:cover;">`;
            }
            
            const userItem = $(`
                <div class="list-group-item user-item" data-user-id="${user.id}">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <input type="checkbox" class="form-check-input user-checkbox" 
                                id="userCheckbox_${user.id}" value="${user.id}">
                        </div>
                        <div class="me-3">
                            <span class="avatar avatar-md">${avatarHtml}</span>
                        </div>
                        <div class="flex-fill" style="cursor: pointer;">
                            <h6 class="mb-0">${escapeHtml(user.name)}</h6>
                            <small class="text-muted">${escapeHtml(user.email)}</small>
                        </div>
                        <div class="ms-2">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-single-send" 
                                data-user-id="${user.id}" data-user-name="${escapeHtml(user.name)}" 
                                data-user-email="${escapeHtml(user.email)}">
                                <i class="ri-send-plane-line"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            // Обработчик чекбокса
            userItem.find('.user-checkbox').on('change', function() {
                updateSelectedCount();
            });
            
            // Обработчик клика на область пользователя (для выбора чекбокса)
            userItem.find('.flex-fill').on('click', function(e) {
                e.preventDefault();
                const checkbox = userItem.find('.user-checkbox');
                checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
            });
            
            // Обработчик одиночной отправки
            userItem.find('.btn-single-send').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const userId = $(this).data('user-id');
                const userName = $(this).data('user-name');
                const userEmail = $(this).data('user-email');
                const sectionId = $('#supportSectionSelect').val();
                if (!sectionId) {
                    noticeError(lang.please_select_category);
                    return;
                }
                createDialog(userId, userName, userEmail, sectionId);
            });
            
            $usersList.append(userItem);
        });
        
        $usersListLoading.hide();
        $usersListEmpty.hide();
        $usersList.show();
    }
    
    // Функция создания диалога
    function createDialog(userId, userName, userEmail, sectionId) {
        // Показываем индикатор загрузки
        const $selectedItem = $usersList.find(`[data-user-id="${userId}"]`);
        $selectedItem.addClass('active').html(
            '<div class="d-flex align-items-center justify-content-center p-2">' +
                '<div class="spinner-border spinner-border-sm text-primary me-2" role="status">' +
                    '<span class="visually-hidden">' + lang.loading + '...</span>' +
                '</div>' +
                '<span>' + lang.creating_dialog + '...</span>' +
            '</div>'
        );
        
        AjaxSend('/support/admin/create/dialog', 'POST', {
            user_id: userId,
            section_id: sectionId
        }, true).then(function(response) {
            if (response && response.ok) {
                if (response.thread_id) {
                    // Перенаправляем на страницу диалога
                    window.location.href = '/support/read/' + response.thread_id;
                } else {
                    noticeError(lang.error_no_thread_id);
                    $modal.modal('hide');
                }
            } else {
                const message = response && response.message ? response.message : lang.error_creating_dialog;
                noticeError(message);
                $selectedItem.removeClass('active');
                loadUsers(currentPage, currentQuery);
            }
        }).catch(function(error) {
            console.error('Ошибка при создании диалога:', error);
            const message = error && error.message ? error.message : lang.error_creating_dialog;
            noticeError(message);
            $selectedItem.removeClass('active');
            loadUsers(currentPage, currentQuery);
        });
    }
    
    // Функции для управления отображением состояний
    function showLoading() {
        $usersListLoading.show();
        $usersListEmpty.hide();
        $usersList.hide();
    }
    
    function showEmpty(message) {
        $usersListLoading.hide();
        $usersListEmpty.show();
        $usersList.hide();
        if (message) {
            $usersListEmpty.find('p').text(message);
        } else {
            $usersListEmpty.find('p').text(lang.users_not_found);
        }
    }
    
    // Функция обновления счетчика выбранных пользователей
    function updateSelectedCount() {
        const selectedCount = $('.user-checkbox:checked').length;
        $selectedUsersCount.text(lang.selected + ': ' + selectedCount);
        $selectedCountFooter.text(selectedCount);
        $sendToSelectedUsers.prop('disabled', selectedCount === 0);
    }
    
    // Обработчик "Выбрать все"
    $selectAllUsers.on('click', function() {
        $('.user-checkbox').prop('checked', true).trigger('change');
    });
    
    // Обработчик "Снять выделение"
    $deselectAllUsers.on('click', function() {
        $('.user-checkbox').prop('checked', false).trigger('change');
    });
    
    // Обработчик кнопки "Отправить выбранным"
    $sendToSelectedUsers.on('click', function() {
        const selectedUsers = $('.user-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedUsers.length === 0) {
            noticeError(lang.select_at_least_one_user);
            return;
        }
        
        const sectionId = $('#supportSectionSelect').val();
        if (!sectionId) {
            noticeError(lang.please_select_category);
            return;
        }
        
        $massMessageUsersCount.text(selectedUsers.length);
        initMassMessageEditor();
        if (massMessageQuill) {
            massMessageQuill.root.innerHTML = '<p><br></p>';
        }
        $massMessageModal.modal('show');
        
        // Сохраняем выбранных пользователей и категорию для отправки
        $massMessageModal.data('userIds', selectedUsers);
        $massMessageModal.data('sectionId', sectionId);
    });
    
    // Обработчик подтверждения массовой отправки
    $confirmMassSend.on('click', function() {
        const userIds = $massMessageModal.data('userIds') || [];
        const sectionId = $massMessageModal.data('sectionId');
        
        if (userIds.length === 0) {
            noticeError(lang.no_users_selected);
            return;
        }
        
        if (!massMessageQuill) {
            noticeError(lang.editor_init_error);
            return;
        }
        
        const message = massMessageQuill.root.innerHTML.trim();
        if (message === '' || message === '<p><br></p>') {
            noticeError(lang.enter_message_text);
            return;
        }
        
        // Блокируем кнопку
        const $btn = $(this);
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>' + lang.sending + '...');
        
        sendMassMessages(userIds, sectionId, message).then(function(response) {
            if (response && response.ok) {
                const sentCount = response.sent || userIds.length;
                noticeSuccess(lang.message_sent_successfully + ' ' + sentCount + ' ' + lang.users);
                $massMessageModal.modal('hide');
                $modal.modal('hide');
                // Обновляем список пользователей
                loadUsers(currentPage, currentQuery);
            } else {
                const msg = response && response.message ? response.message : lang.error_sending_messages;
                noticeError(msg);
            }
        }).catch(function(error) {
            console.error('Ошибка при массовой отправке:', error);
            noticeError(lang.error_sending_messages);
        }).finally(function() {
            $btn.prop('disabled', false).html('<i class="ri-send-plane-line me-1"></i>' + lang.send);
        });
    });
    
    // Функция массовой отправки сообщений
    function sendMassMessages(userIds, sectionId, message) {
        return AjaxSend('/support/admin/mass/send', 'POST', {
            user_ids: userIds,
            section_id: sectionId,
            message: message
        }, true);
    }
    
    // Функция для экранирования HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
})();
</script>
{% endif %}

{% endblock %}