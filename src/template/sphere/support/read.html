{% extends 'struct.html' %}

{% block title %}{{ phrase('technical support') }}{% endblock %}

{% block content %}

<div class="container-fluid">

    <div class="main-mail-container gap-4 d-flex">
        <div class="mails-information">
            <div class="mail-info-header p-1 d-xxl-flex align-items-center justify-content-between">
                <div class="mail-option-read d-md-flex d-block">
                    <a aria-label="anchor" href="/support" class="vertical-phone" data-bs-toggle="tooltip"
                       data-bs-original-title="{{ phrase(417) }}">
                        <i class="bx bx-left-arrow-alt"></i>
                    </a>
                </div>

                <div class="unstyled inbox-pagination d-flex flex-wrap align-items-center gap-2 mb-0">
                    {% if thread.is_close %}
                    <div class="me-2">{{ phrase('is_close') }}</div>
                    {% endif %}

                    {% if isUserModerator %}

                    <button type="button"
                            class="btn btn-sm btn-primary d-flex align-items-center justify-content-center"
                            data-bs-toggle="modal"
                            data-bs-target="#mail-Compose">
                        <i class="ri-add-circle-line fs-16 align-middle me-1"></i>{{ phrase('Move') }}
                    </button>

                    <div class="modal modal-sm fade" id="mail-Compose" tabindex="-1" aria-labelledby="mail-ComposeLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h6 class="modal-title" id="mail-ComposeLabel">{{ phrase('Move') }}</h6>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body px-4">
                                    <div class="row">

                                        <div class="col-xl-12 mb-2">
                                            <label for="section" class="form-label">{{ phrase('Which category should I move the dialog to?') }}</label>
                                            <select class="form-control" name="section" id="section">
                                                {% for section in sections %}
                                                <option {% if section.id== id %}disabled{% endif %}
                                                        value="{{section.id}}">{{phrase(section.thread_name)}}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="d-sm-flex justify-content-between align-items-center">
                                            <div>
                                                <button id="toMove" type="button" class="btn btn-sm btn-success">{{
                                                    phrase('apply') }}
                                                </button>
                                            </div>
                                        </div>
                                        <script>
                                            $("#toMove").on("click", function () {
                                                let id = "{{id}}";
                                                let toMove = $("#section").val();
                                                AjaxSend("/support/admin/move", "POST", {
                                                    id: id,
                                                    toMove: toMove,
                                                });
                                            })
                                        </script>

                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light"
                                            data-bs-dismiss="modal">{{ phrase('cancel') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    {% if thread.is_close %}
                    <div data-topic-id="{{id}}" class="btn btn-sm btn-info-light closeTopic"><i
                            class="bi bi-unlock me-2"></i> {{ phrase('open') }}
                    </div>
                    {% else %}
                    <div data-topic-id="{{id}}" class="btn btn-sm btn-info-light closeTopic"><i
                            class="bi bi-lock me-2"></i> {{ phrase('close') }}
                    </div>
                    {% endif %}
                    <script>
                        $(".closeTopic").on("click", function () {
                            AjaxSend("/support/admin/topic/close", "POST", {id: $(this).attr('data-topic-id')});
                        })
                    </script>

                    <div id="deleteTopic" data-topic-id="{{id}}" class="btn btn-sm btn-danger-light"><i
                            class="bi bi-trash me-2"></i> {{ phrase('delete') }}
                    </div>
                    <script>
                        $("#deleteTopic").on("click", function () {
                            AjaxSend("/support/admin/delete/topic", "POST", {id: $(this).attr('data-topic-id')});
                        })
                    </script>
                    {% endif %}
                </div>
            </div>

            <div class="mail-info-body p-4" id="mail-info-body">
                {% for i, post in posts %}
                <div data-message-id="{{post.id}}">
                    <div class="d-flex align-items-center">
                        <div class="me-1">
                    {% set postUser = getUser(post.user_id) %}
                    <span class="avatar avatar-md {% if postUser.isOnline() %}online{% endif %} me-2 avatar-rounded mail-msg-avatar">
                    {% if postUser.isAvatarVideo() %}
                        <video src="{{ postUser.getAvatar() }}" class="rounded-circle" autoplay loop muted playsinline style="width:48px; height:48px; object-fit:cover;"></video>
                    {% else %}
                        <img src="{{ postUser.getAvatar() }}" alt="">
                    {% endif %}
                </span>
                        </div>

                        <div class="flex-fill">
                            {% if getUser().isAdmin() or isUserModerator %}
                            {% if i != 0 %}
                            <div role="button" class="mail-date float-end text-muted fw-normal fs-11 ms-3 deletePost"
                                 data-post-id="{{post.id}}">
                                Удалить
                            </div>
                            {% endif %}
                            {% endif %}

                            <div class="mail-date float-end text-muted fw-normal fs-11">
                                <span class="me-2 d-inline-flex align-items-center"></span>{{post.date_create|date("H:i d.m.Y")}}
                            </div>

                            <h6 class="mb-0 fw-semibold">
                                {% if getUser().isAdmin() %}
                                <a href="/admin/user/info/{{postUser.getId()}}">{{postUser.getName()}}</a>
                                {% else %}
                                <h6 class="mb-0 fw-semibold">{{getUser(post.user_id).getName()}}</h6>
                                {% endif %}
                            </h6>
                            <span class="text-muted fs-12">
                                {% if getUser().isAdmin() or isUserModerator %}
                                    <a href="/admin/user/info/{{post.user_id}}">{{getUser(post.user_id).getEmail()}}</a>
                                {% endif %}

                            </span>
                        </div>
                    </div>
                    <div class="main-mail-content my-1">
                        {{post.message|raw}}
                        <div class="row g-2">
                            {% for screen in post.screens|json_decode %}
                            {% set imgPath = screen|split('.') %}
                            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                                <a href="{{screen}}" class="glightbox" data-gallery="gallery_{{screen.id}}">
                                    <img src="{{imgPath[0]}}_thumb.{{imgPath[1]}}" class="img-fluid rounded"
                                         alt="image">
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>


            {% if isSendMessage %}
            <div class="mail-info-footer  align-items-center justify-content-between">

                <div class="mail-reply">
                    <div id="reply"></div>
                </div>

                <div class="">

                    <div id="screens" class="mt-2 mb-2 d-flex flex-wrap"></div>

                    <button id="toReply" aria-label="button" type="button" class="btn btn-success d-inline-flex">
                        <i class="ri-reply-all-line me-1 align-middle"></i>{{ phrase(364) }}
                    </button>

                    <button aria-label="anchor" class="btn btn-icon mx-2 btn-primary-light"
                            type="button" data-bs-toggle="modal"
                            data-bs-target="#exampleModalScrollable2">
                        <i class="ri-attachment-2"></i>
                    </button>


                    <div class="modal fade" id="exampleModalScrollable2" tabindex="-1"
                         aria-labelledby="exampleModalScrollable2" data-bs-keyboard="false"
                         aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">

                                <div class="modal-body">
                                    <input type="file" class="multiple-filepond" name="filepond" multiple
                                           data-allow-reorder="true" data-max-file-size="3MB" data-max-files="6">
                                </div>
                            </div>
                        </div>
                    </div>


                </div>


            </div>
            {% endif %}

        </div>
    </div>

</div>

{% endblock %}

{% block css %}

<link rel="stylesheet" href="{{template}}/assets/libs/prismjs/themes/prism-coy.min.css">
<link rel="stylesheet" href="{{template}}/assets/libs/filepond/filepond.min.css">
<link rel="stylesheet"
      href="{{template}}/assets/libs/filepond-plugin-image-preview/filepond-plugin-image-preview.min.css">
<link rel="stylesheet" href="{{template}}/assets/libs/filepond-plugin-image-edit/filepond-plugin-image-edit.min.css">
<link rel="stylesheet" href="{{template}}/assets/libs/dropzone/dropzone.css">
<link rel="stylesheet" href="{{template}}/assets/libs/glightbox/css/glightbox.min.css">

<link rel="stylesheet" href="{{template}}/assets/libs/quill/quill.snow.css">
<link rel="stylesheet" href="{{template}}/assets/libs/quill/quill.bubble.css">

{% endblock %}

{% block js %}

<script src="{{template}}/assets/libs/filepond/filepond.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-preview/filepond-plugin-image-preview.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-exif-orientation/filepond-plugin-image-exif-orientation.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-file-validate-size/filepond-plugin-file-validate-size.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-file-encode/filepond-plugin-file-encode.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-edit/filepond-plugin-image-edit.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-crop/filepond-plugin-image-crop.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-resize/filepond-plugin-image-resize.min.js"></script>
<script src="{{template}}/assets/libs/filepond-plugin-image-transform/filepond-plugin-image-transform.min.js"></script>
<script src="{{template}}/assets/libs/glightbox/js/glightbox.min.js"></script>
<script src="{{template}}/assets/js/gallery.js"></script>
<script src="{{template}}/assets/libs/dropzone/dropzone-min.js"></script>


<script src="{{template}}/assets/libs/simplebar/simplebar.min.js"></script>
<script src="{{template}}/assets/js/simplebar.js"></script>

<script src="{{template}}/assets/libs/quill/quill.min.js"></script>

<script>
    (function () {
        "use strict";


        var myElement13 = document.getElementById('mail-info-body');
        var simpleBarInstance = new SimpleBar(myElement13, {autoHide: true});
        window.simpleBarInstance = simpleBarInstance; // Сохраняем для использования в других скриптах

        function scrollToLastMessage() {
            const scrollElement = simpleBarInstance.getScrollElement();
            const targetScroll = scrollElement.scrollHeight;
            const scrollStep = 50;
            const interval = 10;

            let currentScroll = scrollElement.scrollTop;

            const scrollAnimation = setInterval(() => {
                if (currentScroll < targetScroll) {
                    currentScroll = Math.min(currentScroll + scrollStep, targetScroll);
                    scrollElement.scrollTop = currentScroll;
                } else {
                    clearInterval(scrollAnimation);
                }
            }, interval);
        }

        window.addEventListener('load', scrollToLastMessage);


        var toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['clean']
        ];

        let quill = new Quill('#reply', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });
        window.quill = quill; // Сохраняем для использования в других скриптах

        // Отслеживаем drop событий
        const editor = document.querySelector('#reply .ql-editor');


        const modalTriggerButton = document.querySelector('[data-bs-target="#exampleModalScrollable2"]');

        // Отслеживаем событие dragover (когда изображение над областью)
        editor.addEventListener('dragover', (event) => {
            event.preventDefault(); // Это необходимо для разрешения перетаскивания
            if (!document.querySelector('.modal.show')) {
                modalTriggerButton.click(); // Открываем модальное окно
            }
        });

        // Перехватываем drop событие
        editor.addEventListener('drop', (event) => {
            event.preventDefault();
            const files = event.dataTransfer.files;

            if (files && files[0] && files[0].type.startsWith('image/')) {
                console.log('Изображение перетащено:', files[0]);

                // Сразу открываем модальное окно для загрузки изображения
                const modalTriggerButton = document.querySelector('[data-bs-target="#exampleModalScrollable2"]');
                modalTriggerButton.click();
            }
        });

        // Перехватываем paste событие (вставка изображения через буфер обмена)
        editor.addEventListener('paste', (event) => {
            const clipboardData = event.clipboardData || window.clipboardData;
            const items = clipboardData.items;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                    event.preventDefault();
                    console.log('Изображение вставлено через буфер обмена:', items[i].getAsFile());
                    modalTriggerButton.click();
                }
            }
        });

        // Обработчик отправки сообщения будет переопределен в скрипте автообновления
        // Временно оставляем пустым, чтобы избежать конфликтов


    })();
</script>

<script>
    (function () {
        'use strict';
        let pond;
        let controllers = [];

        function addImageToScreens(response) {
            // Проверяем, существует ли элемент #screens
            const screensElement = document.querySelector('#screens');
            if (!screensElement) {
                console.error("Элемент с ID 'screens' не найден.");
                return;
            }

            // Проверяем, содержит ли response нужное свойство
            if (!response.screen) {
                console.error("Ответ сервера не содержит 'screen'.", response);
                return;
            }

            // Добавляем изображение
            $(screensElement).append(` <div class="p-2">
                            <a href="${response.screen}" class="glightbox" data-gallery="gallery1">
                                <img src="${response.thumbnail}" alt="image">
                            </a>
                        </div>`);

            // Инициализация Glightbox для новых элементов
            const lightbox = GLightbox({
                selector: '.glightbox',
                touchNavigation: true,
                loop: true
            });

            console.log('Изображение добавлено:', response.screen);
        }

        FilePond.setOptions({
            server: {
                url: '/support/load/file',
                process: {
                    ondata: (formData) => {
                        return formData;
                    },
                    onload: (response, loadFile) => {
                        try {
                            const parsedResponse = typeof response === 'string' ? JSON.parse(response) : response;
                            if (parsedResponse.ok === false) {
                                console.error("Ошибка при загрузке файлов:", parsedResponse.message);
                                noticeError(parsedResponse.message);
                                $('#exampleModalScrollable2').modal('hide');
                                controllers.forEach(controller => controller.abort());

                                if (pond) {
                                    pond.disable(); // Блокируем возможность дальнейших загрузок
                                }
                                return;
                            }

                            addImageToScreens(parsedResponse);
                            return parsedResponse;
                        } catch (e) {
                            console.error('Ошибка при обработке ответа сервера:', e);
                            return null;
                        }
                    }
                }
            }
        });

        const MultipleElement = document.querySelector('.multiple-filepond');
        if (MultipleElement) {
            pond = FilePond.create(MultipleElement);
            pond.on('processfile', (error, file) => {
                $('#exampleModalScrollable2').modal('hide');
                if (error) {
                    console.error('Ошибка загрузки файла:', error);
                }
            });
        } else {
            console.error("Элемент '.multiple-filepond' не найден.");
        }

    })();
</script>

<script>
    $(".deletePost").on("click", function () {
        let postId = $(this).attr('data-post-id');
        AjaxSend("/support/admin/delete/post", "POST", {postId: postId});
    })
</script>

<script>
    // Парсер ссылок - преобразует текстовые URL в кликабельные ссылки
    (function () {
        'use strict';

        function linkifyText(text) {
            // Регулярное выражение для поиска URL
            const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            const wwwPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            const emailPattern = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;

            // Заменяем URL на ссылки
            text = text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            
            // Заменяем www. на ссылки
            text = text.replace(wwwPattern, '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>');
            
            // Заменяем email на ссылки
            text = text.replace(emailPattern, '<a href="mailto:$1">$1</a>');

            return text;
        }

        function processNode(node) {
            // Пропускаем узлы, которые уже являются ссылками
            if (node.nodeName === 'A') {
                return;
            }

            // Обрабатываем текстовые узлы
            if (node.nodeType === Node.TEXT_NODE) {
                const originalText = node.nodeValue;
                const linkedText = linkifyText(originalText);
                
                // Если текст изменился, заменяем узел
                if (linkedText !== originalText) {
                    const wrapper = document.createElement('span');
                    wrapper.innerHTML = linkedText;
                    node.parentNode.replaceChild(wrapper, node);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.childNodes.length > 0) {
                // Рекурсивно обрабатываем дочерние узлы
                Array.from(node.childNodes).forEach(child => processNode(child));
            }
        }

        // Применяем парсер ко всем сообщениям
        function linkifyMessages() {
            const messageContents = document.querySelectorAll('.main-mail-content');
            messageContents.forEach(content => {
                processNode(content);
            });
        }

        // Запускаем после загрузки страницы
        window.addEventListener('load', linkifyMessages);
    })();
</script>

<script>
    (function () {
        'use strict';

        const threadId = {{ id|default(0) }};
        const currentUserId = {{ currentUserId|default(0) }};
        const isUserModerator = {{ isUserModerator ? 'true' : 'false' }};
        const isAdmin = {{ getUser().isAdmin() ? 'true' : 'false' }};
        const mailInfoBody = document.getElementById('mail-info-body');
        let simpleBarInstance = null;
        let messagesContainer = null; // Контейнер для сообщений внутри SimpleBar
        let lastMessageId = 0;
        let isPolling = true;
        let pollingInterval = null;
        const POLLING_INTERVAL = 2500; // 2.5 секунды
        
        // Уведомления о новых сообщениях
        const originalTitle = document.title;
        let unreadMessagesCount = 0;
        let isTabActive = !document.hidden;
        // Путь к звуковому файлу (можно использовать mp3 или mp4)
        // Если нужен mp4, замените путь на соответствующий файл
        const soundPath = '/custom/plugins/wheel/tpl/sounds/click.mp3';
        const notificationSound = new Audio(soundPath);
        notificationSound.volume = 0.5; // Устанавливаем громкость

        // Используем существующий SimpleBar instance
        if (window.simpleBarInstance) {
            simpleBarInstance = window.simpleBarInstance;
        }
        
        // Функция для получения правильного контейнера сообщений
        function getMessagesContainer() {
            if (messagesContainer) {
                return messagesContainer;
            }
            
            // Пытаемся найти .simplebar-content внутри mail-info-body
            const simplebarContent = mailInfoBody.querySelector('.simplebar-content');
            if (simplebarContent) {
                messagesContainer = simplebarContent;
                return messagesContainer;
            }
            
            // Если не нашли, используем сам mail-info-body (на случай если SimpleBar еще не инициализирован)
            messagesContainer = mailInfoBody;
            return messagesContainer;
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
            if (!dateString) return '';
            // Парсим дату в формате MySQL DATETIME (YYYY-MM-DD HH:MM:SS)
            const date = new Date(dateString.replace(' ', 'T'));
            if (isNaN(date.getTime())) {
                // Если не удалось распарсить, возвращаем исходную строку
                return dateString;
            }
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${hours}:${minutes} ${day}.${month}.${year}`;
        }

        // Функция для парсинга скриншотов
        function parseScreens(screens) {
            if (!screens || screens === 'null' || screens === '[]' || screens === '') return [];
            try {
                if (typeof screens === 'string') {
                    const parsed = JSON.parse(screens);
                    return Array.isArray(parsed) ? parsed : [];
                }
                return Array.isArray(screens) ? screens : [];
            } catch (e) {
                console.warn('Ошибка парсинга скриншотов:', e);
                return [];
            }
        }

        // Функция для создания HTML скриншотов
        function createScreensHTML(screens) {
            if (!screens || screens.length === 0) return '';
            
            let html = '<div class="row g-2">';
            screens.forEach(screen => {
                const imgPath = screen.split('.');
                const thumbPath = imgPath.length > 1 ? `${imgPath[0]}_thumb.${imgPath[1]}` : screen;
                html += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                        <a href="${screen}" class="glightbox" data-gallery="gallery_${screen.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <img src="${thumbPath}" class="img-fluid rounded" alt="image">
                        </a>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Функция для создания HTML сообщения
        function createMessageHTML(message, messageIndex) {
            const screens = parseScreens(message.screens);
            const screensHTML = createScreensHTML(screens);
            const isOnline = message.user_is_online ? 'online' : '';
            const avatarHTML = message.user_is_avatar_video 
                ? `<video src="${message.user_avatar}" class="rounded-circle" autoplay loop muted playsinline style="width:48px; height:48px; object-fit:cover;"></video>`
                : `<img src="${message.user_avatar}" alt="">`;
            
            const userNameLink = isAdmin 
                ? `<a href="/admin/user/info/${message.user_id}">${message.user_name}</a>`
                : message.user_name;
            
            const emailHTML = (isAdmin || isUserModerator) 
                ? `<span class="text-muted fs-12"><a href="/admin/user/info/${message.user_id}">${message.user_email}</a></span>`
                : '';
            
            const deleteButton = (isAdmin || isUserModerator) && messageIndex > 0
                ? `<div role="button" class="mail-date float-end text-muted fw-normal fs-11 ms-3 deletePost" data-post-id="${message.id}">Удалить</div>`
                : '';

            return `
                <div data-message-id="${message.id}">
                    <div class="d-flex align-items-center">
                        <div class="me-1">
                            <span class="avatar avatar-md ${isOnline} me-2 avatar-rounded mail-msg-avatar">
                                ${avatarHTML}
                            </span>
                        </div>
                        <div class="flex-fill">
                            ${deleteButton}
                            <div class="mail-date float-end text-muted fw-normal fs-11">
                                <span class="me-2 d-inline-flex align-items-center"></span>${formatDate(message.date_create)}
                            </div>
                            <h6 class="mb-0 fw-semibold">${userNameLink}</h6>
                            ${emailHTML}
                        </div>
                    </div>
                    <div class="main-mail-content my-1">
                        ${message.message}
                        ${screensHTML}
                    </div>
                </div>
            `;
        }

        // Функция для добавления новых сообщений
        function addNewMessages(messages) {
            if (!messages || messages.length === 0) return;

            const wasAtBottom = isScrolledToBottom();
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            let newMessagesFromOthers = 0;
            const container = getMessagesContainer();

            messages.forEach((message, index) => {
                if (message.id > lastMessageId) {
                    tempDiv.innerHTML = createMessageHTML(message, container.children.length + index);
                    const messageElement = tempDiv.firstElementChild;
                    fragment.appendChild(messageElement);
                    lastMessageId = Math.max(lastMessageId, message.id);
                    
                    // Проверяем, является ли сообщение от другого пользователя
                    if (message.user_id && message.user_id != currentUserId) {
                        newMessagesFromOthers++;
                    }
                }
            });

            if (fragment.children.length > 0) {
                // Добавляем сообщения в правильный контейнер
                container.appendChild(fragment);
                
                // Применяем парсер ссылок к новым сообщениям
                const newMessageContents = fragment.querySelectorAll('.main-mail-content');
                newMessageContents.forEach(content => {
                    linkifyText(content);
                });

                // Инициализируем Glightbox для новых изображений
                if (typeof GLightbox !== 'undefined') {
                    const lightbox = GLightbox({
                        selector: '.glightbox',
                        touchNavigation: true,
                        loop: true
                    });
                }

                // Прокручиваем вниз если пользователь был внизу или если это новые сообщения
                if (wasAtBottom || fragment.children.length > 0) {
                    setTimeout(() => scrollToBottom(), 100);
                }

                // Обновляем обработчики удаления для новых сообщений
                updateDeleteHandlers();
                
                // Обрабатываем уведомления о новых сообщениях (только от других пользователей)
                if (newMessagesFromOthers > 0) {
                    handleNewMessagesNotification(newMessagesFromOthers);
                }
            }
        }

        // Функция для парсинга ссылок в тексте
        function linkifyText(element) {
            const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            const wwwPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            const emailPattern = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;

            function processNode(node) {
                if (node.nodeName === 'A') return;
                
                if (node.nodeType === Node.TEXT_NODE) {
                    const originalText = node.nodeValue;
                    let linkedText = originalText.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                    linkedText = linkedText.replace(wwwPattern, '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>');
                    linkedText = linkedText.replace(emailPattern, '<a href="mailto:$1">$1</a>');
                    
                    if (linkedText !== originalText) {
                        const wrapper = document.createElement('span');
                        wrapper.innerHTML = linkedText;
                        node.parentNode.replaceChild(wrapper, node);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE && node.childNodes.length > 0) {
                    Array.from(node.childNodes).forEach(child => processNode(child));
                }
            }

            processNode(element);
        }

        // Функция для проверки, находится ли пользователь внизу чата
        function isScrolledToBottom() {
            if (!simpleBarInstance) return true;
            const scrollElement = simpleBarInstance.getScrollElement();
            const threshold = 100; // 100px от низа
            return scrollElement.scrollHeight - scrollElement.scrollTop - scrollElement.clientHeight < threshold;
        }

        // Функция для прокрутки вниз
        function scrollToBottom() {
            if (!simpleBarInstance) return;
            const scrollElement = simpleBarInstance.getScrollElement();
            scrollElement.scrollTop = scrollElement.scrollHeight;
        }

        // Функция для обновления обработчиков удаления
        function updateDeleteHandlers() {
            document.querySelectorAll('.deletePost').forEach(button => {
                if (!button.hasAttribute('data-handler-attached')) {
                    button.setAttribute('data-handler-attached', 'true');
                    button.addEventListener('click', function() {
                        const postId = this.getAttribute('data-post-id');
                        AjaxSend("/support/admin/delete/post", "POST", {postId: postId});
                    });
                }
            });
        }

        // Функция для загрузки новых сообщений
        async function fetchNewMessages() {
            if (!isPolling) return;

            try {
                const response = await AjaxSend("/support/message/get/last", "POST", {
                    threadId: threadId,
                    startFromId: lastMessageId
                }, true);

                if (response && !response.error && Array.isArray(response) && response.length > 0) {
                    addNewMessages(response);
                }
            } catch (error) {
                // Тихая обработка ошибок - не показываем пользователю
                if (error && error.error !== 'Not allowed to view messages') {
                    console.error('Ошибка при загрузке сообщений:', error);
                }
            }
        }

        // Инициализация: получаем последний ID сообщения из существующих сообщений
        function initializeLastMessageId() {
            const container = getMessagesContainer();
            const messages = container.querySelectorAll('[data-message-id]');
            messages.forEach(msg => {
                const id = parseInt(msg.getAttribute('data-message-id'));
                if (!isNaN(id) && id > lastMessageId) {
                    lastMessageId = id;
                }
            });
        }

        // Проверяем и добавляем data-message-id к существующим сообщениям (на случай если их нет)
        function addMessageIds() {
            const container = getMessagesContainer();
            // Используем children вместо querySelectorAll для прямых дочерних элементов
            const messageDivs = Array.from(container.children);
            messageDivs.forEach((div) => {
                if (!div.hasAttribute('data-message-id')) {
                    // Пытаемся найти ID из кнопки удаления
                    const deleteBtn = div.querySelector('.deletePost');
                    if (deleteBtn) {
                        const postId = deleteBtn.getAttribute('data-post-id');
                        if (postId) {
                            div.setAttribute('data-message-id', postId);
                        }
                    }
                }
            });
        }

        // Запуск автообновления
        function startPolling() {
            if (pollingInterval) return;
            pollingInterval = setInterval(fetchNewMessages, POLLING_INTERVAL);
        }

        // Остановка автообновления
        function stopPolling() {
            isPolling = false;
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Функция для обработки уведомлений о новых сообщениях
        function handleNewMessagesNotification(newMessagesCount) {
            if (newMessagesCount === 0) return;
            
            // Если вкладка неактивна, увеличиваем счетчик и обновляем заголовок
            if (!isTabActive) {
                unreadMessagesCount += newMessagesCount;
                updatePageTitle();
                
                // Воспроизводим звук
                playNotificationSound();
            }
        }
        
        // Функция для обновления заголовка страницы
        function updatePageTitle() {
            if (unreadMessagesCount > 0) {
                document.title = `+${unreadMessagesCount} сообщений - ${originalTitle}`;
            } else {
                document.title = originalTitle;
            }
        }
        
        // Функция для воспроизведения звука уведомления
        function playNotificationSound() {
            if (notificationSound) {
                notificationSound.play().catch(error => {
                    // Игнорируем ошибки воспроизведения (например, если пользователь не взаимодействовал со страницей)
                    console.log('Не удалось воспроизвести звук:', error);
                });
            }
        }
        
        // Отслеживание изменения видимости вкладки
        document.addEventListener('visibilitychange', function() {
            const wasActive = isTabActive;
            isTabActive = !document.hidden;
            
            // Если вкладка стала активной, сбрасываем счетчик
            if (isTabActive && !wasActive && unreadMessagesCount > 0) {
                unreadMessagesCount = 0;
                updatePageTitle();
            }
        });
        
        // Инициализация при загрузке страницы
        window.addEventListener('load', function() {
            // Ждем немного, чтобы SimpleBar успел инициализироваться
            setTimeout(function() {
                // Обновляем контейнер сообщений после инициализации SimpleBar
                messagesContainer = null;
                getMessagesContainer();
                
                addMessageIds();
                initializeLastMessageId();
                updateDeleteHandlers();
                startPolling();
            }, 100);
        });

        // Останавливаем polling при уходе со страницы
        window.addEventListener('beforeunload', stopPolling);

        // Обновляем обработчик отправки сообщения для автообновления
        // Ждем загрузки страницы, чтобы убедиться, что quill инициализирован
        function setupReplyHandler() {
            $('#toReply').off('click').on('click', function () {
                // Получаем quill из глобальной области
                const quillEditor = window.quill;
                if (!quillEditor) {
                    console.error('Quill editor не найден');
                    return;
                }
                
                let screens = [];
                let editorContent = quillEditor.root.innerHTML;

                $('#screens .glightbox').each(function () {
                    let href = $(this).attr('href');
                    if (href) {
                        let filename = href.split('/').pop();
                        screens.push(filename);
                    }
                });

                if (screens.length === 0) {
                    if ($.trim(editorContent) === '<p><br></p>') {
                        alert('{{ phrase(502)|e('js') }}');
                        return;
                    }
                }

                AjaxSend("/support/reply/request", "POST", {
                    message: editorContent,
                    id: threadId,
                    screens: screens,
                }, true).then(function(response) {
                    // Проверяем успешность ответа
                    if (response && response.ok !== false) {
                        // Показываем уведомление об успехе, если есть сообщение
                        if (response.message) {
                            if (response.ok) {
                                // noticeSuccess(response.message);
                            } else {
                                noticeError(response.message);
                            }
                        }
                        
                        // Очищаем редактор
                        if (quillEditor) {
                            quillEditor.root.innerHTML = '<p><br></p>';
                        }
                        $('#screens').empty();
                        
                        // Обновляем сообщения через небольшую задержку
                        // Игнорируем response.reload, так как мы обновляем чат вручную
                        setTimeout(fetchNewMessages, 500);
                    } else if (response && response.ok === false) {
                        // Показываем ошибку
                        if (response.message) {
                            noticeError(response.message);
                        }
                    }
                }).catch(function(error) {
                    console.error('Ошибка при отправке сообщения:', error);
                    if (error && error.message) {
                        noticeError(error.message);
                    }
                });
            });
        }
        
        // Устанавливаем обработчик после загрузки страницы
        if (document.readyState === 'loading') {
            window.addEventListener('load', setupReplyHandler);
        } else {
            setupReplyHandler();
        }

    })();
</script>

{% endblock %}
